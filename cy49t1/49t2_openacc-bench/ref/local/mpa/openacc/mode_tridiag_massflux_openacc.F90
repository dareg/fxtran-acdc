
MODULE MODE_TRIDIAG_MASSFLUX_OPENACC


IMPLICIT NONE


CONTAINS
SUBROUTINE TRIDIAG_MASSFLUX_OPENACC (D, PVARM, PF, PDFDT&
&, PTSTEP, PIMPL, PDZZ, PRHODJ, PVARP, YDSTACK)
!$ACC ROUTINE (TRIDIAG_MASSFLUX_OPENACC) SEQ

USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODI_SHUMAN_MF_OPENACC,ONLY:MZM_MF_OPENACC
#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (DIMPHYEX_T), INTENT (IN)::D
REAL, INTENT (IN)::PVARM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PF(D%NIJT, D%NKT)
REAL, INTENT (IN)::PDFDT(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTSTEP
REAL, INTENT (IN)::PIMPL
REAL, INTENT (IN)::PDZZ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRHODJ(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PVARP(D%NIJT, D%NKT)
TYPE(STACK), INTENT (IN) :: YDSTACK
TYPE(STACK) :: YLSTACK
REAL::ZRHODJ_DFDT_O_DZ(D%NIJT, D%NKT)
REAL::ZMZM_RHODJ(D%NIJT, D%NKT)
REAL::ZC(D%NIJT, D%NKT)
REAL::ZB(D%NIJT, D%NKT)
REAL::ZA(D%NIJT, D%NKT)
REAL::ZGAM(D%NIJT, D%NKT)
REAL::ZY(D%NIJT, D%NKT)
REAL::ZBET(D%NIJT)
INTEGER::JIJ
INTEGER::JK
INTEGER::IIJE
INTEGER::IIJB
INTEGER::IKTE
INTEGER::IKTB
INTEGER::IKE
INTEGER::IKU
INTEGER::IKA
INTEGER::IKB
INTEGER::IKT
INTEGER::IKL

INTEGER (KIND=JPIM) :: JLON

YLSTACK = YDSTACK



JLON = KIDIA


IIJE=D%NIJE
IIJB=D%NIJB
IKT=D%NKT
IKB=D%NKB
IKL=D%NKL
IKA=D%NKA
IKU=D%NKU
IKE=D%NKE
IKTB=D%NKTB
IKTE=D%NKTE
CALL MZM_MF_OPENACC (D, PRHODJ, ZMZM_RHODJ, YDSTACK=YLSTACK)

DO JK=1, IKT

  DO JIJ=IIJB, IIJE
    ZRHODJ_DFDT_O_DZ (JIJ, JK)=ZMZM_RHODJ (JIJ, JK)*PDFDT (JIJ, JK)/PDZZ (JIJ, JK)
  ENDDO

ENDDO

ZA=0.
ZB=0.
ZC=0.
ZY=0.

DO JIJ=IIJB, IIJE
  ZY (JIJ, IKB)=PRHODJ (JIJ, IKB)*PVARM (JIJ, IKB)/PTSTEP-ZMZM_RHODJ (JIJ, IKB+IKL)*PF (JIJ, IKB+IKL)&
  &/PDZZ (JIJ, IKB+IKL)+ZMZM_RHODJ (JIJ, IKB)*PF (JIJ, IKB)/PDZZ (JIJ, IKB)+ZRHODJ_DFDT_O_DZ (JIJ, IKB&
  &+IKL)*0.5*PIMPL*PVARM (JIJ, IKB+IKL)+ZRHODJ_DFDT_O_DZ (JIJ, IKB+IKL)*0.5*PIMPL*PVARM (JIJ, IKB)
ENDDO


DO JK=1+IKTB, IKTE-1

  DO JIJ=IIJB, IIJE
    ZY (JIJ, JK)=PRHODJ (JIJ, JK)*PVARM (JIJ, JK)/PTSTEP-ZMZM_RHODJ (JIJ, JK+IKL)*PF (JIJ, JK+IKL)/PDZZ&
    & (JIJ, JK+IKL)+ZMZM_RHODJ (JIJ, JK)*PF (JIJ, JK)/PDZZ (JIJ, JK)+ZRHODJ_DFDT_O_DZ (JIJ, JK+IKL)*0.5&
    &*PIMPL*PVARM (JIJ, JK+IKL)+ZRHODJ_DFDT_O_DZ (JIJ, JK+IKL)*0.5*PIMPL*PVARM (JIJ, JK)-ZRHODJ_DFDT_O_DZ&
    & (JIJ, JK)*0.5*PIMPL*PVARM (JIJ, JK)-ZRHODJ_DFDT_O_DZ (JIJ, JK)*0.5*PIMPL*PVARM (JIJ, JK-IKL)
  ENDDO

ENDDO


IF (IKE==IKU) THEN

  DO JIJ=IIJB, IIJE
    ZY (JIJ, IKE)=PRHODJ (JIJ, IKE)*PVARM (JIJ, IKE)/PTSTEP
  ENDDO

ELSE

  DO JIJ=IIJB, IIJE
    ZY (JIJ, IKE)=PRHODJ (JIJ, IKE)*PVARM (JIJ, IKE)/PTSTEP-ZMZM_RHODJ (JIJ, IKE+IKL)*PF (JIJ, IKE+IKL&
    &)/PDZZ (JIJ, IKE+IKL)+ZMZM_RHODJ (JIJ, IKE)*PF (JIJ, IKE)/PDZZ (JIJ, IKE)-ZRHODJ_DFDT_O_DZ (JIJ,&
    & IKE)*0.5*PIMPL*PVARM (JIJ, IKE)-ZRHODJ_DFDT_O_DZ (JIJ, IKE)*0.5*PIMPL*PVARM (JIJ, IKE-IKL)
  ENDDO

ENDIF


IF (PIMPL>1.E-10) THEN

  DO JIJ=IIJB, IIJE
    ZB (JIJ, IKB)=PRHODJ (JIJ, IKB)/PTSTEP+ZRHODJ_DFDT_O_DZ (JIJ, IKB+IKL)*0.5*PIMPL
    ZC (JIJ, IKB)=ZRHODJ_DFDT_O_DZ (JIJ, IKB+IKL)*0.5*PIMPL
  ENDDO


  DO JK=1+IKTB, IKTE-1

    DO JIJ=IIJB, IIJE
      ZA (JIJ, JK)=-ZRHODJ_DFDT_O_DZ (JIJ, JK)*0.5*PIMPL
      ZB (JIJ, JK)=PRHODJ (JIJ, JK)/PTSTEP+ZRHODJ_DFDT_O_DZ (JIJ,&
      & JK+IKL)*0.5*PIMPL-ZRHODJ_DFDT_O_DZ (JIJ, JK)*0.5*PIMPL
      ZC (JIJ, JK)=ZRHODJ_DFDT_O_DZ (JIJ, JK+IKL)*0.5*PIMPL
    ENDDO

  ENDDO


  DO JIJ=IIJB, IIJE
    ZA (JIJ, IKE)=-ZRHODJ_DFDT_O_DZ (JIJ, IKE)*0.5*PIMPL
    ZB (JIJ, IKE)=PRHODJ (JIJ, IKE)/PTSTEP-ZRHODJ_DFDT_O_DZ (JIJ, IKE)*0.5*PIMPL
  ENDDO


  DO JIJ=IIJB, IIJE
    ZBET (JIJ)=ZB (JIJ, IKB)
    PVARP (JIJ, IKB)=ZY (JIJ, IKB)/ZBET (JIJ)
  ENDDO


  DO JK=IKB+IKL, IKE-IKL, IKL

    DO JIJ=IIJB, IIJE
      ZGAM (JIJ, JK)=ZC (JIJ, JK-IKL)/ZBET (JIJ)
      ZBET (JIJ)=ZB (JIJ, JK)-ZA (JIJ, JK)*ZGAM (JIJ, JK)
      PVARP (JIJ, JK)=(ZY (JIJ, JK)-ZA (JIJ, JK)*PVARP (JIJ, JK-IKL))/ZBET (JIJ)
    ENDDO

  ENDDO


  DO JIJ=IIJB, IIJE
    ZGAM (JIJ, IKE)=ZC (JIJ, IKE-IKL)/ZBET (JIJ)
    ZBET (JIJ)=ZB (JIJ, IKE)-ZA (JIJ, IKE)*ZGAM (JIJ, IKE)
    PVARP (JIJ, IKE)=(ZY (JIJ, IKE)-ZA (JIJ, IKE)*PVARP (JIJ, IKE-IKL))/ZBET (JIJ)
  ENDDO


  DO JK=IKE-IKL, IKB,-IKL

    DO JIJ=IIJB, IIJE
      PVARP (JIJ, JK)=PVARP (JIJ, JK)-ZGAM (JIJ, JK+IKL)*PVARP (JIJ, JK+IKL)
    ENDDO

  ENDDO

ELSE

  DO JK=IKTB, IKTE

    DO JIJ=IIJB, IIJE
      PVARP (JIJ, JK)=ZY (JIJ, JK)*PTSTEP/PRHODJ (JIJ, JK)
    ENDDO

  ENDDO

ENDIF


DO JIJ=IIJB, IIJE
  PVARP (JIJ, IKA)=PVARP (JIJ, IKB)
  PVARP (JIJ, IKU)=PVARP (JIJ, IKE)
ENDDO



ENDSUBROUTINE TRIDIAG_MASSFLUX_OPENACC

ENDMODULE MODE_TRIDIAG_MASSFLUX_OPENACC
