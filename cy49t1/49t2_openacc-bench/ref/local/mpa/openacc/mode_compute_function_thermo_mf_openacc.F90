
MODULE MODE_COMPUTE_FUNCTION_THERMO_MF_OPENACC


IMPLICIT NONE


CONTAINS
SUBROUTINE COMPUTE_FUNCTION_THERMO_MF_OPENACC (D, CST, KRR, KRRL, KRRI, OSTATNW&
&, PTH, PR, PEXN, PFRAC_ICE, PPABS, PT, PAMOIST, PATHETA, YDSTACK)
!$ACC ROUTINE (COMPUTE_FUNCTION_THERMO_MF_OPENACC) SEQ
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODD_CST,ONLY:CST_T

#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (DIMPHYEX_T), INTENT (IN)::D
TYPE (CST_T), INTENT (IN)::CST
LOGICAL, INTENT (IN)::OSTATNW
INTEGER, INTENT (IN)::KRR
INTEGER, INTENT (IN)::KRRL
INTEGER, INTENT (IN)::KRRI
REAL, INTENT (IN)::PTH(D%NIJT, D%NKT)
REAL, INTENT (IN)::PR(D%NIJT, D%NKT, KRR)
REAL, INTENT (IN)::PEXN(D%NIJT, D%NKT)
REAL, INTENT (IN)::PPABS(D%NIJT, D%NKT)
REAL, INTENT (IN)::PFRAC_ICE(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PT(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PATHETA(D%NIJT, D%NKT)
TYPE(STACK), INTENT (IN) :: YDSTACK
REAL, INTENT (OUT)::PAMOIST(D%NIJT, D%NKT)
REAL::ZEPS
REAL::ZLSOCP(D%NIJT, D%NKT)
REAL::ZLVOCP(D%NIJT, D%NKT)
REAL::ZATHETA_I(D%NIJT, D%NKT)
REAL::ZAMOIST_I(D%NIJT, D%NKT)
REAL::ZATHETA_W(D%NIJT, D%NKT)
REAL::ZAMOIST_W(D%NIJT, D%NKT)
REAL::ZDEDT(D%NIJT, D%NKT)
REAL::ZE(D%NIJT, D%NKT)
REAL::ZCP(D%NIJT, D%NKT)
INTEGER::JK
INTEGER::JIJ
INTEGER::JRR
INTEGER::IIJE
INTEGER::IIJB
INTEGER::IKTE
INTEGER::IKTB

INTEGER (KIND=JPIM) :: JLON

JLON = KIDIA


IIJE=D%NIJE
IIJB=D%NIJB
IKTB=D%NKTB
IKTE=D%NKTE
ZEPS=CST%XMV/CST%XMD
ZCP=CST%XCPD

IF (KRR>0) THEN

  DO JK=IKTB, IKTE

    DO JIJ=IIJB, IIJE
      ZCP (JIJ, JK)=ZCP (JIJ, JK)+CST%XCPV*PR (JIJ, JK, 1)
    ENDDO

  ENDDO

ENDIF


DO JRR=2, 1+KRRL

  DO JK=IKTB, IKTE

    DO JIJ=IIJB, IIJE
      ZCP (JIJ, JK)=ZCP (JIJ, JK)+CST%XCL*PR (JIJ, JK, JRR)
    ENDDO

  ENDDO

ENDDO


DO JRR=2+KRRL, 1+KRRL+KRRI

  DO JK=IKTB, IKTE

    DO JIJ=IIJB, IIJE
      ZCP (JIJ, JK)=ZCP (JIJ, JK)+CST%XCI*PR (JIJ, JK, JRR)
    ENDDO

  ENDDO

ENDDO


DO JK=IKTB, IKTE

  DO JIJ=IIJB, IIJE
    PT (JIJ, JK)=PTH (JIJ, JK)*PEXN (JIJ, JK)
  ENDDO

ENDDO


IF (KRRL>=1) THEN

  DO JK=IKTB, IKTE

    DO JIJ=IIJB, IIJE
      ZLVOCP (JIJ, JK)=(CST%XLVTT+(CST%XCPV-CST%XCL)*(PT (JIJ, JK)-CST%XTT))/ZCP (JIJ, JK)
      ZE (JIJ, JK)=EXP (CST%XALPW-CST%XBETAW/PT (JIJ, JK)-CST%XGAMW*ALOG (PT (JIJ, JK)))
      ZE (JIJ, JK)=ZE (JIJ, JK)*ZEPS/(PPABS (JIJ, JK)-ZE (JIJ, JK))
      ZDEDT (JIJ, JK)=(CST%XBETAW/PT (JIJ, JK)-CST%XGAMW)/PT (JIJ, JK)*ZE (JIJ, JK)*(1.+ZE (JIJ, JK)/ZEPS)

      IF (OSTATNW) THEN
        ZAMOIST_W (JIJ, JK)=1.0/(1.0+ZDEDT (JIJ, JK)*ZLVOCP (JIJ, JK))
        ZATHETA_W (JIJ, JK)=ZAMOIST_W (JIJ, JK)*PEXN (JIJ, JK)*ZDEDT (JIJ, JK)
      ELSE
        ZAMOIST_W (JIJ, JK)=0.5/(1.0+ZDEDT (JIJ, JK)*ZLVOCP (JIJ, JK))
        ZATHETA_W (JIJ, JK)=ZAMOIST_W (JIJ, JK)*PEXN (JIJ, JK)*((ZE (JIJ, JK)-PR (JIJ, JK, 1))*ZLVOCP&
        & (JIJ, JK)/(1.+ZDEDT (JIJ, JK)*ZLVOCP (JIJ, JK))*(ZE (JIJ, JK)*(1.+ZE (JIJ, JK)/ZEPS)*&
        &(-2.*CST%XBETAW/PT (JIJ, JK)+CST%XGAMW)/PT (JIJ, JK)**2+ZDEDT (JIJ, JK)*(1.+2.*ZE (JIJ&
        &, JK)/ZEPS)*(CST%XBETAW/PT (JIJ, JK)-CST%XGAMW)/PT (JIJ, JK))-ZDEDT (JIJ, JK))
      ENDIF

    ENDDO

  ENDDO


  IF (KRRI>=1) THEN

    DO JK=IKTB, IKTE

      DO JIJ=IIJB, IIJE
        ZLSOCP (JIJ, JK)=(CST%XLSTT+(CST%XCPV-CST%XCI)*(PT (JIJ, JK)-CST%XTT))/ZCP (JIJ, JK)
        ZE (JIJ, JK)=EXP (CST%XALPI-CST%XBETAI/PT (JIJ, JK)-CST%XGAMI*ALOG (PT (JIJ, JK)))
        ZE (JIJ, JK)=ZE (JIJ, JK)*ZEPS/(PPABS (JIJ, JK)-ZE (JIJ, JK))
        ZDEDT (JIJ, JK)=(CST%XBETAI/PT (JIJ, JK)-CST%XGAMI)/PT (JIJ, JK)*ZE (JIJ, JK)*(1.+ZE (JIJ, JK)/ZEPS)

        IF (OSTATNW) THEN
          ZAMOIST_I (JIJ, JK)=1.0/(1.0+ZDEDT (JIJ, JK)*ZLVOCP (JIJ, JK))
          ZATHETA_I (JIJ, JK)=ZAMOIST_I (JIJ, JK)*PEXN (JIJ, JK)*ZDEDT (JIJ, JK)
        ELSE
          ZAMOIST_I (JIJ, JK)=0.5/(1.0+ZDEDT (JIJ, JK)*ZLSOCP (JIJ, JK))
          ZATHETA_I (JIJ, JK)=ZAMOIST_I (JIJ, JK)*PEXN (JIJ, JK)*((ZE (JIJ, JK)-PR (JIJ, JK, 1))*ZLSOCP&
          & (JIJ, JK)/(1.+ZDEDT (JIJ, JK)*ZLSOCP (JIJ, JK))*(ZE (JIJ, JK)*(1.+ZE (JIJ, JK)/ZEPS)*&
          &(-2.*CST%XBETAI/PT (JIJ, JK)+CST%XGAMI)/PT (JIJ, JK)**2+ZDEDT (JIJ, JK)*(1.+2.*ZE (JIJ&
          &, JK)/ZEPS)*(CST%XBETAI/PT (JIJ, JK)-CST%XGAMI)/PT (JIJ, JK))-ZDEDT (JIJ, JK))
        ENDIF

      ENDDO

    ENDDO

  ELSE
    ZAMOIST_I (IIJB:IIJE, IKTB:IKTE)=0.
    ZATHETA_I (IIJB:IIJE, IKTB:IKTE)=0.
  ENDIF


  DO JK=IKTB, IKTE

    DO JIJ=IIJB, IIJE
      PAMOIST (JIJ, JK)=(1.0-PFRAC_ICE (JIJ, JK))*ZAMOIST_W&
      & (JIJ, JK)+PFRAC_ICE (JIJ, JK)*ZAMOIST_I (JIJ, JK)
      PATHETA (JIJ, JK)=(1.0-PFRAC_ICE (JIJ, JK))*ZATHETA_W&
      & (JIJ, JK)+PFRAC_ICE (JIJ, JK)*ZATHETA_I (JIJ, JK)
    ENDDO

  ENDDO

ELSE
  PAMOIST (IIJB:IIJE, IKTB:IKTE)=0.
  PATHETA (IIJB:IIJE, IKTB:IKTE)=0.
ENDIF



ENDSUBROUTINE COMPUTE_FUNCTION_THERMO_MF_OPENACC

ENDMODULE MODE_COMPUTE_FUNCTION_THERMO_MF_OPENACC
