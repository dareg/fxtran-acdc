
SUBROUTINE CONVECT_TRIGGER_SHAL_OPENACC (CVP_SHAL, CVPEXT, CST, D, PPRES, PTH, PTHV, PTHES, PRV, PW&
&, PZ, PTKECLS, PTHLCL, PTLCL, PRVLCL, PWLCL, PZLCL, PTHVELCL, KLCL, KDPL, KPBL, OTRIG, YDSTACK)
!$ACC ROUTINE (CONVECT_TRIGGER_SHAL_OPENACC) SEQ

USE MODD_CST,ONLY:CST_T
USE MODD_CONVPAR_SHAL,ONLY:CONVPAR_SHAL
USE MODD_CONVPAREXT,ONLY:CONVPAREXT
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (CONVPAR_SHAL), INTENT (IN)::CVP_SHAL
TYPE (CONVPAREXT), INTENT (IN)::CVPEXT
TYPE (CST_T), INTENT (IN)::CST
TYPE (DIMPHYEX_T), INTENT (IN)::D
REAL, INTENT (IN)::PTKECLS(D%NIT)
REAL, INTENT (IN)::PTHV(D%NIT, D%NKT)
REAL, INTENT (IN)::PTH(D%NIT, D%NKT)
REAL, INTENT (IN)::PTHES(D%NIT, D%NKT)
REAL, INTENT (IN)::PRV(D%NIT, D%NKT)
REAL, INTENT (IN)::PPRES(D%NIT, D%NKT)
REAL, INTENT (IN)::PZ(D%NIT, D%NKT)
REAL, INTENT (IN)::PW(D%NIT, D%NKT)
REAL, INTENT (OUT)::PTHLCL(D%NIT)
REAL, INTENT (OUT)::PTLCL(D%NIT)
REAL, INTENT (OUT)::PRVLCL(D%NIT)
REAL, INTENT (OUT)::PWLCL(D%NIT)
REAL, INTENT (OUT)::PZLCL(D%NIT)
REAL, INTENT (OUT)::PTHVELCL(D%NIT)
LOGICAL, INTENT (OUT)::OTRIG(D%NIT)
TYPE(STACK), INTENT (IN) :: YDSTACK
TYPE(STACK) :: YLSTACK
INTEGER, INTENT (INOUT)::KLCL(D%NIT)
INTEGER, INTENT (INOUT)::KDPL(D%NIT)
INTEGER, INTENT (INOUT)::KPBL(D%NIT)
INTEGER::JT
INTEGER::JL
INTEGER::JKM
INTEGER::JK
INTEGER::JKK
INTEGER::JI
INTEGER::IKE
INTEGER::IKB
REAL::ZEPSA
REAL::ZEPS
REAL::ZRDOCP
REAL::ZCPORD
REAL::ZX2
REAL::ZX1
REAL::ZTHVELCL(D%NIT)
REAL::ZZLCL(D%NIT)
REAL::ZWLCL(D%NIT)
REAL::ZRVLCL(D%NIT)
REAL::ZTLCL(D%NIT)
REAL::ZTHLCL(D%NIT)
INTEGER::ILCL(D%NIT)
INTEGER::IPBL(D%NIT)
INTEGER::IDPL(D%NIT)
REAL::ZPLCL(D%NIT)
REAL::ZZDPL(D%NIT)
REAL::ZTHVLCL(D%NIT)
REAL::ZTMIX(D%NIT)
REAL::ZEVMIX(D%NIT)
REAL::ZPRESMIX(D%NIT)
REAL::ZDPTHMIX(D%NIT)
REAL::ZCAPE(D%NIT)
REAL::ZCAP(D%NIT)
REAL::ZTHEUL(D%NIT)
REAL::ZCPHA(D%NIT)
REAL::ZLVA(D%NIT)
REAL::ZCPHB(D%NIT)
REAL::ZLVB(D%NIT)
REAL::ZEWB(D%NIT)
REAL::ZEWA(D%NIT)
REAL::ZLSB(D%NIT)
REAL::ZLSA(D%NIT)
REAL::ZDP(D%NIT)
REAL::ZTOPP(D%NIT)
REAL::ZTOP(D%NIT)
REAL::ZWORK3(D%NIT)
REAL::ZWORK2(D%NIT)
REAL::ZWORK1(D%NIT)
LOGICAL::GTRIG2(D%NIT)
LOGICAL::GWORK1(D%NIT)

INTEGER (KIND=JPIM) :: JLON

YLSTACK = YDSTACK



JLON = KIDIA


IKB=1+CVPEXT%JCVEXB
IKE=D%NKT-CVPEXT%JCVEXT
ZEPS=CST%XRD/CST%XRV
ZEPSA=CST%XRV/CST%XRD
ZCPORD=CST%XCPD/CST%XRD
ZRDOCP=CST%XRD/CST%XCPD
OTRIG (:)=.FALSE.
IDPL (:)=KDPL (:)
IPBL (:)=KPBL (:)
ILCL (:)=KLCL (:)
PWLCL (:)=0.
ZWLCL (:)=0.
PTHLCL (:)=1.
PTHVELCL (:)=1.
PTLCL (:)=1.
PRVLCL (:)=0.
PWLCL (:)=0.
PZLCL (:)=PZ (:, IKB)
ZZDPL (:)=PZ (:, IKB)
GTRIG2 (:)=.TRUE.
JT=IKE-2

DO JKK=IKB+1, IKE-2

  DO JI=D%NIB, D%NIE
    GWORK1 (JI)=ZZDPL (JI)-PZ (JI, IKB)<CVP_SHAL%XZLCL
  ENDDO


  DO JI=D%NIB, D%NIE

    IF (GWORK1 (JI)) THEN
      ZDPTHMIX (JI)=0.
      ZPRESMIX (JI)=0.
      ZTHLCL (JI)=0.
      ZRVLCL (JI)=0.
      ZZDPL (JI)=PZ (JI, JKK)
      IDPL (JI)=JKK
    ENDIF

  ENDDO


  DO JK=JKK, IKE-1
    JKM=JK+1

    DO JI=D%NIB, D%NIE

      IF (GWORK1 (JI).AND.ZDPTHMIX (JI)<CVP_SHAL%XZPBL) THEN
        IPBL (JI)=JK
        ZX1=PPRES (JI, JK)-PPRES (JI, JKM)
        ZDPTHMIX (JI)=ZDPTHMIX (JI)+ZX1
        ZPRESMIX (JI)=ZPRESMIX (JI)+PPRES (JI, JK)*ZX1
        ZTHLCL (JI)=ZTHLCL (JI)+PTH (JI, JK)*ZX1
        ZRVLCL (JI)=ZRVLCL (JI)+MAX (0., PRV (JI, JK))*ZX1
      ENDIF

    ENDDO

  ENDDO


  DO JI=D%NIB, D%NIE

    IF (GWORK1 (JI)) THEN
      ZPRESMIX (JI)=ZPRESMIX (JI)/ZDPTHMIX (JI)
      ZTHLCL (JI)=ZTHLCL (JI)/ZDPTHMIX (JI)+(CVP_SHAL%XATPERT*MIN (3.&
      &, PTKECLS (JI))/CST%XCPD+CVP_SHAL%XBTPERT)*CVP_SHAL%XDTPERT
      ZRVLCL (JI)=ZRVLCL (JI)/ZDPTHMIX (JI)
      ZTHVLCL (JI)=ZTHLCL (JI)*(1.+ZEPSA*ZRVLCL (JI))/(1.+ZRVLCL (JI))
      ZTMIX (JI)=ZTHLCL (JI)*(ZPRESMIX (JI)/CST%XP00)**ZRDOCP
      ZEVMIX (JI)=ZRVLCL (JI)*ZPRESMIX (JI)/(ZRVLCL (JI)+ZEPS)
      ZEVMIX (JI)=MAX (1.E-8, ZEVMIX (JI))
      ZX1=LOG (ZEVMIX (JI)/613.3)
      ZX1=(4780.8-32.19*ZX1)/(17.502-ZX1)
      ZTLCL (JI)=ZX1-(.212+1.571E-3*(ZX1-CST%XTT)-4.36E-4*(ZTMIX (JI)-CST%XTT))*(ZTMIX (JI)-ZX1)
      ZTLCL (JI)=MIN (ZTLCL (JI), ZTMIX (JI))
      ZPLCL (JI)=CST%XP00*(ZTLCL (JI)/ZTHLCL (JI))**ZCPORD
    ENDIF

  ENDDO


  DO JI=D%NIB, D%NIE
    CALL CONVECT_SATMIXRATIO_OPENACC (ZPLCL (JI), ZTLCL (JI), ZEPS, ZEWA&
    & (JI), ZLVA (JI), ZLSA (JI), ZCPHA (JI), YDSTACK=YLSTACK)
    CALL CONVECT_SATMIXRATIO_OPENACC (ZPRESMIX (JI), ZTMIX (JI), ZEPS,&
    & ZEWB (JI), ZLVB (JI), ZLSB (JI), ZCPHB (JI), YDSTACK=YLSTACK)
  ENDDO


  DO JI=D%NIB, D%NIE

    IF (GWORK1 (JI)) THEN
      ZLSA (JI)=ZEWA (JI)/ZTLCL (JI)*(CST%XBETAW/ZTLCL (JI)-CST%XGAMW)
      ZLSA (JI)=(ZEWA (JI)-ZRVLCL (JI))/(1.+ZLVA (JI)/ZCPHA (JI)*ZLSA (JI))
      ZTLCL (JI)=ZTLCL (JI)-ZLVA (JI)/ZCPHA (JI)*ZLSA (JI)
    ENDIF

  ENDDO


  DO JI=D%NIB, D%NIE

    IF (GWORK1 (JI).AND.ZRVLCL (JI)>ZEWB (JI)) THEN
      ZLSB (JI)=ZEWB (JI)/ZTMIX (JI)*(CST%XBETAW/ZTMIX (JI)-CST%XGAMW)
      ZLSB (JI)=(ZEWB (JI)-ZRVLCL (JI))/(1.+ZLVB (JI)/ZCPHB (JI)*ZLSB (JI))
      ZTLCL (JI)=ZTMIX (JI)-ZLVB (JI)/ZCPHB (JI)*ZLSB (JI)
      ZRVLCL (JI)=ZRVLCL (JI)-ZLSB (JI)
      ZPLCL (JI)=ZPRESMIX (JI)
      ZTHLCL (JI)=ZTLCL (JI)*(CST%XP00/ZPLCL (JI))**ZRDOCP
      ZTHVLCL (JI)=ZTHLCL (JI)*(1.+ZEPSA*ZRVLCL (JI))/(1.+ZRVLCL (JI))
    ENDIF

  ENDDO


  DO JK=JKK, IKE-1

    DO JI=D%NIB, D%NIE

      IF (ZPLCL (JI)<=PPRES (JI, JK).AND.GWORK1 (JI))  THEN
          ILCL (JI)=JK+1
      ENDIF

    ENDDO

  ENDDO


  DO JI=D%NIB, D%NIE
    JK=ILCL (JI)
    JKM=JK-1
    ZDP (JI)=LOG (ZPLCL (JI)/PPRES (JI, JKM))/LOG (PPRES (JI, JK)/PPRES (JI, JKM))
    ZWORK1 (JI)=PTHV (JI, JKM)+(PTHV (JI, JK)-PTHV (JI, JKM))*ZDP (JI)
    ZWORK2 (JI)=PZ (JI, JKM)+(PZ (JI, JK)-PZ (JI, JKM))*ZDP (JI)
  ENDDO


  DO JI=D%NIB, D%NIE

    IF (GWORK1 (JI)) THEN
      ZTHVELCL (JI)=ZWORK1 (JI)
      ZZLCL (JI)=ZWORK2 (JI)
    ENDIF

  ENDDO


  DO JI=D%NIB, D%NIE
    ZWLCL (JI)=CVP_SHAL%XAW*MAX (0., PW (JI, IKB))+CVP_SHAL%XBW
    ZTHEUL (JI)=ZTLCL (JI)*(ZTHLCL (JI)/ZTLCL (JI))**(1.-0.28*ZRVLCL (JI))*EXP&
    & ((3374.6525/ZTLCL (JI)-2.5403)*ZRVLCL (JI)*(1.+0.81*ZRVLCL (JI)))
  ENDDO

  ZCAPE (D%NIB:D%NIE)=0.
  ZCAP (D%NIB:D%NIE)=0.
  ZTOP (D%NIB:D%NIE)=0.
  ZTOPP (D%NIB:D%NIE)=0.
  ZWORK3 (D%NIB:D%NIE)=0.
  JKM=IKB

  DO JL=JKM, JT
    JK=JL+1

    DO JI=D%NIB, D%NIE
      ZX1=(2.*ZTHEUL (JI)/(PTHES (JI, JK)+PTHES (JI, JL))-1.)*(PZ (JI, JK)-PZ (JI, JL))

      IF (JL<ILCL (JI))  THEN
          ZX1=0.
      ENDIF

      ZCAPE (JI)=ZCAPE (JI)+CST%XG*MAX (1., ZX1)
      ZCAP (JI)=ZCAP (JI)+ZX1
      ZX2=SIGN (1.,(CVP_SHAL%XNHGAM*CST%XG*ZCAP (JI)+1.05*ZWLCL (JI)*ZWLCL (JI)))
      ZWORK3 (JI)=MAX (-1.,(ZWORK3 (JI)+MIN (0., ZX2)))
      ZTOPP (JI)=ZTOP (JI)
      ZTOP (JI)=PZ (JI, JL)*.5*(1.+ZX2)*(1.+ZWORK3 (JI))+ZTOP (JI)*.5*(1.-ZX2)
      ZTOP (JI)=MAX (ZTOP (JI), ZTOPP (JI))
      ZTOPP (JI)=ZTOP (JI)
    ENDDO

  ENDDO


  DO JI=D%NIB, D%NIE

    IF ((ZTOP (JI)-ZZLCL (JI)).GE.CVP_SHAL%XCDEPTH.AND.GTRIG2 (JI).AND.ZCAPE (JI)>10.) THEN
      GTRIG2 (JI)=.FALSE.
      OTRIG (JI)=.TRUE.
      PTHLCL (JI)=ZTHLCL (JI)
      PRVLCL (JI)=ZRVLCL (JI)
      PTLCL (JI)=ZTLCL (JI)
      PWLCL (JI)=ZWLCL (JI)
      PZLCL (JI)=ZZLCL (JI)
      PTHVELCL (JI)=ZTHVELCL (JI)
      KDPL (JI)=IDPL (JI)
      KPBL (JI)=IPBL (JI)
      KLCL (JI)=ILCL (JI)
    ENDIF

  ENDDO

ENDDO




INCLUDE"convect_satmixratio.h"
ENDSUBROUTINE CONVECT_TRIGGER_SHAL_OPENACC
