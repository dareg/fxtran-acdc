
SUBROUTINE CONVECT_CLOSURE_SHAL_OPENACC (CVP_SHAL, CVPEXT, CST, D, PPRES, PDPRES, PZ, PLMASS&
&, PTHL, PTH, PRW, PRC, PRI, OTRIG1, PTHC, PRWC, PRCC, PRIC, PWSUB, KLCL, KDPL, KPBL, KCTL&
&, PUMF, PUER, PUDR, PUTHL, PURW, PURC, PURI, PCAPE, PTIMEC, KFTSTEPS, YDSTACK)
!$ACC ROUTINE (CONVECT_CLOSURE_SHAL_OPENACC) SEQ

USE MODD_CST,ONLY:CST_T
USE MODD_CONVPAR_SHAL,ONLY:CONVPAR_SHAL
USE MODD_CONVPAREXT,ONLY:CONVPAREXT
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (CONVPAR_SHAL), INTENT (IN)::CVP_SHAL
TYPE (CONVPAREXT), INTENT (IN)::CVPEXT
TYPE (CST_T), INTENT (IN)::CST
TYPE (DIMPHYEX_T), INTENT (IN)::D
INTEGER, INTENT (IN)::KLCL(D%NIT)
INTEGER, INTENT (IN)::KCTL(D%NIT)
INTEGER, INTENT (IN)::KDPL(D%NIT)
INTEGER, INTENT (IN)::KPBL(D%NIT)
REAL, INTENT (INOUT)::PTIMEC(D%NIT)
REAL, INTENT (IN)::PTHL(D%NIT, D%NKT)
REAL, INTENT (IN)::PTH(D%NIT, D%NKT)
REAL, INTENT (IN)::PRW(D%NIT, D%NKT)
REAL, INTENT (IN)::PRC(D%NIT, D%NKT)
REAL, INTENT (IN)::PRI(D%NIT, D%NKT)
LOGICAL, INTENT (IN)::OTRIG1(D%NIT)
REAL, INTENT (IN)::PPRES(D%NIT, D%NKT)
REAL, INTENT (IN)::PDPRES(D%NIT, D%NKT)
REAL, INTENT (IN)::PLMASS(D%NIT, D%NKT)
REAL, INTENT (IN)::PZ(D%NIT, D%NKT)
REAL, INTENT (IN)::PCAPE(D%NIT)
INTEGER, INTENT (OUT)::KFTSTEPS
TYPE(STACK), INTENT (IN) :: YDSTACK
TYPE(STACK) :: YLSTACK
REAL, INTENT (INOUT)::PUMF(D%NIT, D%NKT)
REAL, INTENT (INOUT)::PUER(D%NIT, D%NKT)
REAL, INTENT (INOUT)::PUDR(D%NIT, D%NKT)
REAL, INTENT (IN)::PUTHL(D%NIT, D%NKT)
REAL, INTENT (IN)::PURW(D%NIT, D%NKT)
REAL, INTENT (IN)::PURC(D%NIT, D%NKT)
REAL, INTENT (IN)::PURI(D%NIT, D%NKT)
REAL, INTENT (OUT)::PTHC(D%NIT, D%NKT)
REAL, INTENT (OUT)::PRWC(D%NIT, D%NKT)
REAL, INTENT (OUT)::PRCC(D%NIT, D%NKT)
REAL, INTENT (OUT)::PRIC(D%NIT, D%NKT)
REAL, INTENT (OUT)::PWSUB(D%NIT, D%NKT)
INTEGER::IKE
INTEGER::IKB
INTEGER::IKS
INTEGER::JKMAX
INTEGER::JKP
INTEGER::JK
INTEGER::JI
INTEGER::JITER
INTEGER::JSTEP
REAL::ZRDOCP
REAL::ZCPORD
REAL::ZEPS
REAL::ZTHLC(D%NIT, D%NKT)
REAL::ZOMG(D%NIT, D%NKT)
REAL::ZUMF(D%NIT, D%NKT)
REAL::ZUER(D%NIT, D%NKT)
REAL::ZUDR(D%NIT, D%NKT)
REAL::ZADJ(D%NIT)
REAL::ZADJMAX(D%NIT)
REAL::ZCAPE(D%NIT)
REAL::ZTIMEC(D%NIT)
REAL::ZTIMC(D%NIT, D%NKT)
REAL::ZTHLCL(D%NIT)
REAL::ZRVLCL(D%NIT)
REAL::ZZLCL(D%NIT)
REAL::ZTLCL(D%NIT)
REAL::ZTELCL(D%NIT)
REAL::ZTHEUL(D%NIT)
REAL::ZTHES2(D%NIT)
REAL::ZTHES1(D%NIT)
REAL::ZRWMFOUT(D%NIT, D%NKT)
REAL::ZRWMFIN(D%NIT, D%NKT)
REAL::ZTHMFOUT(D%NIT, D%NKT)
REAL::ZTHMFIN(D%NIT, D%NKT)
REAL::ZRIMFOUT(D%NIT, D%NKT)
REAL::ZRIMFIN(D%NIT, D%NKT)
REAL::ZRCMFOUT(D%NIT, D%NKT)
REAL::ZRCMFIN(D%NIT, D%NKT)
REAL::ZPI(D%NIT)
REAL::ZLV(D%NIT)
REAL::ZLS(D%NIT)
REAL::ZCPH(D%NIT)
INTEGER::ITSTEP(D%NIT)
INTEGER::ICOUNT(D%NIT)
INTEGER::ILCL(D%NIT)
INTEGER::IWORK1(D%NIT)
REAL::ZWORK5(D%NIT)
REAL::ZWORK3(D%NIT)
REAL::ZWORK2(D%NIT)
REAL::ZWORK1(D%NIT)
LOGICAL::GWORK3(D%NIT)
LOGICAL::GWORK1(D%NIT)
LOGICAL::GWORK4(D%NIT, D%NKT)

#include "convect_closure_adjust_shal_openacc.h"
#include "convect_closure_thrvlcl_openacc.h"
INTEGER (KIND=JPIM) :: JLON

YLSTACK = YDSTACK



JLON = KIDIA


ZTIMC (:,:)=0.
ZTHES2 (:)=0.
ZWORK1 (:)=0.
ZWORK2 (:)=0.
ZWORK3 (:)=0.
GWORK1 (:)=.FALSE.
GWORK3 (:)=.FALSE.
GWORK4 (:,:)=.FALSE.
ILCL (:)=KLCL (:)
ZEPS=CST%XRD/CST%XRV
ZCPORD=CST%XCPD/CST%XRD
ZRDOCP=CST%XRD/CST%XCPD
ZADJ (:)=1.
ZWORK5 (:)=1.

DO JI=D%NIB, D%NIE

  IF (.NOT.OTRIG1 (JI))  THEN
      ZWORK5=0
  ENDIF

ENDDO

IKB=1+CVPEXT%JCVEXB
IKS=D%NKT
IKE=D%NKT-CVPEXT%JCVEXT
JKMAX=IKE
ZUMF (:,:)=PUMF (:,:)
ZUER (:,:)=PUER (:,:)
ZUDR (:,:)=PUDR (:,:)
ZOMG (:,:)=0.
PWSUB (:,:)=0.
ZADJMAX (:)=1000.
IWORK1 (:)=ILCL (:)
JKP=IKB

DO JK=JKP, IKE

  DO JI=D%NIB, D%NIE

    IF (JK>KDPL (JI)) THEN

      IF (JK<=IWORK1 (JI)) THEN
        ZWORK1 (JI)=PLMASS (JI, JK)/((PUER (JI, JK)+1.E-5)*PTIMEC (JI))
        ZADJMAX (JI)=MIN (ZADJMAX (JI), ZWORK1 (JI))
      ENDIF

    ENDIF

  ENDDO

ENDDO

GWORK1 (:)=OTRIG1 (:)

DO JK=IKB, IKE

  DO JI=D%NIB, D%NIE
    ZTHLC (JI, JK)=PTHL (JI, JK)
    PRWC (JI, JK)=PRW (JI, JK)
    PRCC (JI, JK)=MAX (0., PRC (JI, JK))
    PRIC (JI, JK)=MAX (0., PRI (JI, JK))
    PTHC (JI, JK)=PTH (JI, JK)
  ENDDO

ENDDO


DO JITER=1, 4
  ZTIMEC (:)=PTIMEC (:)

  DO JK=1, IKS
    GWORK4 (1:D%NIE, JK)=GWORK1 (1:D%NIE)
  ENDDO


  DO JK=IKB, IKE

    DO JI=D%NIB, D%NIE

      IF (GWORK4 (JI, JK))  THEN
          PWSUB (JI, JK)=0.
      ENDIF

    ENDDO

  ENDDO

  ZOMG (:, 1:D%NKT)=0.

  DO JK=IKB+1, JKMAX
    JKP=MAX (IKB+1, JK-1)

    DO JI=D%NIB, D%NIE

      IF (GWORK1 (JI).AND.JK<=KCTL (JI)) THEN
        ZWORK1 (JI)=-(PUER (JI, JKP)-PUDR (JI, JKP))/PLMASS (JI, JKP)
        PWSUB (JI, JK)=PWSUB (JI, JKP)-PDPRES (JI, JK-1)*ZWORK1 (JI)
        ZWORK1 (JI)=CVP_SHAL%XSTABT*PDPRES (JI, JKP)/(ABS (PWSUB (JI, JK))+1.E-10)
        ZTIMEC (JI)=MIN (ZTIMEC (JI), ZWORK1 (JI))
        ZOMG (JI, JK)=PWSUB (JI, JK)*CVP_SHAL%XA25/CST%XG
      ENDIF

    ENDDO

  ENDDO


  DO JK=IKB, IKE

    DO JI=D%NIB, D%NIE

      IF (GWORK4 (JI, JK)) THEN
        ZTHLC (JI, JK)=PTHL (JI, JK)
        PRWC (JI, JK)=PRW (JI, JK)
        PRCC (JI, JK)=MAX (0., PRC (JI, JK))
        PRIC (JI, JK)=MAX (0., PRI (JI, JK))
        PTHC (JI, JK)=PTH (JI, JK)
      ENDIF

    ENDDO

  ENDDO


  DO JI=D%NIB, D%NIE
    JK=KCTL (JI)
    ZWORK1 (JI)=PUDR (JI, JK)*PDPRES (JI, JK)/(PLMASS (JI, JK)+.1)-PWSUB (JI, JK)
  ENDDO


  DO JI=D%NIB, D%NIE

    IF (GWORK1 (JI).AND.ABS (ZWORK1 (JI))-.01>0.) THEN
      GWORK1 (JI)=.FALSE.
      PTIMEC (JI)=1.E-1
      ZWORK5 (JI)=0.
    ENDIF

  ENDDO


  DO JK=IKB, IKE
    PWSUB (:, JK)=PWSUB (:, JK)*ZWORK5 (:)
  ENDDO

  GWORK4 (:, 1:IKB)=.FALSE.
  GWORK4 (:, IKE:IKS)=.FALSE.

  DO JI=D%NIB, D%NIE
    ITSTEP (JI)=INT (PTIMEC (JI)/ZTIMEC (JI))+1
    ZTIMEC (JI)=PTIMEC (JI)/REAL (ITSTEP (JI))
  ENDDO


  DO JK=1, IKS
    ZTIMC (1:D%NIE, JK)=ZTIMEC (1:D%NIE)
  ENDDO

  ICOUNT (:)=0
  KFTSTEPS=0

  DO JI=D%NIB, D%NIE
    KFTSTEPS=MAX (KFTSTEPS, ITSTEP (JI))
  ENDDO


  DO JSTEP=1, KFTSTEPS

    DO JI=D%NIB, D%NIE
      ICOUNT (JI)=ICOUNT (JI)+1
      GWORK3 (JI)=ITSTEP (JI)>=ICOUNT (JI).AND.GWORK1 (JI)
    ENDDO


    DO JK=1, D%NKT
      ZTHMFIN (:, JK)=0.
      ZRWMFIN (:, JK)=0.
      ZRCMFIN (:, JK)=0.
      ZRIMFIN (:, JK)=0.
      ZTHMFOUT (:, JK)=0.
      ZRWMFOUT (:, JK)=0.
      ZRCMFOUT (:, JK)=0.
      ZRIMFOUT (:, JK)=0.
    ENDDO


    DO JK=IKB+1, JKMAX

      DO JI=D%NIB, D%NIE
        GWORK4 (JI, JK)=GWORK3 (JI).AND.JK<=KCTL (JI)
      ENDDO

      JKP=MAX (IKB+1, JK-1)

      DO JI=D%NIB, D%NIE

        IF (GWORK3 (JI)) THEN
          ZWORK1 (JI)=SIGN (1., ZOMG (JI, JK))
          ZWORK2 (JI)=0.5*(1.+ZWORK1 (JI))
          ZWORK1 (JI)=0.5*(1.-ZWORK1 (JI))
          ZTHMFIN (JI, JK)=-ZOMG (JI, JK)*ZTHLC (JI, JKP)*ZWORK1 (JI)
          ZTHMFOUT (JI, JK)=ZOMG (JI, JK)*ZTHLC (JI, JK)*ZWORK2 (JI)
          ZRWMFIN (JI, JK)=-ZOMG (JI, JK)*PRWC (JI, JKP)*ZWORK1 (JI)
          ZRWMFOUT (JI, JK)=ZOMG (JI, JK)*PRWC (JI, JK)*ZWORK2 (JI)
          ZRCMFIN (JI, JK)=-ZOMG (JI, JK)*PRCC (JI, JKP)*ZWORK1 (JI)
          ZRCMFOUT (JI, JK)=ZOMG (JI, JK)*PRCC (JI, JK)*ZWORK2 (JI)
          ZRIMFIN (JI, JK)=-ZOMG (JI, JK)*PRIC (JI, JKP)*ZWORK1 (JI)
          ZRIMFOUT (JI, JK)=ZOMG (JI, JK)*PRIC (JI, JK)*ZWORK2 (JI)
        ENDIF

      ENDDO


      DO JI=D%NIB, D%NIE

        IF (GWORK3 (JI)) THEN
          ZTHMFIN (JI, JKP)=ZTHMFIN (JI, JKP)+ZTHMFOUT (JI, JK)*ZWORK2 (JI)
          ZTHMFOUT (JI, JKP)=ZTHMFOUT (JI, JKP)+ZTHMFIN (JI, JK)*ZWORK1 (JI)
          ZRWMFIN (JI, JKP)=ZRWMFIN (JI, JKP)+ZRWMFOUT (JI, JK)*ZWORK2 (JI)
          ZRWMFOUT (JI, JKP)=ZRWMFOUT (JI, JKP)+ZRWMFIN (JI, JK)*ZWORK1 (JI)
          ZRCMFIN (JI, JKP)=ZRCMFIN (JI, JKP)+ZRCMFOUT (JI, JK)*ZWORK2 (JI)
          ZRCMFOUT (JI, JKP)=ZRCMFOUT (JI, JKP)+ZRCMFIN (JI, JK)*ZWORK1 (JI)
          ZRIMFIN (JI, JKP)=ZRIMFIN (JI, JKP)+ZRIMFOUT (JI, JK)*ZWORK2 (JI)
          ZRIMFOUT (JI, JKP)=ZRIMFOUT (JI, JKP)+ZRIMFIN (JI, JK)*ZWORK1 (JI)
        ENDIF

      ENDDO

    ENDDO


    DO JK=IKB, IKE

      DO JI=D%NIB, D%NIE

        IF (GWORK4 (JI, JK)) THEN
          ZTHLC (JI, JK)=ZTHLC (JI, JK)+ZTIMC (JI, JK)/PLMASS (JI, JK)*(ZTHMFIN (JI, JK)+PUDR&
          & (JI, JK)*PUTHL (JI, JK)-ZTHMFOUT (JI, JK)-PUER (JI, JK)*PTHL (JI, JK))
          PRWC (JI, JK)=PRWC (JI, JK)+ZTIMC (JI, JK)/PLMASS (JI, JK)*(ZRWMFIN (JI, JK)+PUDR&
          & (JI, JK)*PURW (JI, JK)-ZRWMFOUT (JI, JK)-PUER (JI, JK)*PRW (JI, JK))
          PRCC (JI, JK)=PRCC (JI, JK)+ZTIMC (JI, JK)/PLMASS (JI, JK)*(ZRCMFIN (JI, JK)+PUDR &
          &(JI, JK)*PURC (JI, JK)-ZRCMFOUT (JI, JK)-PUER (JI, JK)*MAX (0., PRC (JI, JK)))
          PRIC (JI, JK)=PRIC (JI, JK)+ZTIMC (JI, JK)/PLMASS (JI, JK)*(ZRIMFIN (JI, JK)+PUDR &
          &(JI, JK)*PURI (JI, JK)-ZRIMFOUT (JI, JK)-PUER (JI, JK)*MAX (0., PRI (JI, JK)))
        ENDIF

      ENDDO

    ENDDO

  ENDDO


  DO JK=IKB+1, JKMAX

    DO JI=D%NIB, D%NIE

      IF (GWORK1 (JI).AND.JK<=KCTL (JI)) THEN
        ZPI (JI)=(CST%XP00/PPRES (JI, JK))**ZRDOCP
        ZCPH (JI)=CST%XCPD+PRWC (JI, JK)*CST%XCPV
        ZWORK2 (JI)=PTH (JI, JK)/ZPI (JI)
        ZLV (JI)=CST%XLVTT+(CST%XCPV-CST%XCL)*(ZWORK2 (JI)-CST%XTT)
        ZLS (JI)=CST%XLVTT+(CST%XCPV-CST%XCI)*(ZWORK2 (JI)-CST%XTT)
        ZWORK2 (JI)=(ZTHLC (JI, JK)+ZLV (JI)*PRCC (JI, JK)+ZLS (JI)*PRIC&
        & (JI, JK)-(1.+PRWC (JI, JK))*CST%XG*PZ (JI, JK))/ZCPH (JI)
        ZWORK2 (JI)=MAX (180., MIN (340., ZWORK2 (JI)))
        PTHC (JI, JK)=ZWORK2 (JI)*ZPI (JI)
      ENDIF

    ENDDO

  ENDDO

  CALL CONVECT_CLOSURE_THRVLCL_OPENACC (CVPEXT, CST, D, PPRES, PTHC, PRWC, PZ, GWORK1&
  &, ZTHLCL, ZRVLCL, ZZLCL, ZTLCL, ZTELCL, ILCL, KDPL, KPBL, YDSTACK=YLSTACK)

  DO JI=D%NIB, D%NIE
    ZTLCL (JI)=MAX (230., MIN (335., ZTLCL (JI)))
    ZTELCL (JI)=MAX (230., MIN (335., ZTELCL (JI)))
    ZTHLCL (JI)=MAX (230., MIN (345., ZTHLCL (JI)))
    ZRVLCL (JI)=MAX (0., MIN (1., ZRVLCL (JI)))
    ZCAPE (JI)=0.
    ZPI (JI)=MAX (0.95, MIN (1.5, ZTHLCL (JI)/ZTLCL (JI)))
    ZWORK1 (JI)=CST%XP00/ZPI (JI)**ZCPORD
    CALL CONVECT_SATMIXRATIO_OPENACC (ZWORK1 (JI), ZTELCL (JI), ZEPS,&
    & ZWORK3 (JI), ZLV (JI), ZLS (JI), ZCPH (JI), YDSTACK=YLSTACK)
    ZWORK3 (JI)=MIN (.1, MAX (0., ZWORK3 (JI)))
    ZTHEUL (JI)=ZTLCL (JI)*ZPI (JI)**(1.-0.28*ZRVLCL (JI))*EXP ((3374&
    &.6525/ZTLCL (JI)-2.5403)*ZRVLCL (JI)*(1.+0.81*ZRVLCL (JI)))
    ZTHES1 (JI)=ZTELCL (JI)*ZPI (JI)**(1.-0.28*ZWORK3 (JI))*EXP ((3374&
    &.6525/ZTELCL (JI)-2.5403)*ZWORK3 (JI)*(1.+0.81*ZWORK3 (JI)))
  ENDDO


  DO JK=IKB, JKMAX
    JKP=JK-1

    DO JI=D%NIB, D%NIE
      GWORK3 (JI)=JK>=ILCL (JI).AND.JK<=KCTL (JI).AND.GWORK1 (JI)
      ZPI (JI)=(CST%XP00/PPRES (JI, JK))**ZRDOCP
      ZWORK2 (JI)=PTHC (JI, JK)/ZPI (JI)
      CALL CONVECT_SATMIXRATIO_OPENACC (PPRES (JI, JK), ZWORK2 (JI), ZEPS&
      &, ZWORK3 (JI), ZLV (JI), ZLS (JI), ZCPH (JI), YDSTACK=YLSTACK)
    ENDDO


    DO JI=D%NIB, D%NIE

      IF (GWORK3 (JI)) THEN
        ZTHES2 (JI)=ZWORK2 (JI)*ZPI (JI)**(1.-0.28*ZWORK3 (JI))*EXP ((3374&
        &.6525/ZWORK2 (JI)-2.5403)*ZWORK3 (JI)*(1.+0.81*ZWORK3 (JI)))

        IF (JK==ILCL (JI)) THEN
          ZWORK3 (JI)=PZ (JI, JK)-ZZLCL (JI)
        ELSE
          ZWORK3 (JI)=PZ (JI, JK)-PZ (JI, JKP)
        ENDIF

        ZWORK1 (JI)=(2.*ZTHEUL (JI))/(ZTHES1 (JI)+ZTHES2 (JI))-1.
        ZCAPE (JI)=ZCAPE (JI)+CST%XG*ZWORK3 (JI)*MAX (0., ZWORK1 (JI))
        ZTHES1 (JI)=ZTHES2 (JI)
      ENDIF

    ENDDO

  ENDDO


  DO JI=D%NIB, D%NIE

    IF (GWORK1 (JI)) THEN
      ZWORK1 (JI)=MAX (PCAPE (JI)-ZCAPE (JI), 0.2*PCAPE (JI))
      ZWORK2 (JI)=ZCAPE (JI)/(PCAPE (JI)+1.E-8)
      GWORK1 (JI)=ZWORK2 (JI)>0.2.OR.ZCAPE (JI)==0.
    ENDIF

  ENDDO


  DO JI=D%NIB, D%NIE

    IF (ZCAPE (JI)==0..AND.GWORK1 (JI)) THEN
      ZADJ (JI)=ZADJ (JI)*0.5
    ENDIF

  ENDDO


  DO JI=D%NIB, D%NIE

    IF (ZCAPE (JI)/=0..AND.GWORK1 (JI)) THEN
      ZADJ (JI)=ZADJ (JI)*CVP_SHAL%XSTABC*PCAPE (JI)/(ZWORK1 (JI)+1.E-8)
    ENDIF

  ENDDO


  DO JI=D%NIB, D%NIE
    ZADJ (JI)=MIN (ZADJ (JI), ZADJMAX (JI))
  ENDDO

  CALL CONVECT_CLOSURE_ADJUST_SHAL_OPENACC (CVPEXT, D, ZADJ&
  &, PUMF, ZUMF, PUER, ZUER, PUDR, ZUDR, YDSTACK=YLSTACK)
ENDDO


DO JK=IKB, IKE

  DO JI=D%NIB, D%NIE
    PRWC (JI, JK)=MAX (0., PRWC (JI, JK)-PRCC (JI, JK)-PRIC (JI, JK))
  ENDDO

ENDDO




INCLUDE"convect_satmixratio.h"
ENDSUBROUTINE CONVECT_CLOSURE_SHAL_OPENACC
