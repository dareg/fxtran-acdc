
MODULE MODE_MF_TURB_OPENACC


IMPLICIT NONE


CONTAINS
SUBROUTINE MF_TURB_OPENACC (D, KSV, OMIXUV, ONOMIXLG, KSV_LGBEG, KSV_LGEND, PIMPL&
&, PTSTEP, PDZZ, PRHODJ, PTHLM, PTHVM, PRTM, PUM, PVM, PSVM, PTHLDT, PRTDT, PUDT&
&, PVDT, PSVDT, PEMF, PTHL_UP, PTHV_UP, PRT_UP, PU_UP, PV_UP, PSV_UP, PFLXZTHMF&
&, PFLXZTHVMF, PFLXZRMF, PFLXZUMF, PFLXZVMF, PFLXZSVMF, YDSTACK)
!$ACC ROUTINE (MF_TURB_OPENACC) SEQ
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODI_SHUMAN_MF_OPENACC,ONLY:MZM_MF_OPENACC
USE MODE_TRIDIAG_MASSFLUX_OPENACC,ONLY:TRIDIAG_MASSFLUX_OPENACC

#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (DIMPHYEX_T), INTENT (IN)::D
INTEGER, INTENT (IN)::KSV
LOGICAL, INTENT (IN)::OMIXUV
LOGICAL, INTENT (IN)::ONOMIXLG
INTEGER, INTENT (IN)::KSV_LGBEG
INTEGER, INTENT (IN)::KSV_LGEND
REAL, INTENT (IN)::PIMPL
REAL, INTENT (IN)::PTSTEP
REAL, INTENT (IN)::PDZZ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRHODJ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHLM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRTM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHVM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PUM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PVM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PSVM(D%NIJT, D%NKT, KSV)
REAL, INTENT (OUT)::PTHLDT(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PRTDT(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PUDT(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PVDT(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PSVDT(D%NIJT, D%NKT, KSV)
REAL, INTENT (IN)::PV_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PU_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRT_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHV_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHL_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PEMF(D%NIJT, D%NKT)
REAL, INTENT (IN)::PSV_UP(D%NIJT, D%NKT, KSV)
REAL, INTENT (OUT)::PFLXZVMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZUMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZRMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZTHVMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZTHMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZSVMF(D%NIJT, D%NKT, KSV)
TYPE(STACK), INTENT (IN) :: YDSTACK
TYPE(STACK) :: YLSTACK
REAL::ZEMFO(D%NIJT, D%NKT)
REAL::ZVARS(D%NIJT, D%NKT)
INTEGER::JSV
INTEGER::JK
INTEGER::JIJ
INTEGER::IIJE
INTEGER::IIJB
INTEGER::IKT

INTEGER (KIND=JPIM) :: JLON

YLSTACK = YDSTACK



JLON = KIDIA


IIJE=D%NIJE
IIJB=D%NIJB
IKT=D%NKT
PFLXZSVMF=0.
PSVDT=0.
ZEMFO=-PEMF
CALL MZM_MF_OPENACC (D, PTHLM (:,:), PFLXZTHMF (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PRTM (:,:), PFLXZRMF (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PTHVM (:,:), PFLXZTHVMF (:,:), YDSTACK=YLSTACK)

DO JK=1, IKT

  DO JIJ=IIJB, IIJE
    PFLXZTHMF (JIJ, JK)=PEMF (JIJ, JK)*(PTHL_UP (JIJ, JK)-PFLXZTHMF (JIJ, JK))
    PFLXZRMF (JIJ, JK)=PEMF (JIJ, JK)*(PRT_UP (JIJ, JK)-PFLXZRMF (JIJ, JK))
    PFLXZTHVMF (JIJ, JK)=PEMF (JIJ, JK)*(PTHV_UP (JIJ, JK)-PFLXZTHVMF (JIJ, JK))
  ENDDO

ENDDO


IF (OMIXUV) THEN
  CALL MZM_MF_OPENACC (D, PUM (:,:), PFLXZUMF (:,:), YDSTACK=YLSTACK)
  CALL MZM_MF_OPENACC (D, PVM (:,:), PFLXZVMF (:,:), YDSTACK=YLSTACK)

  DO JK=1, IKT

    DO JIJ=IIJB, IIJE
      PFLXZUMF (JIJ, JK)=PEMF (JIJ, JK)*(PU_UP (JIJ, JK)-PFLXZUMF (JIJ, JK))
      PFLXZVMF (JIJ, JK)=PEMF (JIJ, JK)*(PV_UP (JIJ, JK)-PFLXZVMF (JIJ, JK))
    ENDDO

  ENDDO

ELSE
  PFLXZUMF (:,:)=0.
  PFLXZVMF (:,:)=0.
ENDIF

CALL TRIDIAG_MASSFLUX_OPENACC (D, PTHLM, PFLXZTHMF, ZEMFO&
&, PTSTEP, PIMPL, PDZZ, PRHODJ, ZVARS, YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, ZVARS (:,:), PFLXZTHMF (:,:), YDSTACK=YLSTACK)

DO JK=1, IKT

  DO JIJ=IIJB, IIJE
    PFLXZTHMF (JIJ, JK)=PEMF (JIJ, JK)*(PTHL_UP (JIJ, JK)-PFLXZTHMF (JIJ, JK))
    PTHLDT (JIJ, JK)=(ZVARS (JIJ, JK)-PTHLM (JIJ, JK))/PTSTEP
  ENDDO

ENDDO

CALL TRIDIAG_MASSFLUX_OPENACC (D, PRTM (:,:), PFLXZRMF, ZEMFO&
&, PTSTEP, PIMPL, PDZZ, PRHODJ, ZVARS, YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, ZVARS (:,:), PFLXZRMF (:,:), YDSTACK=YLSTACK)

DO JK=1, IKT

  DO JIJ=IIJB, IIJE
    PFLXZRMF (JIJ, JK)=PEMF (JIJ, JK)*(PRT_UP (JIJ, JK)-PFLXZRMF (JIJ, JK))
    PRTDT (JIJ, JK)=(ZVARS (JIJ, JK)-PRTM (JIJ, JK))/PTSTEP
  ENDDO

ENDDO


IF (OMIXUV) THEN
  CALL TRIDIAG_MASSFLUX_OPENACC (D, PUM, PFLXZUMF, ZEMFO, PTSTEP&
  &, PIMPL, PDZZ, PRHODJ, ZVARS, YDSTACK=YLSTACK)
  CALL MZM_MF_OPENACC (D, ZVARS (:,:), PFLXZUMF (:,:), YDSTACK=YLSTACK)

  DO JK=1, IKT

    DO JIJ=IIJB, IIJE
      PFLXZUMF (JIJ, JK)=PEMF (JIJ, JK)*(PU_UP (JIJ, JK)-PFLXZUMF (JIJ, JK))
      PUDT (JIJ, JK)=(ZVARS (JIJ, JK)-PUM (JIJ, JK))/PTSTEP
    ENDDO

  ENDDO

  CALL TRIDIAG_MASSFLUX_OPENACC (D, PVM, PFLXZVMF, ZEMFO, PTSTEP&
  &, PIMPL, PDZZ, PRHODJ, ZVARS, YDSTACK=YLSTACK)
  CALL MZM_MF_OPENACC (D, ZVARS (:,:), PFLXZVMF (:,:), YDSTACK=YLSTACK)

  DO JK=1, IKT

    DO JIJ=IIJB, IIJE
      PFLXZVMF (JIJ, JK)=PEMF (JIJ, JK)*(PV_UP (JIJ, JK)-PFLXZVMF (JIJ, JK))
      PVDT (JIJ, JK)=(ZVARS (JIJ, JK)-PVM (JIJ, JK))/PTSTEP
    ENDDO

  ENDDO

ELSE
  PUDT (:,:)=0.
  PVDT (:,:)=0.
ENDIF


DO JSV=1, KSV

  IF (ONOMIXLG.AND.JSV>=KSV_LGBEG.AND.JSV<=KSV_LGEND)  THEN
      CYCLE
  ENDIF

  CALL MZM_MF_OPENACC (D, PSVM (:,:, JSV), PFLXZSVMF (:,:, JSV), YDSTACK=YLSTACK)

  DO JK=1, IKT

    DO JIJ=IIJB, IIJE
      PFLXZSVMF (JIJ, JK, JSV)=PEMF (JIJ, JK)*(PSV_UP (JIJ, JK, JSV)-PFLXZSVMF (JIJ, JK, JSV))
    ENDDO

  ENDDO

  CALL TRIDIAG_MASSFLUX_OPENACC (D, PSVM (:,:, JSV), PFLXZSVMF (:,:, JSV&
  &), ZEMFO, PTSTEP, PIMPL, PDZZ, PRHODJ, ZVARS, YDSTACK=YLSTACK)
  CALL MZM_MF_OPENACC (D, ZVARS, PFLXZSVMF (:,:, JSV), YDSTACK=YLSTACK)

  DO JK=1, IKT

    DO JIJ=IIJB, IIJE
      PFLXZSVMF (JIJ, JK, JSV)=PEMF (JIJ, JK)*(PSV_UP (JIJ, JK, JSV)-PFLXZSVMF (JIJ, JK, JSV))
      PSVDT (JIJ, JK, JSV)=(ZVARS (JIJ, JK)-PSVM (JIJ, JK, JSV))/PTSTEP
    ENDDO

  ENDDO

ENDDO



ENDSUBROUTINE MF_TURB_OPENACC

ENDMODULE MODE_MF_TURB_OPENACC
