
SUBROUTINE CONVECT_CLOSURE_THRVLCL_OPENACC (CVPEXT, CST, D, PPRES, PTH, PRV, PZ&
&, OWORK1, PTHLCL, PRVLCL, PZLCL, PTLCL, PTELCL, KLCL, KDPL, KPBL, YDSTACK)
!$ACC ROUTINE (CONVECT_CLOSURE_THRVLCL_OPENACC) SEQ

USE MODD_CST,ONLY:CST_T
USE MODD_CONVPAREXT,ONLY:CONVPAREXT
USE MODD_CST,ONLY:CST_T
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (CONVPAREXT), INTENT (IN)::CVPEXT
TYPE (CST_T), INTENT (IN)::CST
TYPE (DIMPHYEX_T), INTENT (IN)::D
REAL, INTENT (IN)::PTH(D%NIT, D%NKT)
REAL, INTENT (IN)::PRV(D%NIT, D%NKT)
REAL, INTENT (IN)::PPRES(D%NIT, D%NKT)
REAL, INTENT (IN)::PZ(D%NIT, D%NKT)
INTEGER, INTENT (IN)::KDPL(D%NIT)
INTEGER, INTENT (IN)::KPBL(D%NIT)
TYPE(STACK), INTENT (IN) :: YDSTACK
TYPE(STACK) :: YLSTACK
LOGICAL, INTENT (IN)::OWORK1(D%NIT)
REAL, INTENT (OUT)::PTHLCL(D%NIT)
REAL, INTENT (OUT)::PRVLCL(D%NIT)
REAL, INTENT (OUT)::PZLCL(D%NIT)
REAL, INTENT (OUT)::PTLCL(D%NIT)
REAL, INTENT (OUT)::PTELCL(D%NIT)
INTEGER, INTENT (OUT)::KLCL(D%NIT)
INTEGER::JKMAX
INTEGER::JKMIN
INTEGER::JKM
INTEGER::JK
INTEGER::JI
INTEGER::IKE
INTEGER::IKB
REAL::ZEPS
REAL::ZRDOCP
REAL::ZCPORD
REAL::ZPLCL(D%NIT)
REAL::ZTMIX(D%NIT)
REAL::ZEVMIX(D%NIT)
REAL::ZPRESMIX(D%NIT)
REAL::ZDPTHMIX(D%NIT)
REAL::ZCPH(D%NIT)
REAL::ZLV(D%NIT)
REAL::ZDP(D%NIT)
REAL::ZWORK2(D%NIT)
REAL::ZWORK1(D%NIT)

INTEGER (KIND=JPIM) :: JLON

YLSTACK = YDSTACK



JLON = KIDIA


IKB=1+CVPEXT%JCVEXB
IKE=D%NKT-CVPEXT%JCVEXT
ZEPS=CST%XRD/CST%XRV
ZCPORD=CST%XCPD/CST%XRD
ZRDOCP=CST%XRD/CST%XCPD
ZDPTHMIX (:)=0.
ZPRESMIX (:)=0.
PTHLCL (:)=300.
PTLCL (:)=300.
PTELCL (:)=300.
PRVLCL (:)=0.
PZLCL (:)=PZ (:, IKB)
ZTMIX (:)=230.
ZPLCL (:)=1.E4
KLCL (:)=IKB+1
JKMAX=IKE
JKMIN=IKB

DO JK=IKB+1, JKMAX
  JKM=JK+1

  DO JI=D%NIB, D%NIE

    IF (JK>=KDPL (JI).AND.JK<=KPBL (JI)) THEN
      ZWORK1 (JI)=PPRES (JI, JK)-PPRES (JI, JKM)
      ZDPTHMIX (JI)=ZDPTHMIX (JI)+ZWORK1 (JI)
      ZPRESMIX (JI)=ZPRESMIX (JI)+PPRES (JI, JK)*ZWORK1 (JI)
      PTHLCL (JI)=PTHLCL (JI)+PTH (JI, JK)*ZWORK1 (JI)
      PRVLCL (JI)=PRVLCL (JI)+PRV (JI, JK)*ZWORK1 (JI)
    ENDIF

  ENDDO

ENDDO


DO JI=D%NIB, D%NIE

  IF (OWORK1 (JI)) THEN
    ZPRESMIX (JI)=ZPRESMIX (JI)/ZDPTHMIX (JI)
    PTHLCL (JI)=PTHLCL (JI)/ZDPTHMIX (JI)
    PRVLCL (JI)=PRVLCL (JI)/ZDPTHMIX (JI)
    ZTMIX (JI)=PTHLCL (JI)*(ZPRESMIX (JI)/CST%XP00)**ZRDOCP
    ZEVMIX (JI)=PRVLCL (JI)*ZPRESMIX (JI)/(PRVLCL (JI)+ZEPS)
    ZEVMIX (JI)=MAX (1.E-8, ZEVMIX (JI))
    ZWORK1 (JI)=ALOG (ZEVMIX (JI)/613.3)
    ZWORK1 (JI)=(4780.8-32.19*ZWORK1 (JI))/(17.502-ZWORK1 (JI))
    PTLCL (JI)=ZWORK1 (JI)-(.212+1.571E-3*(ZWORK1 (JI)-CST%XTT)&
    &-4.36E-4*(ZTMIX (JI)-CST%XTT))*(ZTMIX (JI)-ZWORK1 (JI))
    PTLCL (JI)=MIN (PTLCL (JI), ZTMIX (JI))
    ZPLCL (JI)=CST%XP00*(PTLCL (JI)/PTHLCL (JI))**ZCPORD
  ENDIF

ENDDO


DO JI=D%NIB, D%NIE
  ZPLCL (JI)=MIN (2.E5, MAX (10., ZPLCL (JI)))
ENDDO


DO JI=D%NIB, D%NIE
  CALL CONVECT_SATMIXRATIO_OPENACC (ZPLCL (JI), PTLCL (JI), ZEPS, ZWORK1&
  & (JI), ZLV (JI), ZWORK2 (JI), ZCPH (JI), YDSTACK=YLSTACK)
ENDDO


DO JI=D%NIB, D%NIE

  IF (OWORK1 (JI)) THEN
    ZWORK2 (JI)=ZWORK1 (JI)/PTLCL (JI)*(CST%XBETAW/PTLCL (JI)-CST%XGAMW)
    ZWORK2 (JI)=(ZWORK1 (JI)-PRVLCL (JI))/(1.+ZLV (JI)/ZCPH (JI)*ZWORK2 (JI))
    PTLCL (JI)=PTLCL (JI)-ZLV (JI)/ZCPH (JI)*ZWORK2 (JI)
  ENDIF

ENDDO


DO JI=D%NIB, D%NIE
  CALL CONVECT_SATMIXRATIO_OPENACC (ZPRESMIX (JI), ZTMIX (JI), ZEPS, ZWORK1&
  & (JI), ZLV (JI), ZWORK2 (JI), ZCPH (JI), YDSTACK=YLSTACK)
ENDDO


DO JI=D%NIB, D%NIE

  IF (OWORK1 (JI).AND.PRVLCL (JI)>ZWORK1 (JI)) THEN
    ZWORK2 (JI)=ZWORK1 (JI)/ZTMIX (JI)*(CST%XBETAW/ZTMIX (JI)-CST%XGAMW)
    ZWORK2 (JI)=(ZWORK1 (JI)-PRVLCL (JI))/(1.+ZLV (JI)/ZCPH (JI)*ZWORK2 (JI))
    PTLCL (JI)=ZTMIX (JI)+ZLV (JI)/ZCPH (JI)*ZWORK2 (JI)
    PRVLCL (JI)=PRVLCL (JI)-ZWORK2 (JI)
    ZPLCL (JI)=ZPRESMIX (JI)
    PTHLCL (JI)=PTLCL (JI)*(CST%XP00/ZPLCL (JI))**ZRDOCP
  ENDIF

ENDDO


DO JK=JKMIN, IKE-1

  DO JI=D%NIB, D%NIE

    IF (ZPLCL (JI)<=PPRES (JI, JK).AND.OWORK1 (JI)) THEN
      KLCL (JI)=JK+1
      PZLCL (JI)=PZ (JI, JK+1)
    ENDIF

  ENDDO

ENDDO


DO JI=D%NIB, D%NIE
  JK=KLCL (JI)
  JKM=JK-1
  ZDP (JI)=ALOG (ZPLCL (JI)/PPRES (JI, JKM))/ALOG (PPRES (JI, JK)/PPRES (JI, JKM))
  ZWORK1 (JI)=PTH (JI, JK)*(PPRES (JI, JK)/CST%XP00)**ZRDOCP
  ZWORK2 (JI)=PTH (JI, JKM)*(PPRES (JI, JKM)/CST%XP00)**ZRDOCP
  ZWORK1 (JI)=ZWORK2 (JI)+(ZWORK1 (JI)-ZWORK2 (JI))*ZDP (JI)
  ZWORK2 (JI)=PZ (JI, JKM)+(PZ (JI, JK)-PZ (JI, JKM))*ZDP (JI)
ENDDO


DO JI=D%NIB, D%NIE

  IF (OWORK1 (JI)) THEN
    PTELCL (JI)=ZWORK1 (JI)
    PZLCL (JI)=ZWORK2 (JI)
  ENDIF

ENDDO




INCLUDE"convect_satmixratio.h"
ENDSUBROUTINE CONVECT_CLOSURE_THRVLCL_OPENACC
