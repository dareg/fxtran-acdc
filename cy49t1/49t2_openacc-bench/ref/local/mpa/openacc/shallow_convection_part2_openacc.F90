SUBROUTINE SHALLOW_CONVECTION_PART2_OPENACC (CVP_SHAL, CVPEXT, CST, D, NSV, CONVPAR, KICE&
&, OSETTADJ, PTADJS, PPABST, PZZ, PTT, PRVT, PRCT, PRIT, OCH1CONV, KCH1, PCH1, PRDOCP, PTHT&
&, PSTHV, PSTHES, ISDPL, ISPBL, ISLCL, PSTHLCL, PSTLCL, PSRVLCL, PSWLCL, PSZLCL, PSTHVELCL&
&, GTRIG1, PUMF, PTHC, PRVC, PRCC, PRIC, ICTL, IMINCTL, PPCH1TEN, YDSTACK)
!$ACC ROUTINE (SHALLOW_CONVECTION_PART2_OPENACC) SEQ
USE PARKIND1,ONLY:JPRB

USE MODD_CONVPAR,ONLY:CONVPAR_T
USE MODD_CONVPAR_SHAL,ONLY:CONVPAR_SHAL
USE MODD_CONVPAREXT,ONLY:CONVPAREXT
USE MODD_CST,ONLY:CST_T
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODD_NSV,ONLY:NSV_T
#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (CONVPAR_SHAL), INTENT (IN)::CVP_SHAL
TYPE (CONVPAREXT), INTENT (IN)::CVPEXT
TYPE (CST_T), INTENT (IN)::CST
TYPE (DIMPHYEX_T), INTENT (IN)::D
TYPE (NSV_T), INTENT (IN)::NSV
TYPE (CONVPAR_T), INTENT (IN)::CONVPAR
INTEGER, INTENT (IN)::KICE
LOGICAL, INTENT (IN)::OSETTADJ
REAL, INTENT (IN)::PTADJS
REAL, INTENT (IN)::PPABST(D%NIT, D%NKT)
REAL, INTENT (IN)::PZZ(D%NIT, D%NKT)
REAL, INTENT (IN)::PTT(D%NIT, D%NKT)
REAL, INTENT (IN)::PRVT(D%NIT, D%NKT)
REAL, INTENT (IN)::PRCT(D%NIT, D%NKT)
REAL, INTENT (IN)::PRIT(D%NIT, D%NKT)
LOGICAL, INTENT (IN)::OCH1CONV
INTEGER, INTENT (IN)::KCH1
REAL, INTENT (IN)::PCH1(D%NIT, D%NKT, KCH1)
REAL, INTENT (IN)::PRDOCP
REAL, INTENT (IN)::PSTHES(D%NIT, D%NKT)
REAL, INTENT (IN)::PSTHV(D%NIT, D%NKT)
REAL, INTENT (IN)::PTHT(D%NIT, D%NKT)
INTEGER, INTENT (IN)::ISDPL(D%NIT)
INTEGER, INTENT (IN)::ISPBL(D%NIT)
INTEGER, INTENT (IN)::ISLCL(D%NIT)
REAL, INTENT (IN)::PSTHLCL(D%NIT)
REAL, INTENT (IN)::PSTLCL(D%NIT)
REAL, INTENT (IN)::PSRVLCL(D%NIT)
REAL, INTENT (IN)::PSWLCL(D%NIT)
REAL, INTENT (IN)::PSZLCL(D%NIT)
REAL, INTENT (IN)::PSTHVELCL(D%NIT)
LOGICAL, INTENT (IN)::GTRIG1(D%NIT)
REAL, INTENT (OUT)::PUMF(D%NIT, D%NKT)
REAL, INTENT (OUT)::PTHC(D%NIT, D%NKT)
REAL, INTENT (OUT)::PRVC(D%NIT, D%NKT)
REAL, INTENT (OUT)::PRCC(D%NIT, D%NKT)
REAL, INTENT (OUT)::PRIC(D%NIT, D%NKT)
INTEGER, INTENT (OUT)::ICTL(D%NIT)
INTEGER, INTENT (OUT)::IMINCTL(D%NIT)
REAL, INTENT (OUT)::PPCH1TEN(D%NIT, D%NKT, KCH1)
TYPE(STACK), INTENT (IN) :: YDSTACK
TYPE(STACK) :: YLSTACK
REAL::ZWORK2B(D%NIT)
REAL::ZWORK2(D%NIT)
REAL::ZW1
INTEGER::JI
INTEGER::JN
INTEGER::JKP
INTEGER::JKM
INTEGER::JK
INTEGER::IKE
INTEGER::IKB
INTEGER::IETL(D%NIT)
INTEGER::ILFS(D%NIT)
REAL::ZDPRES(D%NIT, D%NKT)
REAL::ZTHL(D%NIT, D%NKT)
REAL::ZRW(D%NIT, D%NKT)
REAL::ZUER(D%NIT, D%NKT)
REAL::ZUDR(D%NIT, D%NKT)
REAL::ZUTHL(D%NIT, D%NKT)
REAL::ZUTHV(D%NIT, D%NKT)
REAL::ZURW(D%NIT, D%NKT)
REAL::ZURC(D%NIT, D%NKT)
REAL::ZURI(D%NIT, D%NKT)
REAL::ZCAPE(D%NIT)
REAL::ZDMF(D%NIT, D%NKT)
REAL::ZDER(D%NIT, D%NKT)
REAL::ZDDR(D%NIT, D%NKT)
REAL::ZLMASS(D%NIT, D%NKT)
REAL::ZTIMEC(D%NIT)
REAL::ZWSUB(D%NIT, D%NKT)
LOGICAL::GTRIG2(D%NIT)
REAL::ZCPH(D%NIT)
REAL::ZLS(D%NIT)
REAL::ZLV(D%NIT)
REAL::ZWORK3(D%NIT, KCH1)
REAL::ZCH1(D%NIT, D%NKT, KCH1)
REAL::ZCH1C(D%NIT, D%NKT, KCH1)
INTEGER::IFTSTEPS

#include "convect_updraft_shal_openacc.h"
#include "convect_chem_transport.h"
#include "convect_closure_shal_openacc.h"
INTEGER (KIND=JPIM) :: JLON

YLSTACK = YDSTACK



JLON = KIDIA


ZDPRES=0.0
ZTHL=0.0
ZRW=0.0
IKB=1+CVPEXT%JCVEXB
IKE=D%NKT-CVPEXT%JCVEXT

DO JK=IKE+1, D%NKT
  PUMF (:, JK)=0.
  PTHC (:, JK)=0.
  PRVC (:, JK)=0.
  PRCC (:, JK)=0.
  PRIC (:, JK)=0.
  PPCH1TEN (:, JK,:)=0.
ENDDO

ZDPRES (:, IKB)=0.

DO JK=IKB+1, IKE
  ZDPRES (:, JK)=PPABST (:, JK-1)-PPABST (:, JK)
ENDDO


DO JK=IKB, IKE, 1
  ZRW (:, JK)=MAX (0., PRVT (:, JK))+MAX (0., PRCT (:, JK))+MAX (0., PRIT (:, JK))
  ZCPH (:)=CST%XCPD+CST%XCPV*ZRW (:, JK)
  ZLV (:)=CST%XLVTT+(CST%XCPV-CST%XCL)*(PTT (:, JK)-CST%XTT)
  ZLS (:)=CST%XLSTT+(CST%XCPV-CST%XCI)*(PTT (:, JK)-CST%XTT)
  ZTHL (:, JK)=ZCPH (:)*PTT (:, JK)+(1.+ZRW (:, JK))*CST%XG*PZZ (:, JK&
  &)-ZLV (:)*MAX (0., PRCT (:, JK))-ZLS (:)*MAX (0., PRIT (:, JK))
ENDDO

CALL CONVECT_UPDRAFT_SHAL_OPENACC (CVP_SHAL, CVPEXT, CST, D, CONVPAR, KICE, PPABST&
&, ZDPRES, PZZ, ZTHL, PSTHV, PSTHES, ZRW, PSTHLCL, PSTLCL, PSRVLCL, PSWLCL, PSZLCL&
&, PSTHVELCL, CVP_SHAL%XA25*1.E-3, GTRIG2, ISLCL, ISDPL, ISPBL, PUMF, ZUER, ZUDR,&
& ZUTHL, ZUTHV, ZURW, ZURC, ZURI, ZCAPE, ICTL, IETL, GTRIG1, YDSTACK=YLSTACK)
ZDMF (:,:)=0.
ZDER (:,:)=0.
ZDDR (:,:)=0.
ILFS (:)=IKB

DO JK=IKB, IKE
  ZLMASS (:, JK)=CVP_SHAL%XA25*ZDPRES (:, JK)/CST%XG
ENDDO

ZLMASS (:, IKB)=ZLMASS (:, IKB+1)
ZTIMEC (:)=CVP_SHAL%XCTIME_SHAL

IF (OSETTADJ)  THEN
    ZTIMEC (:)=PTADJS
ENDIF

CALL CONVECT_CLOSURE_SHAL_OPENACC (CVP_SHAL, CVPEXT, CST, D, PPABST, ZDPRES, PZZ, ZLMASS, ZTHL&
&, PTHT, ZRW, PRCT, PRIT, GTRIG2, PTHC, PRVC, PRCC, PRIC, ZWSUB, ISLCL, ISDPL, ISPBL, ICTL,&
& PUMF, ZUER, ZUDR, ZUTHL, ZURW, ZURC, ZURI, ZCAPE, ZTIMEC, IFTSTEPS, YDSTACK=YLSTACK)

DO JK=IKB, IKE

  DO JI=D%NIB, D%NIE
    PTHC (JI, JK)=(PTHC (JI, JK)-PTHT (JI, JK))/ZTIMEC (JI)*(PPABST (JI, JK)/CST%XP00)**PRDOCP
    PRVC (JI, JK)=(PRVC (JI, JK)-ZRW (JI, JK)+MAX (0., PRCT&
    & (JI, JK))+MAX (0., PRIT (JI, JK)))/ZTIMEC (JI)
    PRCC (JI, JK)=(PRCC (JI, JK)-MAX (0., PRCT (JI, JK)))/ZTIMEC (JI)
    PRIC (JI, JK)=(PRIC (JI, JK)-MAX (0., PRIT (JI, JK)))/ZTIMEC (JI)
  ENDDO

ENDDO


IF (CVP_SHAL%LLSMOOTH) THEN

  DO JI=D%NIB, D%NIE
    JK=ICTL (JI)
    JKM=MAX (2, ICTL (JI)-1)
    JKP=MAX (2, ICTL (JI)-2)
    PRVC (JI, JKM)=PRVC (JI, JKM)+.5*PRVC (JI, JK)
    PRCC (JI, JKM)=PRCC (JI, JKM)+.5*PRCC (JI, JK)
    PRIC (JI, JKM)=PRIC (JI, JKM)+.5*PRIC (JI, JK)
    PTHC (JI, JKM)=PTHC (JI, JKM)+.5*PTHC (JI, JK)
    PRVC (JI, JKP)=PRVC (JI, JKP)+.3*PRVC (JI, JK)
    PRCC (JI, JKP)=PRCC (JI, JKP)+.3*PRCC (JI, JK)
    PRIC (JI, JKP)=PRIC (JI, JKP)+.3*PRIC (JI, JK)
    PTHC (JI, JKP)=PTHC (JI, JKP)+.3*PTHC (JI, JK)
    PRVC (JI, JK)=.2*PRVC (JI, JK)
    PRCC (JI, JK)=.2*PRCC (JI, JK)
    PRIC (JI, JK)=.2*PRIC (JI, JK)
    PTHC (JI, JK)=.2*PTHC (JI, JK)
  ENDDO

ENDIF

JKM=IKE
ZWORK2 (:)=0.
ZWORK2B (:)=0.

DO JK=IKB+1, JKM
  JKP=JK+1

  DO JI=D%NIB, D%NIE

    IF (JK<=ICTL (JI)) THEN
      ZW1=PRVC (JI, JK)+PRCC (JI, JK)+PRIC (JI, JK)
      ZWORK2 (JI)=ZWORK2 (JI)+ZW1*.5*(PPABST (JI, JK-1)-PPABST (JI, JKP))/CST%XG
      ZW1=(CST%XCPD+CST%XCPV*ZRW (JI, JK))*PTHC (JI, JK)-(CST%XLVTT+(CST%XCPV-CST%XCL)*(PTT (JI, JK)-CST&
      &%XTT))*PRCC (JI, JK)-(CST%XLSTT+(CST%XCPV-CST%XCL)*(PTT (JI, JK)-CST%XTT))*PRIC (JI, JK)
      ZWORK2B (JI)=ZWORK2B (JI)+ZW1*.5*(PPABST (JI, JK-1)-PPABST (JI, JKP))/CST%XG
    ENDIF

  ENDDO

ENDDO


DO JI=D%NIB, D%NIE

  IF (ICTL (JI)>IKB+1) THEN
    JKP=ICTL (JI)
    ZW1=CST%XG/(PPABST (JI, IKB)-PPABST (JI, JKP)-.5*(ZDPRES (JI, IKB+1)-ZDPRES (JI, JKP+1)))
    ZWORK2 (JI)=ZWORK2 (JI)*ZW1
    ZWORK2B (JI)=ZWORK2B (JI)*ZW1
  ENDIF

ENDDO


DO JK=JKM, IKB+1,-1

  DO JI=D%NIB, D%NIE

    IF (ICTL (JI)>IKB+1.AND.JK<=ICTL (JI)) THEN
      PRVC (JI, JK)=PRVC (JI, JK)-ZWORK2 (JI)
      PTHC (JI, JK)=PTHC (JI, JK)-ZWORK2B (JI)/CST%XCPD
    ENDIF

  ENDDO

ENDDO



DO JK=IKB, IKE

  DO JI=D%NIB, D%NIE

    IF (ICTL (JI)<=IKB+1) THEN
      PUMF (JI, JK)=0
    ELSE
      PUMF (JI, JK)=PUMF (JI, JK)/CVP_SHAL%XA25
    ENDIF

  ENDDO

ENDDO


DO JI=D%NIB, D%NIE
  IMINCTL (JI)=MIN (ISLCL (JI), ICTL (JI))
ENDDO


DO JK=IKB, IKE

  DO JI=D%NIB, D%NIE

    IF (.NOT.GTRIG1 (JI)) THEN
      PTHC (JI, JK)=0.
      PRVC (JI, JK)=0.
      PRCC (JI, JK)=0.
      PRIC (JI, JK)=0.
    ENDIF

  ENDDO

ENDDO


DO JI=D%NIB, D%NIE

  IF (.NOT.GTRIG1 (JI)) THEN
    ICTL (JI)=0.
    IMINCTL (JI)=0.
  ENDIF

ENDDO

PUMF (:, D%NKT)=0.
PTHC (:, D%NKT)=0.
PRVC (:, D%NKT)=0.
PRCC (:, D%NKT)=0.
PRIC (:, D%NKT)=0.
PPCH1TEN (:, D%NKT,:)=0.


ENDSUBROUTINE SHALLOW_CONVECTION_PART2_OPENACC
