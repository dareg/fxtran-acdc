
MODULE MODE_COMPUTE_UPDRAFT_OPENACC


IMPLICIT NONE


CONTAINS
SUBROUTINE COMPUTE_UPDRAFT_OPENACC (D, CST, NEBN, PARAMMF, TURBN, CSTURB, KSV, OENTR_DETR&
&, ONOMIXLG, KSV_LGBEG, KSV_LGEND, PZZ, PDZZ, PSFTH, PSFRV, PPABSM, PRHODREF, PUM, PVM&
&, PTKEM, PTHM, PRVM, PTHLM, PRTM, PSVM, PTHL_UP, PRT_UP, PRV_UP, PRC_UP, PRI_UP, PTHV_UP&
&, PW_UP, PU_UP, PV_UP, PSV_UP, PFRAC_UP, PFRAC_ICE_UP, PRSAT_UP, PEMF, PDETR, PENTR&
&, PBUO_INTEG, KKLCL, KKETL, KKCTL, PDEPTH, PDX, PDY, YDSTACK)
!$ACC ROUTINE (COMPUTE_UPDRAFT_OPENACC) SEQ
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODD_CST,ONLY:CST_T
USE MODD_NEB_N,ONLY:NEB_T
USE MODD_PARAM_MFSHALL_N,ONLY:PARAM_MFSHALL_T
USE MODD_TURB_N,ONLY:TURB_T
USE MODD_CTURB,ONLY:CSTURB_T
USE MODI_SHUMAN_MF_OPENACC,ONLY:MZM_MF_OPENACC, MZF_MF_OPENACC, GZ_M_W_MF_OPENACC
USE MODE_COMPUTE_BL89_ML_OPENACC,ONLY:COMPUTE_BL89_ML_OPENACC
USE MODE_MSG_OPENACC,ONLY:PRINT_MSG_OPENACC, NVERB_FATAL

#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (DIMPHYEX_T), INTENT (IN)::D
TYPE (CST_T), INTENT (IN)::CST
TYPE (NEB_T), INTENT (IN)::NEBN
TYPE (PARAM_MFSHALL_T), INTENT (IN)::PARAMMF
TYPE (TURB_T), INTENT (IN)::TURBN
TYPE (CSTURB_T), INTENT (IN)::CSTURB
INTEGER, INTENT (IN)::KSV
LOGICAL, INTENT (IN)::OENTR_DETR
LOGICAL, INTENT (IN)::ONOMIXLG
INTEGER, INTENT (IN)::KSV_LGBEG
INTEGER, INTENT (IN)::KSV_LGEND
REAL, INTENT (IN)::PZZ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PDZZ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PSFRV(D%NIJT)
REAL, INTENT (IN)::PSFTH(D%NIJT)
REAL, INTENT (IN)::PPABSM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRHODREF(D%NIJT, D%NKT)
REAL, INTENT (IN)::PUM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PVM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTKEM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRVM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRTM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHLM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PSVM(D%NIJT, D%NKT, KSV)
REAL, INTENT (OUT)::PRT_UP(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PTHL_UP(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PV_UP(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PU_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PRSAT_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PFRAC_ICE_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PFRAC_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PW_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PTHV_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PRI_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PRC_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PRV_UP(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PSV_UP(D%NIJT, D%NKT, KSV)
REAL, INTENT (INOUT)::PENTR(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PDETR(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PEMF(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PBUO_INTEG(D%NIJT, D%NKT)
INTEGER, INTENT (INOUT)::KKCTL(D%NIJT)
INTEGER, INTENT (INOUT)::KKETL(D%NIJT)
INTEGER, INTENT (INOUT)::KKLCL(D%NIJT)
REAL, INTENT (OUT)::PDEPTH(D%NIJT)
REAL, INTENT (IN)::PDY
TYPE(STACK), INTENT (IN) :: YDSTACK
TYPE(STACK) :: YLSTACK
REAL, INTENT (IN)::PDX
REAL::ZRVM_F(D%NIJT, D%NKT)
REAL::ZTHM_F(D%NIJT, D%NKT)
REAL::ZDETR_CLD(D%NIJT, D%NKT)
REAL::ZENTR_CLD(D%NIJT, D%NKT)
REAL::ZBUO_INTEG_CLD(D%NIJT, D%NKT)
REAL::ZBUO_INTEG_DRY(D%NIJT, D%NKT)
REAL::ZW_UP2(D%NIJT, D%NKT)
REAL::ZG_O_THVREF(D%NIJT, D%NKT)
REAL::ZTHVM(D%NIJT, D%NKT)
REAL::ZTHVM_F(D%NIJT, D%NKT)
REAL::ZPRES_F(D%NIJT, D%NKT)
REAL::ZRHO_F(D%NIJT, D%NKT)
REAL::ZVM_F(D%NIJT, D%NKT)
REAL::ZUM_F(D%NIJT, D%NKT)
REAL::ZTKEM_F(D%NIJT, D%NKT)
REAL::ZTHLM_F(D%NIJT, D%NKT)
REAL::ZRTM_F(D%NIJT, D%NKT)
REAL::ZSVM_F(D%NIJT, D%NKT, KSV)
REAL::ZRI_MIX(D%NIJT, D%NKT)
REAL::ZRC_MIX(D%NIJT, D%NKT)
REAL::ZTH_UP(D%NIJT, D%NKT)
REAL::ZCOEF(D%NIJT, D%NKT)
REAL::ZWTHVSURF(D%NIJT)
REAL::ZRDORV
REAL::ZRVORD
REAL::ZMIX2_CLD(D%NIJT)
REAL::ZMIX3_CLD(D%NIJT)
REAL::ZMIX2(D%NIJT)
REAL::ZMIX1(D%NIJT)
REAL::ZLUP(D%NIJT)
INTEGER::JSV
INTEGER::JIJ
INTEGER::JK
LOGICAL::GTESTETL(D%NIJT)
LOGICAL::GTESTLCL(D%NIJT)
LOGICAL::GTEST(D%NIJT)
LOGICAL::GLMIX
LOGICAL::GWORK1(D%NIJT)
LOGICAL::GWORK2(D%NIJT, D%NKT)
INTEGER::ITEST
REAL::ZPART_DRY(D%NIJT)
REAL::ZRSATI(D%NIJT)
REAL::ZRSATW(D%NIJT)
REAL::ZRV_UP(D%NIJT)
REAL::ZRI_UP(D%NIJT)
REAL::ZRC_UP(D%NIJT)
REAL::ZDEPTH_MAX2
REAL::ZDEPTH_MAX1
REAL::ZRMAX
REAL::ZTMAX
REAL::ZSURF(D%NIJT)
REAL::ZDVDZ(D%NIJT, D%NKT)
REAL::ZDUDZ(D%NIJT, D%NKT)
REAL::ZSHEAR(D%NIJT, D%NKT)
REAL::ZWK(D%NIJT, D%NKT)
REAL::ZBUF(D%NIJT, 16)

REAL::ZKIC_F2(D%NIJT)
REAL::ZKIC(D%NIJT)
REAL::ZDELTA(D%NIJT)
REAL::ZEPSI(D%NIJT)
REAL::ZEPSI_CLOUD
REAL::ZCOEFFMF_CLOUD
REAL::ZMIXRT(D%NIJT)
REAL::ZMIXTHL(D%NIJT)
REAL::ZTHMIX(D%NIJT)
REAL::ZRIMIX(D%NIJT)
REAL::ZRCMIX(D%NIJT)
REAL::ZRVMIX(D%NIJT)
REAL::ZTHVMIX_F2(D%NIJT)
REAL::ZTHVMIX(D%NIJT)
REAL::ZTHV_UP_F2(D%NIJT)
REAL::ZRSATI_ED(D%NIJT)
REAL::ZRSATW_ED(D%NIJT)
REAL::ZTHV(D%NIJT)
REAL::ZKIC_INIT
REAL::ZCOTHVU
REAL::ZFOESI
REAL::ZFOESW
REAL::ZDRSATODP
REAL::ZT
REAL::ZWK0D
REAL::ZCOEFF_PLUS_HALF(D%NIJT)
REAL::ZCOEFF_MINUS_HALF(D%NIJT)
REAL::ZPRE(D%NIJT)
REAL::ZG_O_THVREF_ED(D%NIJT)
REAL::ZFRAC_ICE(D%NIJT)
REAL::ZTHV_PLUS_HALF(D%NIJT)
REAL::ZTHV_MINUS_HALF(D%NIJT)
REAL::ZDZ_STOP(D%NIJT)
REAL::ZDZ
INTEGER::JKLIM
INTEGER::IIJE
INTEGER::IIJB
INTEGER::IKL
INTEGER::IKE
INTEGER::IKB
INTEGER::IKT
INTEGER (KIND=JPIM) :: JLON

YLSTACK = YDSTACK



JLON = KIDIA


IIJE=D%NIJE
IIJB=D%NIJB
IKT=D%NKT
IKB=D%NKB
IKE=D%NKE
IKL=D%NKL
ZTMAX=2.0
ZRMAX=1.E-3
ZRDORV=CST%XRD/CST%XRV
ZRVORD=(CST%XRV/CST%XRD)
ZDEPTH_MAX1=3000.
ZDEPTH_MAX2=4000.

IF (OENTR_DETR) THEN
  KKLCL (:)=IKE
  KKETL (:)=IKE
  KKCTL (:)=IKE
  PEMF (:,:)=0.
  PDETR (:,:)=0.
  PENTR (:,:)=0.
  PRV_UP (:,:)=0.
  PRC_UP (:,:)=0.
  PRI_UP (:,:)=0.
  PW_UP (:,:)=0.
  ZTH_UP (:,:)=0.
  PFRAC_UP (:,:)=0.
  PTHV_UP (:,:)=0.
  PBUO_INTEG=0.
  PFRAC_ICE_UP (:,:)=0.

  DO JK=1, IKT

    DO JIJ=IIJB, IIJE
      PRSAT_UP (JIJ, JK)=PRVM (JIJ, JK)
    ENDDO

  ENDDO

  ZRC_MIX=0.
  ZRI_MIX=0.
ENDIF

CALL MZM_MF_OPENACC (D, PTHLM (:,:), ZTHLM_F (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PRTM (:,:), ZRTM_F (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PUM (:,:), ZUM_F (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PVM (:,:), ZVM_F (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PTKEM (:,:), ZTKEM_F (:,:), YDSTACK=YLSTACK)

DO JSV=1, KSV

  IF (ONOMIXLG.AND.JSV>=KSV_LGBEG.AND.JSV<=KSV_LGEND)  THEN
      CYCLE
  ENDIF

  CALL MZM_MF_OPENACC (D, PSVM (:,:, JSV), ZSVM_F (:,:, JSV), YDSTACK=YLSTACK)
ENDDO


DO JK=1, IKT

  DO JIJ=IIJB, IIJE
    PTHL_UP (JIJ, JK)=ZTHLM_F (JIJ, JK)
    PRT_UP (JIJ, JK)=ZRTM_F (JIJ, JK)
    PU_UP (JIJ, JK)=ZUM_F (JIJ, JK)
    PV_UP (JIJ, JK)=ZVM_F (JIJ, JK)
  ENDDO

ENDDO


DO JSV=1, KSV

  DO JK=1, IKT

    DO JIJ=IIJB, IIJE
      PSV_UP (JIJ, JK, JSV)=ZSVM_F (JIJ, JK, JSV)
    ENDDO

  ENDDO

ENDDO


DO JIJ=IIJB, IIJE
  PTHL_UP (JIJ, IKB)=ZTHLM_F (JIJ, IKB)+MAX (0., MIN (ZTMAX,(PSFTH&
  & (JIJ)/SQRT (ZTKEM_F (JIJ, IKB)))*PARAMMF%XALP_PERT))
  PRT_UP (JIJ, IKB)=ZRTM_F (JIJ, IKB)+MAX (0., MIN (ZRMAX,(PSFRV&
  & (JIJ)/SQRT (ZTKEM_F (JIJ, IKB)))*PARAMMF%XALP_PERT))
ENDDO


IF (OENTR_DETR) THEN
  CALL MZM_MF_OPENACC (D, PTHM (:,:), ZTHM_F (:,:), YDSTACK=YLSTACK)
  CALL MZM_MF_OPENACC (D, PPABSM (:,:), ZPRES_F (:,:), YDSTACK=YLSTACK)
  CALL MZM_MF_OPENACC (D, PRHODREF (:,:), ZRHO_F (:,:), YDSTACK=YLSTACK)
  CALL MZM_MF_OPENACC (D, PRVM (:,:), ZRVM_F (:,:), YDSTACK=YLSTACK)

  DO JK=1, IKT

    DO JIJ=IIJB, IIJE
      ZTHVM_F (JIJ, JK)=ZTHM_F (JIJ, JK)*((1.+ZRVORD*ZRVM_F (JIJ, JK))/(1.+ZRTM_F (JIJ, JK)))
      ZTHVM (JIJ, JK)=PTHM (JIJ, JK)*((1.+ZRVORD*PRVM (JIJ, JK))/(1.+PRTM (JIJ, JK)))
      PTHV_UP (JIJ, JK)=ZTHVM_F (JIJ, JK)
    ENDDO

  ENDDO

  ZW_UP2 (:,:)=0.

  DO JIJ=IIJB, IIJE
    ZW_UP2 (JIJ, IKB)=MAX (0.0001,(2./3.)*ZTKEM_F (JIJ, IKB))
    PRC_UP (JIJ, IKB)=0.
    PRI_UP (JIJ, IKB)=0.
  ENDDO

  CALL TH_R_FROM_THL_RT_OPENACC (CST, NEBN, D%NIJT, NEBN%CFRAC_ICE_SHALLOW_MF, PFRAC_ICE_UP&
  & (:, IKB), ZPRES_F (:, IKB), PTHL_UP (:, IKB), PRT_UP (:, IKB), ZTH_UP (:, IKB),&
  & PRV_UP (:, IKB), PRC_UP (:, IKB), PRI_UP (:, IKB), ZRSATW (:), ZRSATI (:), OOCEAN&
  &=.FALSE., PBUF=ZBUF (:,:), KB=D%NIJB, KE=D%NIJE, YDSTACK=YLSTACK)

  DO JIJ=IIJB, IIJE
    PTHV_UP (JIJ, IKB)=ZTH_UP (JIJ, IKB)*((1+ZRVORD*PRV_UP (JIJ, IKB))/(1+PRT_UP (JIJ, IKB)))
    PRSAT_UP (JIJ, IKB)=ZRSATW (JIJ)*(1-PFRAC_ICE_UP (JIJ, IKB))+ZRSATI (JIJ)*PFRAC_ICE_UP (JIJ, IKB)
  ENDDO


  DO JK=1, IKT

    DO JIJ=IIJB, IIJE
      ZG_O_THVREF (JIJ, JK)=CST%XG/ZTHVM_F (JIJ, JK)
    ENDDO

  ENDDO

  GLMIX=.TRUE.

  DO JIJ=IIJB, IIJE
    ZTKEM_F (JIJ, IKB)=0.
  ENDDO


  IF (TURBN%CTURBLEN=='RM17') THEN
    CALL GZ_M_W_MF_OPENACC (D, PUM, PDZZ, ZWK, YDSTACK=YLSTACK)
    CALL MZF_MF_OPENACC (D, ZWK, ZDUDZ, YDSTACK=YLSTACK)
    CALL GZ_M_W_MF_OPENACC (D, PVM, PDZZ, ZWK, YDSTACK=YLSTACK)
    CALL MZF_MF_OPENACC (D, ZWK, ZDVDZ, YDSTACK=YLSTACK)

    DO JK=1, IKT

      DO JIJ=IIJB, IIJE
        ZSHEAR (JIJ, JK)=SQRT (ZDUDZ (JIJ, JK)**2+ZDVDZ (JIJ, JK)**2)
      ENDDO

    ENDDO

  ELSE
    ZSHEAR=0.
  ENDIF

  CALL COMPUTE_BL89_ML_OPENACC (D, CST, CSTURB, PDZZ, ZTKEM_F (:, IKB), ZG_O_THVREF&
  & (:, IKB), ZTHVM, IKB, GLMIX,.TRUE., ZSHEAR, ZLUP, YDSTACK=YLSTACK)

  DO JIJ=IIJB, IIJE
    ZLUP (JIJ)=MAX (ZLUP (JIJ), 1.E-10)
    ZWTHVSURF (JIJ)=(ZTHVM_F (JIJ, IKB)/ZTHM_F (JIJ, IKB)&
    &)*PSFTH (JIJ)+(0.61*ZTHM_F (JIJ, IKB))*PSFRV (JIJ)
  ENDDO


  IF (PARAMMF%LGZ) THEN

    IF (PDX==0..OR.PDY==0.) THEN
      CALL PRINT_MSG_OPENACC (NVERB_FATAL,'GEN','COMPUTE_UPDRAFT'&
      &,'PDX or PDY is NULL with option LGZ!', YDSTACK=YLSTACK)
    ENDIF


    DO JIJ=IIJB, IIJE
      ZSURF (JIJ)=TANH (PARAMMF%XGZ*SQRT (PDX*PDY)/ZLUP (JIJ))
    ENDDO

  ELSE
    ZSURF (IIJB:IIJE)=1.
  ENDIF


  DO JIJ=IIJB, IIJE

    IF (ZWTHVSURF (JIJ)>0.) THEN
      PEMF (JIJ, IKB)=PARAMMF%XCMF*ZSURF (JIJ)*ZRHO_F (JIJ, IKB)*((ZG_O_THVREF&
      & (JIJ, IKB))*ZWTHVSURF (JIJ)*ZLUP (JIJ))**(1./3.)
      PFRAC_UP (JIJ, IKB)=MIN (PEMF (JIJ, IKB)/(SQRT (ZW_UP2 (JIJ&
      &, IKB))*ZRHO_F (JIJ, IKB)), PARAMMF%XFRAC_UP_MAX)
      ZW_UP2 (JIJ, IKB)=(PEMF (JIJ, IKB)/(PFRAC_UP (JIJ, IKB)*ZRHO_F (JIJ, IKB)))**2
      GTEST (JIJ)=.TRUE.
    ELSE
      PEMF (JIJ, IKB)=0.
      GTEST (JIJ)=.FALSE.
    ENDIF

  ENDDO

ELSE

  DO JIJ=IIJB, IIJE
    GTEST (JIJ)=PEMF (JIJ, IKB+IKL)>0.
  ENDDO

ENDIF

GTESTLCL (:)=.FALSE.
GTESTETL (:)=.FALSE.

DO JK=IKB, IKE-IKL, IKL
  ITEST=MERGE (1, 0, GTEST)

  IF (ITEST==0)  THEN
      CYCLE
  ENDIF


  DO JIJ=IIJB, IIJE

    IF ((PRC_UP (JIJ, JK)+PRI_UP (JIJ, JK)>0.).AND.(.NOT.(GTESTLCL (JIJ)))) THEN
      KKLCL (JIJ)=JK
      GTESTLCL (JIJ)=.TRUE.
    ENDIF

  ENDDO


  IF (OENTR_DETR) THEN

    IF (JK/=IKB) THEN

      DO JIJ=IIJB, IIJE
        ZRC_MIX (JIJ, JK)=ZRC_MIX (JIJ, JK-IKL)
        ZRI_MIX (JIJ, JK)=ZRI_MIX (JIJ, JK-IKL)
      ENDDO

    ENDIF

    
    ZCOEFFMF_CLOUD=PARAMMF%XENTR_MF*CST%XG/PARAMMF%XCRAD_MF

    DO JIJ=IIJB, IIJE
      ZG_O_THVREF_ED (JIJ)=CST%XG/ZTHVM (JIJ,JK)
      ZFRAC_ICE (JIJ)=PFRAC_ICE_UP (JIJ, JK)
      ZPRE (JIJ)=ZPRES_F (JIJ, JK)
    ENDDO


    DO JIJ=IIJB, IIJE

      IF (GTEST (JIJ).AND.GTESTLCL (JIJ)) THEN
        ZPART_DRY (JIJ)=0.
        ZDZ_STOP (JIJ)=0.
        ZPRE (JIJ)=ZPRES_F (JIJ, JK)
      ELSEIF (GTEST (JIJ).AND..NOT.GTESTLCL (JIJ)) THEN
        ZT=ZTH_UP (JIJ, JK)*(ZPRES_F (JIJ, JK)/CST%XP00)**(CST%XRD/CST%XCPD)
        ZFOESW=MIN (EXP (CST%XALPW-CST%XBETAW/ZT-CST%XGAMW*LOG (ZT)), 0.99*ZPRES_F (JIJ, JK))
        ZFOESI=MIN (EXP (CST%XALPI-CST%XBETAI/ZT-CST%XGAMI*LOG (ZT)), 0.99*ZPRES_F (JIJ, JK))
        ZDRSATODP=(CST%XBETAW/ZT-CST%XGAMW)*(1-ZFRAC_ICE (JIJ))+(CST%XBETAI/ZT-CST%XGAMI)*ZFRAC_ICE (JIJ)
        ZDRSATODP=((CST%XRD/CST%XCPD)*ZDRSATODP-1.)*PRSAT_UP (JIJ, JK)/(ZPRES_F&
        & (JIJ, JK)-(ZFOESW*(1-ZFRAC_ICE (JIJ))+ZFOESI*ZFRAC_ICE (JIJ)))
        ZPRE (JIJ)=ZPRES_F (JIJ, JK)+(PRT_UP (JIJ, JK)-PRSAT_UP (JIJ, JK))/ZDRSATODP
        ZPART_DRY (JIJ)=MAX (0., MIN (1.,(ZPRES_F (JIJ, JK)-ZPRE&
        & (JIJ))/(ZPRES_F (JIJ, JK)-ZPRES_F (JIJ, JK+IKL))))
        ZDZ_STOP (JIJ)=(PZZ (JIJ,JK+IKL)-PZZ (JIJ,JK))*ZPART_DRY (JIJ)
      ELSE
        ZPART_DRY (JIJ)=0.
      ENDIF

    ENDDO


    DO JIJ=IIJB, IIJE

      IF (JK/=IKB) THEN
        ZCOEFF_MINUS_HALF (JIJ)=((ZTHVM (JIJ,JK)-ZTHVM (JIJ,JK-IKL))/PDZZ (JIJ,JK))
        ZTHV_MINUS_HALF (JIJ)=ZTHVM (JIJ,JK)-ZCOEFF_MINUS_HALF (JIJ)*0.5*(PZZ (JIJ,JK+IKL)-PZZ (JIJ,JK))
      ELSE
        ZCOEFF_MINUS_HALF (JIJ)=0.
        ZTHV_MINUS_HALF (JIJ)=ZTHVM (JIJ,JK)
      ENDIF

      ZCOEFF_PLUS_HALF (JIJ)=((ZTHVM (JIJ,JK+IKL)-ZTHVM (JIJ,JK))/PDZZ (JIJ,JK+IKL))
      ZTHV_PLUS_HALF (JIJ)=ZTHVM (JIJ,JK)+ZCOEFF_PLUS_HALF (JIJ)*0.5*(PZZ (JIJ,JK+IKL)-PZZ (JIJ,JK))
    ENDDO


    DO JIJ=IIJB, IIJE

      IF (GTEST (JIJ).AND.ZPART_DRY (JIJ)>0.) THEN
        ZDZ=MIN (ZDZ_STOP (JIJ),(PZZ (JIJ,JK+IKL)-PZZ (JIJ,JK))*0.5)
        ZBUO_INTEG_DRY (JIJ, JK)=ZG_O_THVREF_ED (JIJ)*ZDZ*(0.5*(-ZCOEFF_MINUS_HALF&
        & (JIJ))*ZDZ-ZTHV_MINUS_HALF (JIJ)+PTHV_UP (JIJ, JK))
        ZDZ=MAX (0., ZDZ_STOP (JIJ)-(PZZ (JIJ,JK+IKL)-PZZ (JIJ,JK))*0.5)
        ZBUO_INTEG_DRY (JIJ, JK)=ZBUO_INTEG_DRY (JIJ, JK)+ZG_O_THVREF_ED (JIJ)*ZDZ&
        &*(0.5*(-ZCOEFF_PLUS_HALF (JIJ))*ZDZ-ZTHVM (JIJ,JK)+PTHV_UP (JIJ, JK))

        IF (ZBUO_INTEG_DRY (JIJ, JK)>=0.) THEN
          PENTR (JIJ, JK)=0.5/(PARAMMF%XABUO-PARAMMF%XBENTR*PARAMMF%XENTR_DRY)*LOG (1.+(2.*(PARAMMF&
          &%XABUO-PARAMMF%XBENTR*PARAMMF%XENTR_DRY)/ZW_UP2 (JIJ,JK))*ZBUO_INTEG_DRY (JIJ, JK))
          PDETR (JIJ, JK)=0.
        ELSE
          PENTR (JIJ, JK)=0.
          PDETR (JIJ, JK)=0.5/(PARAMMF%XABUO)*LOG (1.+(2.*(PARAMMF&
          &%XABUO)/ZW_UP2 (JIJ,JK))*(-ZBUO_INTEG_DRY (JIJ, JK)))
        ENDIF

        PENTR (JIJ, JK)=PARAMMF%XENTR_DRY*PENTR (JIJ, JK)/(PZZ (JIJ,JK+IKL)-PZZ (JIJ,JK))
        PDETR (JIJ, JK)=PARAMMF%XDETR_DRY*PDETR (JIJ, JK)/(PZZ (JIJ,JK+IKL)-PZZ (JIJ,JK))
        ZWK0D=ZLUP (JIJ)-0.5*(PZZ (JIJ,JK)+PZZ (JIJ,JK+IKL))
        ZWK0D=SIGN (MAX (1., ABS (ZWK0D)), ZWK0D)
        PDETR (JIJ, JK)=MAX (ZPART_DRY (JIJ)*PARAMMF%XDETR_LUP/ZWK0D, PDETR (JIJ, JK))
      ELSE
        ZBUO_INTEG_DRY (JIJ, JK)=0.
        PENTR (JIJ, JK)=0.
        PDETR (JIJ, JK)=0.
      ENDIF

    ENDDO


    DO JIJ=IIJB, IIJE
      ZRCMIX (JIJ)=PRC_UP (JIJ, JK)
      ZRIMIX (JIJ)=PRI_UP (JIJ, JK)
    ENDDO

    CALL TH_R_FROM_THL_RT_OPENACC (CST, NEBN, D%NIJT, NEBN%CFRAC_ICE_SHALLOW_MF, ZFRAC_ICE, ZPRES_F&
    & (:, JK+IKL), PTHL_UP (:, JK), PRT_UP (:, JK), ZTHMIX, ZRVMIX, ZRCMIX, ZRIMIX, ZRSATW_ED&
    &, ZRSATI_ED, OOCEAN=.FALSE., PBUF=ZBUF, KB=D%NIJB, KE=D%NIJE, YDSTACK=YLSTACK)

    DO JIJ=IIJB, IIJE
      ZTHV_UP_F2 (JIJ)=ZTHMIX (JIJ)*(1.+ZRVORD*ZRVMIX (JIJ))/(1.+PRT_UP (JIJ, JK))
    ENDDO


    DO JIJ=IIJB, IIJE

      IF (GTEST (JIJ).AND.ZPART_DRY (JIJ)<1.) THEN
        ZCOTHVU=(ZTHV_UP_F2 (JIJ)-PTHV_UP (JIJ, JK))/((PZZ (JIJ,JK+IKL)-PZZ (JIJ,JK))*(1-ZPART_DRY (JIJ)))
        ZDZ=MAX (0., 0.5*(PZZ (JIJ,JK+IKL)-PZZ (JIJ,JK))-ZDZ_STOP (JIJ))
        ZBUO_INTEG_CLD (JIJ, JK)=ZG_O_THVREF_ED (JIJ)*ZDZ*(0.5*(ZCOTHVU-ZCOEFF_MINUS_HALF&
        & (JIJ))*ZDZ-(ZTHVM (JIJ,JK)-ZDZ*ZCOEFF_MINUS_HALF (JIJ))+PTHV_UP (JIJ, JK))
        ZDZ=(PZZ (JIJ,JK+IKL)-PZZ (JIJ,JK))-MAX (ZDZ_STOP (JIJ), 0.5*(PZZ (JIJ,JK+IKL)-PZZ (JIJ,JK)))
        ZBUO_INTEG_CLD (JIJ, JK)=ZBUO_INTEG_CLD (JIJ, JK)+ZG_O_THVREF_ED (JIJ)*ZDZ*&
        &(0.5*(ZCOTHVU-ZCOEFF_PLUS_HALF (JIJ))*ZDZ-(ZTHVM (JIJ,JK)+(0.5*((PZZ (JIJ,JK&
        &+IKL)-PZZ (JIJ,JK)))-ZDZ)*ZCOEFF_PLUS_HALF (JIJ))+PTHV_UP (JIJ, JK))
      ELSE
        ZBUO_INTEG_CLD (JIJ, JK)=0.
      ENDIF

    ENDDO

    ZKIC_INIT=0.1
    JKLIM=IKL*MAX (IKL*(JK-IKL), IKL*IKB)

    DO JIJ=IIJB, IIJE

      IF (GTEST (JIJ).AND.ZPART_DRY (JIJ)>0.5) THEN
        ZDZ=ZDZ_STOP (JIJ)-0.5*(PZZ (JIJ,JK+IKL)-PZZ (JIJ,JK))
        ZTHV (JIJ)=ZTHVM (JIJ,JK)+ZCOEFF_PLUS_HALF (JIJ)*ZDZ
        ZMIXTHL (JIJ)=ZKIC_INIT*(PTHLM (JIJ,JK)+ZDZ*(PTHLM (JIJ,JK+IKL)-PTHLM&
        & (JIJ,JK))/PDZZ (JIJ,JK+IKL))+(1.-ZKIC_INIT)*PTHL_UP (JIJ, JK)
        ZMIXRT (JIJ)=ZKIC_INIT*(PRTM (JIJ,JK)+ZDZ*(PRTM (JIJ,JK+IKL)-PRTM&
        & (JIJ,JK))/PDZZ (JIJ,JK+IKL))+(1.-ZKIC_INIT)*PRT_UP (JIJ, JK)
      ELSEIF (GTEST (JIJ)) THEN
        ZDZ=0.5*(PZZ (JIJ,JK+IKL)-PZZ (JIJ,JK))-ZDZ_STOP (JIJ)
        ZTHV (JIJ)=ZTHVM (JIJ,JK)-ZCOEFF_MINUS_HALF (JIJ)*ZDZ
        ZMIXTHL (JIJ)=ZKIC_INIT*(PTHLM (JIJ,JK)-ZDZ*(PTHLM (JIJ,JK)-PTHLM&
        & (JIJ,JKLIM))/PDZZ (JIJ,JK))+(1.-ZKIC_INIT)*PTHL_UP (JIJ, JK)
        ZMIXRT (JIJ)=ZKIC_INIT*(PRTM (JIJ,JK)-ZDZ*(PRTM (JIJ,JK)-PRTM &
        &(JIJ,JKLIM))/PDZZ (JIJ,JK))+(1.-ZKIC_INIT)*PRT_UP (JIJ, JK)
      ELSE
        ZMIXTHL (JIJ)=300.
        ZMIXRT (JIJ)=0.1
      ENDIF

    ENDDO

    CALL TH_R_FROM_THL_RT_OPENACC (CST, NEBN, D%NIJT, NEBN%CFRAC_ICE_SHALLOW_MF, ZFRAC_ICE&
    &, ZPRE, ZMIXTHL, ZMIXRT, ZTHMIX, ZRVMIX, ZRC_MIX (:, JK), ZRI_MIX (:, JK), ZRSATW_ED&
    &, ZRSATI_ED, OOCEAN=.FALSE., PBUF=ZBUF, KB=D%NIJB, KE=D%NIJE, YDSTACK=YLSTACK)

    DO JIJ=IIJB, IIJE
      ZTHVMIX (JIJ)=ZTHMIX (JIJ)*(1.+ZRVORD*ZRVMIX (JIJ))/(1.+ZMIXRT (JIJ))
      ZMIXTHL (JIJ)=ZKIC_INIT*0.5*(PTHLM (JIJ,JK)+PTHLM (JIJ,JK+IKL))+(1.-ZKIC_INIT)*PTHL_UP (JIJ, JK)
      ZMIXRT (JIJ)=ZKIC_INIT*0.5*(PRTM (JIJ,JK)+PRTM (JIJ,JK+IKL))+(1.-ZKIC_INIT)*PRT_UP (JIJ, JK)
    ENDDO

    CALL TH_R_FROM_THL_RT_OPENACC (CST, NEBN, D%NIJT, NEBN%CFRAC_ICE_SHALLOW_MF, ZFRAC_ICE, ZPRES_F&
    & (:, JK+IKL), ZMIXTHL, ZMIXRT, ZTHMIX, ZRVMIX, ZRC_MIX (:, JK), ZRI_MIX (:, JK), ZRSATW_ED&
    &, ZRSATI_ED, OOCEAN=.FALSE., PBUF=ZBUF, KB=D%NIJB, KE=D%NIJE, YDSTACK=YLSTACK)

    DO JIJ=IIJB, IIJE
      ZTHVMIX_F2 (JIJ)=ZTHMIX (JIJ)*(1.+ZRVORD*ZRVMIX (JIJ))/(1.+ZMIXRT (JIJ))
    ENDDO


    DO JIJ=IIJB, IIJE

      IF (GTEST (JIJ)) THEN

        IF (ABS (PTHV_UP (JIJ, JK)-ZTHVMIX (JIJ))<1.E-10) THEN
          ZKIC (JIJ)=1.
        ELSE
          ZKIC (JIJ)=MAX (0., PTHV_UP (JIJ, JK)-ZTHV (JIJ))*ZKIC_INIT/(PTHV_UP (JIJ, JK)-ZTHVMIX (JIJ))
        ENDIF


        IF (ABS (ZTHV_UP_F2 (JIJ)-ZTHVMIX_F2 (JIJ))<1.E-10) THEN
          ZKIC_F2 (JIJ)=1.
        ELSE
          ZKIC_F2 (JIJ)=MAX (0., ZTHV_UP_F2 (JIJ)-ZTHV_PLUS_HALF &
          &(JIJ))*ZKIC_INIT/(ZTHV_UP_F2 (JIJ)-ZTHVMIX_F2 (JIJ))
        ENDIF

        ZKIC (JIJ)=MAX (MIN (0.5*(ZKIC (JIJ)+ZKIC_F2 (JIJ)), 1.), 0.)
      ENDIF

    ENDDO


    DO JIJ=IIJB, IIJE

      IF (GTEST (JIJ)) THEN
        ZEPSI (JIJ)=ZKIC (JIJ)**2.
        ZDELTA (JIJ)=(1.-ZKIC (JIJ))**2.
      ENDIF

    ENDDO


    DO JIJ=IIJB, IIJE

      IF (GTEST (JIJ)) THEN
        ZEPSI_CLOUD=MIN (ZDELTA (JIJ), ZEPSI (JIJ))
        ZENTR_CLD (JIJ, JK)=(1.-ZPART_DRY (JIJ))*ZCOEFFMF_CLOUD*PRHODREF (JIJ, JK)*ZEPSI_CLOUD
        ZDETR_CLD (JIJ, JK)=(1.-ZPART_DRY (JIJ))*ZCOEFFMF_CLOUD*PRHODREF (JIJ, JK)*ZDELTA (JIJ)
        PENTR (JIJ, JK)=PENTR (JIJ, JK)+ZENTR_CLD (JIJ, JK)
        PDETR (JIJ, JK)=PDETR (JIJ, JK)+ZDETR_CLD (JIJ, JK)
      ELSE
        ZENTR_CLD (JIJ, JK)=0.
        ZDETR_CLD (JIJ, JK)=0.
      ENDIF

    ENDDO


    

    

    DO JIJ=IIJB, IIJE
      PBUO_INTEG (JIJ, JK)=ZBUO_INTEG_DRY (JIJ, JK)+ZBUO_INTEG_CLD (JIJ, JK)

      IF (JK==IKB) THEN
        PDETR (JIJ, JK)=0.
        ZDETR_CLD (JIJ, JK)=0.
      ENDIF


      IF (GTEST (JIJ)) THEN
        ZMIX1 (JIJ)=0.5*(PZZ (JIJ, JK+IKL)-PZZ (JIJ, JK))*(PENTR (JIJ, JK)-PDETR (JIJ, JK))
        PEMF (JIJ, JK+IKL)=PEMF (JIJ, JK)*EXP (2*ZMIX1 (JIJ))
      ENDIF

    ENDDO

  ELSE

    DO JIJ=IIJB, IIJE
      GTEST (JIJ)=(PEMF (JIJ, JK+IKL)>0.)
    ENDDO

  ENDIF


  DO JIJ=IIJB, IIJE

    IF (GTEST (JIJ).AND.(PEMF (JIJ, JK+IKL)<=0.)) THEN
      PEMF (JIJ, JK+IKL)=0.
      KKCTL (JIJ)=JK+IKL
      GTEST (JIJ)=.FALSE.
      PFRAC_ICE_UP (JIJ, JK+IKL)=PFRAC_ICE_UP (JIJ, JK)
      PRSAT_UP (JIJ, JK+IKL)=PRSAT_UP (JIJ, JK)
    ENDIF

  ENDDO


  DO JIJ=IIJB, IIJE

    IF (GTEST (JIJ)) THEN
      ZMIX2 (JIJ)=(PZZ (JIJ, JK+IKL)-PZZ (JIJ, JK))*PENTR (JIJ, JK)
      ZMIX3_CLD (JIJ)=(PZZ (JIJ, JK+IKL)-PZZ (JIJ, JK))*(1.-ZPART_DRY (JIJ))*ZDETR_CLD (JIJ, JK)
      ZMIX2_CLD (JIJ)=(PZZ (JIJ, JK+IKL)-PZZ (JIJ, JK))*(1.-ZPART_DRY (JIJ))*ZENTR_CLD (JIJ, JK)
      PTHL_UP (JIJ, JK+IKL)=(PTHL_UP (JIJ, JK)*(1.-0.5*ZMIX2 (JIJ&
      &))+PTHLM (JIJ, JK)*ZMIX2 (JIJ))/(1.+0.5*ZMIX2 (JIJ))
      PRT_UP (JIJ, JK+IKL)=(PRT_UP (JIJ, JK)*(1.-0.5*ZMIX2 (JIJ&
      &))+PRTM (JIJ, JK)*ZMIX2 (JIJ))/(1.+0.5*ZMIX2 (JIJ))
    ENDIF

  ENDDO


  IF (PARAMMF%LMIXUV) THEN

    IF (JK/=IKB) THEN

      DO JIJ=IIJB, IIJE

        IF (GTEST (JIJ)) THEN
          PU_UP (JIJ, JK+IKL)=(PU_UP (JIJ, JK)*(1-0.5*ZMIX2 (JIJ))+PUM (JIJ, JK)*ZMIX2 (JIJ)+0.5*PARAMMF&
          &%XPRES_UV*(PZZ (JIJ, JK+IKL)-PZZ (JIJ, JK))*((PUM (JIJ, JK+IKL)-PUM (JIJ, JK))/PDZZ (JIJ&
          &, JK+IKL)+(PUM (JIJ, JK)-PUM (JIJ, JK-IKL))/PDZZ (JIJ, JK)))/(1+0.5*ZMIX2 (JIJ))
          PV_UP (JIJ, JK+IKL)=(PV_UP (JIJ, JK)*(1-0.5*ZMIX2 (JIJ))+PVM (JIJ, JK)*ZMIX2 (JIJ)+0.5*PARAMMF&
          &%XPRES_UV*(PZZ (JIJ, JK+IKL)-PZZ (JIJ, JK))*((PVM (JIJ, JK+IKL)-PVM (JIJ, JK))/PDZZ (JIJ&
          &, JK+IKL)+(PVM (JIJ, JK)-PVM (JIJ, JK-IKL))/PDZZ (JIJ, JK)))/(1+0.5*ZMIX2 (JIJ))
        ENDIF

      ENDDO

    ELSE

      DO JIJ=IIJB, IIJE

        IF (GTEST (JIJ)) THEN
          PU_UP (JIJ, JK+IKL)=(PU_UP (JIJ, JK)*(1-0.5*ZMIX2 (JIJ))+PUM (JIJ, JK)*ZMIX2&
          & (JIJ)+0.5*PARAMMF%XPRES_UV*(PZZ (JIJ, JK+IKL)-PZZ (JIJ, JK))*((PUM (JIJ&
          &, JK+IKL)-PUM (JIJ, JK))/PDZZ (JIJ, JK+IKL)))/(1+0.5*ZMIX2 (JIJ))
          PV_UP (JIJ, JK+IKL)=(PV_UP (JIJ, JK)*(1-0.5*ZMIX2 (JIJ))+PVM (JIJ, JK)*ZMIX2&
          & (JIJ)+0.5*PARAMMF%XPRES_UV*(PZZ (JIJ, JK+IKL)-PZZ (JIJ, JK))*((PVM (JIJ&
          &, JK+IKL)-PVM (JIJ, JK))/PDZZ (JIJ, JK+IKL)))/(1+0.5*ZMIX2 (JIJ))
        ENDIF

      ENDDO

    ENDIF

  ENDIF


  DO JSV=1, KSV

    IF (ONOMIXLG.AND.JSV>=KSV_LGBEG.AND.JSV<=KSV_LGEND)  THEN
        CYCLE
    ENDIF


    DO JIJ=IIJB, IIJE

      IF (GTEST (JIJ)) THEN
        PSV_UP (JIJ, JK+IKL, JSV)=(PSV_UP (JIJ, JK, JSV)*(1-0.5*ZMIX2 &
        &(JIJ))+PSVM (JIJ, JK, JSV)*ZMIX2 (JIJ))/(1+0.5*ZMIX2 (JIJ))
      ENDIF

    ENDDO

  ENDDO


  IF (OENTR_DETR) THEN

    DO JIJ=IIJB, IIJE
      ZRC_UP (JIJ)=PRC_UP (JIJ, JK)
      ZRI_UP (JIJ)=PRI_UP (JIJ, JK)
    ENDDO

    CALL TH_R_FROM_THL_RT_OPENACC (CST, NEBN, D%NIJT, NEBN%CFRAC_ICE_SHALLOW_MF, PFRAC_ICE_UP&
    & (:, JK+IKL), ZPRES_F (:, JK+IKL), PTHL_UP (:, JK+IKL), PRT_UP (:, JK+IKL), ZTH_UP&
    & (:, JK+IKL), ZRV_UP (:), ZRC_UP (:), ZRI_UP (:), ZRSATW (:), ZRSATI (:), OOCEAN&
    &=.FALSE., PBUF=ZBUF (:,:), KB=D%NIJB, KE=D%NIJE, YDSTACK=YLSTACK)

    DO JIJ=IIJB, IIJE

      IF (GTEST (JIJ)) THEN
        PRC_UP (JIJ, JK+IKL)=ZRC_UP (JIJ)
        PRV_UP (JIJ, JK+IKL)=ZRV_UP (JIJ)
        PRI_UP (JIJ, JK+IKL)=ZRI_UP (JIJ)
        PRSAT_UP (JIJ, JK+IKL)=ZRSATW (JIJ)*(1-PFRAC_ICE_UP (JIJ&
        &, JK+IKL))+ZRSATI (JIJ)*PFRAC_ICE_UP (JIJ, JK+IKL)
      ENDIF


      IF (GTEST (JIJ)) THEN
        PTHV_UP (JIJ, JK+IKL)=ZTH_UP (JIJ, JK+IKL)*((1+ZRVORD&
        &*PRV_UP (JIJ, JK+IKL))/(1+PRT_UP (JIJ, JK+IKL)))

        IF (ZBUO_INTEG_DRY (JIJ, JK)>0.) THEN
          ZW_UP2 (JIJ, JK+IKL)=ZW_UP2 (JIJ, JK)+2.*(PARAMMF%XABUO-PARAMMF&
          &%XBENTR*PARAMMF%XENTR_DRY)*ZBUO_INTEG_DRY (JIJ, JK)
        ELSE
          ZW_UP2 (JIJ, JK+IKL)=ZW_UP2 (JIJ, JK)+2.*PARAMMF%XABUO*ZBUO_INTEG_DRY (JIJ, JK)
        ENDIF

        ZW_UP2 (JIJ, JK+IKL)=ZW_UP2 (JIJ, JK+IKL)*(1.-(PARAMMF%XBDETR*ZMIX3_CLD (JIJ)+PARAMMF%XBENTR*ZMIX2_CLD&
        & (JIJ)))/(1.+(PARAMMF%XBDETR*ZMIX3_CLD (JIJ)+PARAMMF%XBENTR*ZMIX2_CLD (JIJ)))+2.*(PARAMMF%XABUO)*ZBUO_INTEG_CLD&
        & (JIJ, JK)/(1.+(PARAMMF%XBDETR*ZMIX3_CLD (JIJ)+PARAMMF%XBENTR*ZMIX2_CLD (JIJ)))
      ENDIF


      IF (GTEST (JIJ).AND.(PBUO_INTEG (JIJ, JK)<=0.)) THEN
        KKETL (JIJ)=JK+IKL
        GTESTETL (JIJ)=.TRUE.
      ELSE
        GTESTETL (JIJ)=.FALSE.
      ENDIF


      IF (GTEST (JIJ).AND.((ZW_UP2 (JIJ, JK+IKL)<=0.).OR.(PEMF (JIJ, JK+IKL)<=0.))) THEN
        ZW_UP2 (JIJ, JK+IKL)=0.
        PEMF (JIJ, JK+IKL)=0.
        GTEST (JIJ)=.FALSE.
        PTHL_UP (JIJ, JK+IKL)=ZTHLM_F (JIJ, JK+IKL)
        PRT_UP (JIJ, JK+IKL)=ZRTM_F (JIJ, JK+IKL)
        PRC_UP (JIJ, JK+IKL)=0.
        PRI_UP (JIJ, JK+IKL)=0.
        PRV_UP (JIJ, JK+IKL)=0.
        PTHV_UP (JIJ, JK+IKL)=ZTHVM_F (JIJ, JK+IKL)
        PFRAC_UP (JIJ, JK+IKL)=0.
        KKCTL (JIJ)=JK+IKL
      ENDIF


      IF (GTEST (JIJ)) THEN
        PFRAC_UP (JIJ, JK+IKL)=PEMF (JIJ, JK+IKL)/(SQRT (ZW_UP2 (JIJ, JK+IKL))*ZRHO_F (JIJ, JK+IKL))
      ENDIF


      IF (GTEST (JIJ)) THEN
        PFRAC_UP (JIJ, JK+IKL)=MIN (PARAMMF%XFRAC_UP_MAX, PFRAC_UP (JIJ, JK+IKL))
      ENDIF


      IF ((GTEST (JIJ).AND.GTESTETL (JIJ)).AND.GTESTLCL (JIJ)) THEN
        PFRAC_UP (JIJ, JK+IKL)=MIN (PFRAC_UP (JIJ, JK+IKL), PFRAC_UP (JIJ, JK))
      ENDIF


      IF (OENTR_DETR)  THEN
          PEMF (JIJ, JK+IKL)=PFRAC_UP (JIJ, JK+IKL)*SQRT (ZW_UP2 (JIJ, JK+IKL))*ZRHO_F (JIJ, JK+IKL)
      ENDIF

    ENDDO

  ENDIF

ENDDO


IF (OENTR_DETR) THEN

  DO JK=1, IKT

    DO JIJ=IIJB, IIJE
      PW_UP (JIJ, JK)=SQRT (ZW_UP2 (JIJ, JK))
    ENDDO

  ENDDO


  DO JIJ=IIJB, IIJE
    PEMF (JIJ, IKB)=0.
  ENDDO


  DO JIJ=IIJB, IIJE
    PDEPTH (JIJ)=MAX (0., PZZ (JIJ, KKCTL (JIJ))-PZZ (JIJ, KKLCL (JIJ)))
  ENDDO


  DO JIJ=IIJB, IIJE
    GWORK1 (JIJ)=(GTESTLCL (JIJ).AND.(PDEPTH (JIJ)>ZDEPTH_MAX1))
  ENDDO


  DO JK=1, IKT

    DO JIJ=IIJB, IIJE
      GWORK2 (JIJ, JK)=GWORK1 (JIJ)
      ZCOEF (JIJ, JK)=(1.-(PDEPTH (JIJ)-ZDEPTH_MAX1)/(ZDEPTH_MAX2-ZDEPTH_MAX1))
      ZCOEF (JIJ, JK)=MIN (MAX (ZCOEF (JIJ, JK), 0.), 1.)
    ENDDO

  ENDDO


  DO JK=1, IKT

    DO JIJ=IIJB, IIJE

      IF (GWORK2 (JIJ, JK)) THEN
        PEMF (JIJ, JK)=PEMF (JIJ, JK)*ZCOEF (JIJ, JK)
        PFRAC_UP (JIJ, JK)=PFRAC_UP (JIJ, JK)*ZCOEF (JIJ, JK)
      ENDIF

    ENDDO

  ENDDO

ENDIF




INCLUDE"th_r_from_thl_rt.func.h"
INCLUDE"compute_frac_ice.func.h"

ENDSUBROUTINE COMPUTE_UPDRAFT_OPENACC

ENDMODULE MODE_COMPUTE_UPDRAFT_OPENACC
