
MODULE MODE_COMPUTE_MF_CLOUD_STAT_OPENACC


IMPLICIT NONE


CONTAINS
SUBROUTINE COMPUTE_MF_CLOUD_STAT_OPENACC (D, CST, TURBN, PARAMMF, KRR, KRRL, KRRI, OSTATNW, PFRAC_ICE&
&, PTHLM, PRTM, PPABSM, PRM, PDZZ, PTHM, PEXNM, PEMF, PTHL_UP, PRT_UP, PSIGMF, YDSTACK)
!$ACC ROUTINE (COMPUTE_MF_CLOUD_STAT_OPENACC) SEQ
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODD_CST,ONLY:CST_T
USE MODD_PARAM_MFSHALL_N,ONLY:PARAM_MFSHALL_T
USE MODD_TURB_N,ONLY:TURB_T
USE MODI_SHUMAN_MF_OPENACC,ONLY:MZF_MF_OPENACC, MZM_MF_OPENACC, GZ_M_W_MF_OPENACC
USE MODE_COMPUTE_FUNCTION_THERMO_MF_OPENACC,ONLY:COMPUTE_FUNCTION_THERMO_MF_OPENACC

#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (DIMPHYEX_T), INTENT (IN)::D
TYPE (CST_T), INTENT (IN)::CST
TYPE (TURB_T), INTENT (IN)::TURBN
TYPE (PARAM_MFSHALL_T), INTENT (IN)::PARAMMF
LOGICAL, INTENT (IN)::OSTATNW
INTEGER, INTENT (IN)::KRR
INTEGER, INTENT (IN)::KRRL
INTEGER, INTENT (IN)::KRRI
REAL, INTENT (IN)::PFRAC_ICE(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRTM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHLM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PPABSM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRM(D%NIJT, D%NKT, KRR)
REAL, INTENT (IN)::PDZZ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PEXNM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PEMF(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRT_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHL_UP(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PSIGMF(D%NIJT, D%NKT)
TYPE(STACK), INTENT (IN) :: YDSTACK
TYPE(STACK) :: YLSTACK
REAL::ZFLXZ3(D%NIJT, D%NKT)
REAL::ZFLXZ2(D%NIJT, D%NKT)
REAL::ZFLXZ(D%NIJT, D%NKT)
REAL::ZT(D%NIJT, D%NKT)
REAL::ZATHETA(D%NIJT, D%NKT)
REAL::ZAMOIST(D%NIJT, D%NKT)
REAL::ZWK2(D%NIJT, D%NKT)
REAL::ZWK(D%NIJT, D%NKT)
INTEGER::JK
INTEGER::JIJ
INTEGER::IIJE
INTEGER::IIJB
INTEGER::IKT

INTEGER (KIND=JPIM) :: JLON

YLSTACK = YDSTACK



JLON = KIDIA


IIJE=D%NIJE
IIJB=D%NIJB
IKT=D%NKT
CALL COMPUTE_FUNCTION_THERMO_MF_OPENACC (D, CST, KRR, KRRL, KRRI, OSTATNW, PTHM&
&, PRM, PEXNM, PFRAC_ICE, PPABSM, ZT, ZAMOIST, ZATHETA, YDSTACK=YLSTACK)

IF (KRRL>0) THEN
  CALL MZM_MF_OPENACC (D, PTHLM (:,:), ZFLXZ (:,:), YDSTACK=YLSTACK)
  CALL GZ_M_W_MF_OPENACC (D, PTHLM (:,:), PDZZ (:,:), ZWK (:,:), YDSTACK=YLSTACK)

  IF (OSTATNW) THEN

    DO JK=1, IKT

      DO JIJ=IIJB, IIJE
        ZFLXZ (JIJ, JK)=-2*TURBN%XCTV*PARAMMF%XTAUSIGMF*PEMF (JIJ,&
        & JK)*(PTHL_UP (JIJ, JK)-ZFLXZ (JIJ, JK))*ZWK (JIJ, JK)
      ENDDO

    ENDDO

  ELSE

    DO JK=1, IKT

      DO JIJ=IIJB, IIJE
        ZFLXZ (JIJ, JK)=-2*PARAMMF%XTAUSIGMF*PEMF (JIJ, JK)*&
        &(PTHL_UP (JIJ, JK)-ZFLXZ (JIJ, JK))*ZWK (JIJ, JK)
      ENDDO

    ENDDO

  ENDIF


  DO JK=1, IKT

    DO JIJ=IIJB, IIJE
      ZFLXZ (JIJ, JK)=MAX (0., ZFLXZ (JIJ, JK))
    ENDDO

  ENDDO

  CALL MZF_MF_OPENACC (D, ZFLXZ (:,:), PSIGMF (:,:), YDSTACK=YLSTACK)

  DO JK=1, IKT

    DO JIJ=IIJB, IIJE
      PSIGMF (JIJ, JK)=PSIGMF (JIJ, JK)*ZATHETA (JIJ, JK)**2
    ENDDO

  ENDDO

  CALL MZM_MF_OPENACC (D, PRTM (:,:), ZFLXZ2 (:,:), YDSTACK=YLSTACK)
  CALL GZ_M_W_MF_OPENACC (D, PRTM (:,:), PDZZ (:,:), ZWK2 (:,:), YDSTACK=YLSTACK)

  IF (OSTATNW) THEN

    DO JK=1, IKT

      DO JIJ=IIJB, IIJE
        ZFLXZ2 (JIJ, JK)=-2*TURBN%XCTV*PARAMMF%XTAUSIGMF*PEMF (JIJ,&
        & JK)*(PRT_UP (JIJ, JK)-ZFLXZ2 (JIJ, JK))*ZWK2 (JIJ, JK)
      ENDDO

    ENDDO

  ELSE

    DO JK=1, IKT

      DO JIJ=IIJB, IIJE
        ZFLXZ2 (JIJ, JK)=-2*PARAMMF%XTAUSIGMF*PEMF (JIJ, JK)*&
        &(PRT_UP (JIJ, JK)-ZFLXZ2 (JIJ, JK))*ZWK2 (JIJ, JK)
      ENDDO

    ENDDO

  ENDIF


  DO JK=1, IKT

    DO JIJ=IIJB, IIJE
      ZFLXZ2 (JIJ, JK)=MAX (0., ZFLXZ2 (JIJ, JK))
    ENDDO

  ENDDO

  CALL MZF_MF_OPENACC (D, ZFLXZ2 (:,:), ZWK2 (:,:), YDSTACK=YLSTACK)

  DO JK=1, IKT

    DO JIJ=IIJB, IIJE
      PSIGMF (JIJ, JK)=PSIGMF (JIJ, JK)+ZAMOIST (JIJ, JK)**2*ZWK2 (JIJ, JK)
    ENDDO

  ENDDO


  IF (OSTATNW) THEN

    DO JK=1, IKT

      DO JIJ=IIJB, IIJE
        ZFLXZ3 (JIJ, JK)=-TURBN%XCTV*PARAMMF%XTAUSIGMF*(PEMF (JIJ, JK)*(PRT_UP (JIJ, JK)-ZFLXZ2 (JIJ&
        &, JK))*ZWK (JIJ, JK)+PEMF (JIJ, JK)*(PTHL_UP (JIJ, JK)-ZFLXZ (JIJ, JK))*ZWK2 (JIJ, JK))
      ENDDO

    ENDDO

    CALL MZF_MF_OPENACC (D, ZFLXZ3, ZFLXZ, YDSTACK=YLSTACK)

    DO JK=1, IKT

      DO JIJ=IIJB, IIJE
        PSIGMF (JIJ, JK)=PSIGMF (JIJ, JK)-MIN (0., 2.*ZAMOIST (JIJ, JK)*ZATHETA (JIJ, JK)*ZFLXZ (JIJ, JK))
      ENDDO

    ENDDO

  ENDIF


  DO JK=1, IKT

    DO JIJ=IIJB, IIJE
      PSIGMF (JIJ, JK)=SQRT (MAX (PSIGMF (JIJ, JK), 0.))
    ENDDO

  ENDDO

ELSE
  PSIGMF (:,:)=0.
ENDIF



ENDSUBROUTINE COMPUTE_MF_CLOUD_STAT_OPENACC

ENDMODULE MODE_COMPUTE_MF_CLOUD_STAT_OPENACC
