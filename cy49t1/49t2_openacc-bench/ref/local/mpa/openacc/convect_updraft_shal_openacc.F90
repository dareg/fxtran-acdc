
SUBROUTINE CONVECT_UPDRAFT_SHAL_OPENACC (CVP_SHAL, CVPEXT, CST, D, CONVPAR, KICE, PPRES, PDPRES, PZ&
&, PTHL, PTHV, PTHES, PRW, PTHLCL, PTLCL, PRVLCL, PWLCL, PZLCL, PTHVELCL, PMFLCL, OTRIG, KLCL, KDPL&
&, KPBL, PUMF, PUER, PUDR, PUTHL, PUTHV, PURW, PURC, PURI, PCAPE, KCTL, KETL, GTRIG1, YDSTACK)
!$ACC ROUTINE (CONVECT_UPDRAFT_SHAL_OPENACC) SEQ

USE MODD_CST,ONLY:CST_T
USE MODD_CONVPAR,ONLY:CONVPAR_T
USE MODD_CONVPAR_SHAL,ONLY:CONVPAR_SHAL
USE MODD_CONVPAREXT,ONLY:CONVPAREXT
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (CONVPAR_SHAL), INTENT (IN)::CVP_SHAL
TYPE (CONVPAREXT), INTENT (IN)::CVPEXT
TYPE (CST_T), INTENT (IN)::CST
TYPE (DIMPHYEX_T), INTENT (IN)::D
TYPE (CONVPAR_T), INTENT (IN)::CONVPAR
INTEGER, INTENT (IN)::KICE
REAL, INTENT (IN)::PPRES(D%NIT, D%NKT)
REAL, INTENT (IN)::PDPRES(D%NIT, D%NKT)
REAL, INTENT (IN)::PZ(D%NIT, D%NKT)
REAL, INTENT (IN)::PTHL(D%NIT, D%NKT)
REAL, INTENT (IN)::PTHV(D%NIT, D%NKT)
REAL, INTENT (IN)::PTHES(D%NIT, D%NKT)
REAL, INTENT (IN)::PRW(D%NIT, D%NKT)
REAL, INTENT (IN)::PTHLCL(D%NIT)
REAL, INTENT (IN)::PTLCL(D%NIT)
REAL, INTENT (IN)::PRVLCL(D%NIT)
REAL, INTENT (IN)::PWLCL(D%NIT)
REAL, INTENT (IN)::PZLCL(D%NIT)
REAL, INTENT (IN)::PTHVELCL(D%NIT)
REAL, INTENT (IN)::PMFLCL
LOGICAL, INTENT (INOUT)::OTRIG(D%NIT)
INTEGER, INTENT (IN)::KLCL(D%NIT)
INTEGER, INTENT (IN)::KDPL(D%NIT)
INTEGER, INTENT (IN)::KPBL(D%NIT)
REAL, INTENT (OUT)::PUMF(D%NIT, D%NKT)
REAL, INTENT (OUT)::PUER(D%NIT, D%NKT)
REAL, INTENT (OUT)::PUDR(D%NIT, D%NKT)
REAL, INTENT (OUT)::PUTHL(D%NIT, D%NKT)
REAL, INTENT (OUT)::PUTHV(D%NIT, D%NKT)
REAL, INTENT (OUT)::PURW(D%NIT, D%NKT)
REAL, INTENT (OUT)::PURC(D%NIT, D%NKT)
REAL, INTENT (OUT)::PURI(D%NIT, D%NKT)
REAL, INTENT (OUT)::PCAPE(D%NIT)
INTEGER, INTENT (OUT)::KCTL(D%NIT)
INTEGER, INTENT (OUT)::KETL(D%NIT)
LOGICAL, INTENT (IN)::GTRIG1(D%NIT)
TYPE(STACK), INTENT (IN) :: YDSTACK
TYPE(STACK) :: YLSTACK
INTEGER::IKE
INTEGER::IKB
INTEGER::JI
INTEGER::JK2
INTEGER::JK1
INTEGER::JKM
INTEGER::JKP
INTEGER::JK
REAL::ZEPSA
REAL::ZRDOCP
REAL::ZUT(D%NIT)
REAL::ZUW2(D%NIT)
REAL::ZUW1(D%NIT)
REAL::ZD2(D%NIT)
REAL::ZD1(D%NIT)
REAL::ZE2(D%NIT)
REAL::ZE1(D%NIT)
REAL::ZMIXF(D%NIT)
REAL::ZCPH(D%NIT)
REAL::ZLS(D%NIT)
REAL::ZLV(D%NIT)
REAL::ZURV(D%NIT)
REAL::ZPI(D%NIT)
REAL::ZTHEUL(D%NIT)
REAL::ZWORK6(D%NIT)
REAL::ZWORK5(D%NIT)
REAL::ZWORK4(D%NIT)
REAL::ZWORK3(D%NIT)
REAL::ZWORK2(D%NIT)
REAL::ZWORK1(D%NIT)
INTEGER::IWORK(D%NIT)
LOGICAL::GWORK4(D%NIT)
LOGICAL::GWORK2(D%NIT)
LOGICAL::GWORK1(D%NIT)

#include "convect_condens_openacc.h"
#include "convect_mixing_funct_openacc.h"
INTEGER (KIND=JPIM) :: JLON

YLSTACK = YDSTACK



JLON = KIDIA


IKB=1+CVPEXT%JCVEXB
IKE=D%NKT-CVPEXT%JCVEXT
ZEPSA=CST%XRV/CST%XRD
ZRDOCP=CST%XRD/CST%XCPD
PUMF (:,:)=0.
PUER (:,:)=0.
PUDR (:,:)=0.
PUTHL (:,:)=0.
PUTHV (:,:)=0.
PURW (:,:)=0.
PURC (:,:)=0.
PURI (:,:)=0.
ZUW1 (:)=PWLCL (:)*PWLCL (:)
ZUW2 (:)=0.
ZE1 (:)=0.
ZD1 (:)=0.
PCAPE (:)=0.
KCTL (:)=IKB
KETL (:)=KLCL (:)
GWORK2 (:)=.TRUE.
ZPI (:)=1.
ZWORK3 (:)=0.
ZWORK4 (:)=0.
ZWORK5 (:)=0.
ZWORK6 (:)=0.
GWORK1 (:)=.FALSE.
GWORK4 (:)=.FALSE.

DO JI=D%NIB, D%NIE
  ZTHEUL (JI)=PTLCL (JI)*(PTHLCL (JI)/PTLCL (JI))**(1.-0.28*PRVLCL (JI))*EXP&
  & ((3374.6525/PTLCL (JI)-2.5403)*PRVLCL (JI)*(1.+0.81*PRVLCL (JI)))
  ZWORK1 (JI)=(CST%XCPD+PRVLCL (JI)*CST%XCPV)*PTLCL (JI)+(1.+PRVLCL (JI))*CST%XG*PZLCL (JI)
ENDDO

JKP=IKE
JKM=IKB

DO JK=JKM, JKP

  DO JI=D%NIB, D%NIE

    IF (JK>=KDPL (JI).AND.JK<KLCL (JI)) THEN
      PUMF (JI, JK)=PMFLCL
      PUTHL (JI, JK)=ZWORK1 (JI)
      PUTHV (JI, JK)=PTHLCL (JI)*(1.+ZEPSA*PRVLCL (JI))/(1.+PRVLCL (JI))
      PURW (JI, JK)=PRVLCL (JI)
    ENDIF

  ENDDO

ENDDO


DO JK=IKB+1, IKE-1
  ZWORK6 (:)=1.
  JKP=JK+1

  DO JI=D%NIB, D%NIE
    GWORK4 (JI)=JK>=KLCL (JI)-1
    GWORK1 (JI)=GWORK4 (JI).AND.GWORK2 (JI)
  ENDDO


  DO JI=D%NIB, D%NIE

    IF (JK==KLCL (JI)-1)  THEN
        ZWORK6 (JI)=0.
    ENDIF

  ENDDO

  ZWORK1 (:)=PURC (:, JK)
  ZWORK2 (:)=PURI (:, JK)
  CALL CONVECT_CONDENS_OPENACC (CST, D, CONVPAR, KICE, PPRES (:, JKP), PUTHL (:, JK), PURW (:, JK), ZWORK1&
  &, ZWORK2, PZ (:, JKP), ZUT, ZURV, PURC (:, JKP), PURI (:, JKP), ZLV, ZLS, ZCPH, YDSTACK=YLSTACK)

  DO JI=D%NIB, D%NIE
    ZPI (JI)=(CST%XP00/PPRES (JI, JKP))**ZRDOCP
  ENDDO


  DO JI=D%NIB, D%NIE

    IF (GWORK1 (JI)) THEN
      PUTHV (JI, JKP)=ZPI (JI)*ZUT (JI)*(1.+ZEPSA*ZURV (JI))/(1.+PURW (JI, JK))
      ZWORK3 (JI)=PZ (JI, JKP)-PZ (JI, JK)*ZWORK6 (JI)-(1.-ZWORK6 (JI))*PZLCL (JI)
      ZWORK4 (JI)=PTHV (JI, JK)*ZWORK6 (JI)+(1.-ZWORK6 (JI))*PTHVELCL (JI)
      ZWORK5 (JI)=2.*ZUW1 (JI)*PUER (JI, JK)/MAX (.1, PUMF (JI, JK))
      ZUW2 (JI)=ZUW1 (JI)+ZWORK3 (JI)*CVP_SHAL%XNHGAM*CST%XG*((PUTHV (JI, JK&
      &)+PUTHV (JI, JKP))/(ZWORK4 (JI)+PTHV (JI, JKP))-1.)-ZWORK5 (JI)
      ZWORK2 (JI)=0.5*(SQRT (MAX (1.E-2, ZUW2 (JI)))+SQRT (MAX (1.E-2, ZUW1 (JI))))
      PURW (JI, JKP)=PURW (JI, JK)
      PURC (JI, JKP)=PURC (JI, JKP)
      PURI (JI, JKP)=PURI (JI, JKP)
      PUTHL (JI, JKP)=PUTHL (JI, JK)
      ZUW1 (JI)=ZUW2 (JI)
    ENDIF

  ENDDO


  DO JI=D%NIB, D%NIE
    ZMIXF (JI)=0.1
    ZWORK1 (JI)=ZMIXF (JI)*PTHL (JI, JKP)+(1.-ZMIXF (JI))*PUTHL (JI, JKP)
    ZWORK2 (JI)=ZMIXF (JI)*PRW (JI, JKP)+(1.-ZMIXF (JI))*PURW (JI, JKP)
  ENDDO

  CALL CONVECT_CONDENS_OPENACC (CST, D, CONVPAR, KICE, PPRES (:, JKP), ZWORK1, ZWORK2, PURC (:, JKP&
  &), PURI (:, JKP), PZ (:, JKP), ZUT, ZWORK3, ZWORK4, ZWORK5, ZLV, ZLS, ZCPH, YDSTACK=YLSTACK)

  DO JI=D%NIB, D%NIE
    ZWORK3 (JI)=ZUT (JI)*ZPI (JI)*(1.+ZEPSA*(ZWORK2 (JI)-ZWORK4 (JI)-ZWORK5 (JI)))/(1.+ZWORK2 (JI))
    ZMIXF (JI)=MAX (0., PUTHV (JI, JKP)-PTHV (JI, JKP))*ZMIXF (JI)/(PUTHV (JI, JKP)-ZWORK3 (JI)+1.E-10)
    ZMIXF (JI)=MAX (0., MIN (1., ZMIXF (JI)))
  ENDDO

  CALL CONVECT_MIXING_FUNCT_OPENACC (D, ZMIXF, 1, ZE2, ZD2, YDSTACK=YLSTACK)
  ZE2=MIN (ZD2, MAX (.3, ZE2))

  DO JI=D%NIB, D%NIE
    ZWORK1 (JI)=CVP_SHAL%XENTR*CST%XG/CVP_SHAL%XCRAD*PUMF (JI, JK)*(PZ (JI, JKP)-PZ (JI, JK))
  ENDDO

  ZWORK2 (:)=0.

  DO JI=D%NIB, D%NIE

    IF (GWORK1 (JI))  THEN
        ZWORK2 (JI)=1.
    ENDIF

  ENDDO


  DO JI=D%NIB, D%NIE

    IF (PUTHV (JI, JKP)>PTHV (JI, JKP)) THEN
      PUER (JI, JKP)=0.5*ZWORK1 (JI)*(ZE1 (JI)+ZE2 (JI))*ZWORK2 (JI)
      PUDR (JI, JKP)=0.5*ZWORK1 (JI)*(ZD1 (JI)+ZD2 (JI))*ZWORK2 (JI)
    ELSE
      PUER (JI, JKP)=0.
      PUDR (JI, JKP)=ZWORK1 (JI)*ZWORK2 (JI)
    ENDIF

  ENDDO


  DO JI=D%NIB, D%NIE

    IF (PUTHV (JI, JKP)>PTHV (JI, JKP).AND.JK>KLCL (JI)+1.AND.GWORK1 (JI)) THEN
      KETL (JI)=JKP
    ENDIF

  ENDDO


  DO JI=D%NIB, D%NIE

    IF (GWORK1 (JI)) THEN
      GWORK2 (JI)=PUMF (JI, JK)-PUDR (JI, JKP)>10..AND.ZUW2 (JI)>0.
    ENDIF

  ENDDO


  DO JI=D%NIB, D%NIE

    IF (GWORK2 (JI))  THEN
        KCTL (JI)=JKP
    ENDIF

  ENDDO


  DO JI=D%NIB, D%NIE
    GWORK1 (JI)=GWORK2 (JI).AND.GWORK4 (JI)
  ENDDO


  DO JI=D%NIB, D%NIE

    IF (GWORK1 (JI)) THEN
      ZWORK3 (JI)=PZ (JI, JKP)-PZ (JI, JK)*ZWORK6 (JI)-(1.-ZWORK6 (JI))*PZLCL (JI)
      ZWORK2 (JI)=PTHES (JI, JK)+(1.-ZWORK6 (JI))*(PTHES (JI, JKP)-PTHES&
      & (JI, JK))/(PZ (JI, JKP)-PZ (JI, JK))*(PZLCL (JI)-PZ (JI, JK))
      ZWORK1 (JI)=(2.*ZTHEUL (JI))/(ZWORK2 (JI)+PTHES (JI, JKP))-1.
      PCAPE (JI)=PCAPE (JI)+CST%XG*ZWORK3 (JI)*MAX (0., ZWORK1 (JI))
      PUMF (JI, JKP)=PUMF (JI, JK)-PUDR (JI, JKP)+PUER (JI, JKP)
      PUMF (JI, JKP)=MAX (PUMF (JI, JKP), 0.1)
      PUTHL (JI, JKP)=(PUMF (JI, JK)*PUTHL (JI, JK)+PUER (JI, JKP)*PTHL&
      & (JI, JK)-PUDR (JI, JKP)*PUTHL (JI, JK))/PUMF (JI, JKP)
      PURW (JI, JKP)=(PUMF (JI, JK)*PURW (JI, JK)+PUER (JI, JKP)*PRW&
      & (JI, JK)-PUDR (JI, JKP)*PURW (JI, JK))/PUMF (JI, JKP)
      ZE1 (JI)=ZE2 (JI)
      ZD1 (JI)=ZD2 (JI)
    ENDIF

  ENDDO

ENDDO


DO JI=D%NIB, D%NIE
  JK=KCTL (JI)
  ZWORK1 (JI)=PZ (JI, JK)-PZLCL (JI)
  OTRIG (JI)=ZWORK1 (JI)>=CVP_SHAL%XCDEPTH.AND.ZWORK1 (JI)<CVP_SHAL%XCDEPTH_D.AND.PCAPE (JI)>1.
ENDDO


DO JI=D%NIB, D%NIE

  IF (.NOT.OTRIG (JI))  THEN
      KCTL (JI)=IKB
  ENDIF

ENDDO


DO JI=D%NIB, D%NIE
  KETL (JI)=MAX (KETL (JI), KLCL (JI)+2)
  KETL (JI)=MIN (KETL (JI), KCTL (JI))
ENDDO

ZWORK1 (:)=0.

DO JI=D%NIB, D%NIE

  IF (KETL (JI)==KCTL (JI))  THEN
      ZWORK1 (JI)=1.
  ENDIF

ENDDO


DO JI=D%NIB, D%NIE
  JK=KETL (JI)
  PUDR (JI, JK)=PUDR (JI, JK)+(PUMF (JI, JK)-PUER (JI, JK))*ZWORK1 (JI)
  PUER (JI, JK)=PUER (JI, JK)*(1.-ZWORK1 (JI))
  PUMF (JI, JK)=PUMF (JI, JK)*(1.-ZWORK1 (JI))
  JKP=KCTL (JI)+1
  PUER (JI, JKP)=0.
  PUDR (JI, JKP)=0.
  PURW (JI, JKP)=0.
  PURC (JI, JKP)=0.
  PURI (JI, JKP)=0.
  PUTHL (JI, JKP)=0.
  PURC (JI, JKP+1)=0.
  PURI (JI, JKP+1)=0.
ENDDO

ZWORK1 (:)=0.
JK1=IKB
JK2=IKE

DO JK=JK1, JK2

  DO JI=D%NIB, D%NIE

    IF (JK>KETL (JI).AND.JK<=KCTL (JI)) THEN
      ZWORK1 (JI)=ZWORK1 (JI)+PDPRES (JI, JK)
    ENDIF

  ENDDO

ENDDO


DO JI=D%NIB, D%NIE
  JK=KETL (JI)
  ZWORK1 (JI)=PUMF (JI, JK)/MAX (1., ZWORK1 (JI))
ENDDO


DO JK=JK1+1, JK2
  JKP=JK-1

  DO JI=D%NIB, D%NIE

    IF (JK>KETL (JI).AND.JK<=KCTL (JI)) THEN
      PUDR (JI, JK)=PDPRES (JI, JK)*ZWORK1 (JI)
      PUMF (JI, JK)=PUMF (JI, JKP)-PUDR (JI, JK)
    ENDIF

  ENDDO

ENDDO

IWORK (:)=KPBL (:)

DO JI=D%NIB, D%NIE
  JK=KDPL (JI)
  JKP=IWORK (JI)
  ZWORK2 (JI)=PPRES (JI, JK)-PPRES (JI, JKP)+PDPRES (JI, JK)
ENDDO

JKP=IKE

DO JK=JKM, JKP

  DO JI=D%NIB, D%NIE

    IF (JK>=KDPL (JI).AND.JK<=IWORK (JI).AND.GTRIG1 (JI)) THEN
      PUER (JI, JK)=PUER (JI, JK)+PMFLCL*PDPRES (JI, JK)/(ZWORK2 (JI)+0.1)
      PUMF (JI, JK)=PUMF (JI, JK-1)+PUER (JI, JK)
    ENDIF

  ENDDO

ENDDO


DO JK=1, D%NKT

  DO JI=D%NIB, D%NIE

    IF (.NOT.OTRIG (JI)) THEN
      PUMF (JI, JK)=0.
      PUDR (JI, JK)=0.
      PUER (JI, JK)=0.
      PUTHL (JI, JK)=PTHL (JI, JK)
      PURW (JI, JK)=PRW (JI, JK)
      PURC (JI, JK)=0.
      PURI (JI, JK)=0.
    ENDIF

  ENDDO

ENDDO



ENDSUBROUTINE CONVECT_UPDRAFT_SHAL_OPENACC
