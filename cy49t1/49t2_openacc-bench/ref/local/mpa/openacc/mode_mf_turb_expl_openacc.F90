
MODULE MODE_MF_TURB_EXPL_OPENACC


IMPLICIT NONE


CONTAINS
SUBROUTINE MF_TURB_EXPL_OPENACC (D, PARAMMF, PRHODJ, PTHLM, PTHVM, PRTM, PUM&
&, PVM, PTHLDT, PRTDT, PUDT, PVDT, PEMF, PTHL_UP, PTHV_UP, PRT_UP, PU_UP, PV_UP&
&, PFLXZTHLMF, PFLXZTHVMF, PFLXZRMF, PFLXZUMF, PFLXZVMF, YDSTACK)
!$ACC ROUTINE (MF_TURB_EXPL_OPENACC) SEQ
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODD_PARAM_MFSHALL_N,ONLY:PARAM_MFSHALL_T

USE MODI_SHUMAN_MF_OPENACC,ONLY:MZM_MF_OPENACC
#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (DIMPHYEX_T), INTENT (IN)::D
TYPE (PARAM_MFSHALL_T), INTENT (IN)::PARAMMF
REAL, INTENT (IN)::PRHODJ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHLM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRTM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHVM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PUM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PVM(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PTHLDT(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PRTDT(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PUDT(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PVDT(D%NIJT, D%NKT)
REAL, INTENT (IN)::PV_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PU_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRT_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHV_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHL_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PEMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZVMF(D%NIJT, D%NKT)
TYPE(STACK), INTENT (IN) :: YDSTACK
TYPE(STACK) :: YLSTACK
REAL, INTENT (OUT)::PFLXZUMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZRMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZTHVMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZTHLMF(D%NIJT, D%NKT)
REAL::ZTHSM(D%NIJT, D%NKT)
REAL::ZTHS_UP(D%NIJT, D%NKT)
REAL::ZFLXZTHSMF(D%NIJT, D%NKT)
REAL::ZQTDT(D%NIJT, D%NKT)
REAL::ZTHSDT(D%NIJT, D%NKT)
REAL::ZQTM(D%NIJT, D%NKT)
REAL::ZQT_UP(D%NIJT, D%NKT)
REAL::ZRTM_F(D%NIJT, D%NKT)
REAL::ZTHLM_F(D%NIJT, D%NKT)
INTEGER::JIJ
INTEGER::JK
INTEGER::IIJE
INTEGER::IIJB
INTEGER::IKL
INTEGER::IKE
INTEGER::IKB
INTEGER::IKT

INTEGER (KIND=JPIM) :: JLON

YLSTACK = YDSTACK



JLON = KIDIA


IIJE=D%NIJE
IIJB=D%NIJB
IKT=D%NKT
IKB=D%NKB
IKE=D%NKE
IKL=D%NKL
PFLXZRMF=0.
PFLXZTHVMF=0.
PFLXZTHLMF=0.
PFLXZUMF=0.
PFLXZVMF=0.
PTHLDT=0.
PRTDT=0.
PUDT=0.
PVDT=0.
CALL MZM_MF_OPENACC (D, PRTM (:,:), ZRTM_F (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PTHLM (:,:), ZTHLM_F (:,:), YDSTACK=YLSTACK)

DO JK=1, IKT

  DO JIJ=IIJB, IIJE
    ZQTM (JIJ, JK)=ZRTM_F (JIJ, JK)/(1.+ZRTM_F (JIJ, JK))
    ZQT_UP (JIJ, JK)=PRT_UP (JIJ, JK)/(1.+PRT_UP (JIJ, JK))
    ZTHS_UP (JIJ, JK)=PTHL_UP (JIJ, JK)*(1.+PARAMMF%XLAMBDA_MF*ZQT_UP (JIJ, JK))
    ZTHSM (JIJ, JK)=ZTHLM_F (JIJ, JK)*(1.+PARAMMF%XLAMBDA_MF*ZQTM (JIJ, JK))
  ENDDO

ENDDO

CALL MZM_MF_OPENACC (D, PTHLM (:,:), PFLXZTHLMF (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PRTM (:,:), PFLXZRMF (:,:), YDSTACK=YLSTACK)
CALL MZM_MF_OPENACC (D, PTHVM (:,:), PFLXZTHVMF (:,:), YDSTACK=YLSTACK)

DO JK=1, IKT

  DO JIJ=IIJB, IIJE
    PFLXZTHLMF (JIJ, JK)=PEMF (JIJ, JK)*(PTHL_UP (JIJ, JK)-PFLXZTHLMF (JIJ, JK))
    PFLXZRMF (JIJ, JK)=PEMF (JIJ, JK)*(PRT_UP (JIJ, JK)-PFLXZRMF (JIJ, JK))
    PFLXZTHVMF (JIJ, JK)=PEMF (JIJ, JK)*(PTHV_UP (JIJ, JK)-PFLXZTHVMF (JIJ, JK))
    ZFLXZTHSMF (JIJ, JK)=PEMF (JIJ, JK)*(ZTHS_UP (JIJ, JK)-ZTHSM (JIJ, JK))
  ENDDO

ENDDO


IF (PARAMMF%LMIXUV) THEN
  CALL MZM_MF_OPENACC (D, PUM (:,:), PFLXZUMF (:,:), YDSTACK=YLSTACK)
  CALL MZM_MF_OPENACC (D, PVM (:,:), PFLXZVMF (:,:), YDSTACK=YLSTACK)

  DO JK=1, IKT

    DO JIJ=IIJB, IIJE
      PFLXZUMF (JIJ, JK)=PEMF (JIJ, JK)*(PU_UP (JIJ, JK)-PFLXZUMF (JIJ, JK))
      PFLXZVMF (JIJ, JK)=PEMF (JIJ, JK)*(PV_UP (JIJ, JK)-PFLXZVMF (JIJ, JK))
    ENDDO

  ENDDO

ELSE
  PFLXZUMF (:,:)=0.
  PFLXZVMF (:,:)=0.
ENDIF


DO JK=IKB, IKE-IKL, IKL

  DO JIJ=IIJB, IIJE
    PRTDT (JIJ, JK)=(PFLXZRMF (JIJ, JK)-PFLXZRMF (JIJ, JK+IKL))/PRHODJ (JIJ, JK)
    ZQTDT (JIJ, JK)=PRTDT (JIJ, JK)/(1.+ZRTM_F (JIJ, JK)*ZRTM_F (JIJ, JK))
    ZTHSDT (JIJ, JK)=(ZFLXZTHSMF (JIJ, JK)-ZFLXZTHSMF (JIJ, JK+IKL))/PRHODJ (JIJ, JK)
    PTHLDT (JIJ, JK)=ZTHSDT (JIJ, JK)/(1.+PARAMMF%XLAMBDA_MF*ZQTM (JIJ&
    &, JK))-ZTHLM_F (JIJ, JK)*PARAMMF%XLAMBDA_MF*ZQTDT (JIJ, JK)
  ENDDO

ENDDO


IF (PARAMMF%LMIXUV) THEN

  DO JK=IKB, IKE-IKL, IKL

    DO JIJ=IIJB, IIJE
      PUDT (JIJ, JK)=(PFLXZUMF (JIJ, JK)-PFLXZUMF (JIJ, JK+IKL))/PRHODJ (JIJ, JK)
      PVDT (JIJ, JK)=(PFLXZVMF (JIJ, JK)-PFLXZVMF (JIJ, JK+IKL))/PRHODJ (JIJ, JK)
    ENDDO

  ENDDO

ENDIF



ENDSUBROUTINE MF_TURB_EXPL_OPENACC

ENDMODULE MODE_MF_TURB_EXPL_OPENACC
