
MODULE MODE_THL_RT_FROM_TH_R_MF_OPENACC


IMPLICIT NONE


CONTAINS
SUBROUTINE THL_RT_FROM_TH_R_MF_OPENACC (D, CST, KRR, KRRL, KRRI, PTH, PR, PEXN, PTHL, PRT, YDSTACK)
!$ACC ROUTINE (THL_RT_FROM_TH_R_MF_OPENACC) SEQ
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODD_CST,ONLY:CST_T

#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (DIMPHYEX_T), INTENT (IN)::D
TYPE (CST_T), INTENT (IN)::CST
INTEGER, INTENT (IN)::KRR
INTEGER, INTENT (IN)::KRRL
INTEGER, INTENT (IN)::KRRI
REAL, INTENT (IN)::PTH(D%NIJT, D%NKT)
REAL, INTENT (IN)::PR(D%NIJT, D%NKT, KRR)
REAL, INTENT (IN)::PEXN(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PTHL(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PRT(D%NIJT, D%NKT)
TYPE(STACK), INTENT (IN) :: YDSTACK
REAL::ZT(D%NIJT, D%NKT)
REAL::ZCP(D%NIJT, D%NKT)
REAL::ZLSOCPEXN(D%NIJT, D%NKT)
REAL::ZLVOCPEXN(D%NIJT, D%NKT)
INTEGER::JK
INTEGER::JIJ
INTEGER::JRR
INTEGER::IIJE
INTEGER::IIJB
INTEGER::IKT

INTEGER (KIND=JPIM) :: JLON

JLON = KIDIA


IIJE=D%NIJE
IIJB=D%NIJB
IKT=D%NKT

DO JK=1, IKT

  DO JIJ=IIJB, IIJE
    ZT (JIJ, JK)=PTH (JIJ, JK)*PEXN (JIJ, JK)
    ZCP (JIJ, JK)=CST%XCPD

    IF (KRR>0)  THEN
        ZCP (JIJ, JK)=ZCP (JIJ, JK)+CST%XCPV*PR (JIJ, JK, 1)
    ENDIF

  ENDDO

ENDDO


DO JRR=2, 1+KRRL

  DO JK=1, IKT

    DO JIJ=IIJB, IIJE
      ZCP (JIJ, JK)=ZCP (JIJ, JK)+CST%XCL*PR (JIJ, JK, JRR)
    ENDDO

  ENDDO

ENDDO


DO JRR=2+KRRL, 1+KRRL+KRRI

  DO JK=1, IKT

    DO JIJ=IIJB, IIJE
      ZCP (JIJ, JK)=ZCP (JIJ, JK)+CST%XCI*PR (JIJ, JK, JRR)
    ENDDO

  ENDDO

ENDDO


IF (KRRL>=1) THEN

  IF (KRRI>=1) THEN

    DO JK=1, IKT

      DO JIJ=IIJB, IIJE
        ZLVOCPEXN (JIJ, JK)=(CST%XLVTT+(CST%XCPV-CST%XCL)*(ZT&
        & (JIJ, JK)-CST%XTT))/ZCP (JIJ, JK)/PEXN (JIJ, JK)
        ZLSOCPEXN (JIJ, JK)=(CST%XLSTT+(CST%XCPV-CST%XCI)*(ZT&
        & (JIJ, JK)-CST%XTT))/ZCP (JIJ, JK)/PEXN (JIJ, JK)
        PRT (JIJ, JK)=PR (JIJ, JK, 1)+PR (JIJ, JK, 2)+PR (JIJ, JK, 4)
        PTHL (JIJ, JK)=PTH (JIJ, JK)-ZLVOCPEXN (JIJ, JK)*PR (JIJ, JK, 2)-ZLSOCPEXN (JIJ, JK)*PR (JIJ, JK, 4)
      ENDDO

    ENDDO

  ELSE

    DO JK=1, IKT

      DO JIJ=IIJB, IIJE
        ZLVOCPEXN (JIJ, JK)=(CST%XLVTT+(CST%XCPV-CST%XCL)*(ZT&
        & (JIJ, JK)-CST%XTT))/ZCP (JIJ, JK)/PEXN (JIJ, JK)
        PRT (JIJ, JK)=PR (JIJ, JK, 1)+PR (JIJ, JK, 2)
        PTHL (JIJ, JK)=PTH (JIJ, JK)-ZLVOCPEXN (JIJ, JK)*PR (JIJ, JK, 2)
      ENDDO

    ENDDO

  ENDIF

ELSE

  DO JK=1, IKT

    DO JIJ=IIJB, IIJE
      PRT (JIJ, JK)=PR (JIJ, JK, 1)
      PTHL (JIJ, JK)=PTH (JIJ, JK)
    ENDDO

  ENDDO

ENDIF



ENDSUBROUTINE THL_RT_FROM_TH_R_MF_OPENACC

ENDMODULE MODE_THL_RT_FROM_TH_R_MF_OPENACC
