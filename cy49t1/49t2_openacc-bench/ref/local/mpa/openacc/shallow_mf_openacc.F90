
SUBROUTINE SHALLOW_MF_OPENACC (D, CST, NEBN, PARAMMF, TURBN, CSTURB, KRR, KRRL, KRRI, KSV, ONOMIXLG&
&, KSV_LGBEG, KSV_LGEND, PTSTEP, PDZZ, PZZ, PRHODJ, PRHODREF, PPABSM, PEXNM, PSFTH, PSFRV, PTHM&
&, PRM, PUM, PVM, PTKEM, PSVM, PDUDT_MF, PDVDT_MF, PDTHLDT_MF, PDRTDT_MF, PDSVDT_MF, PSIGMF,&
& PRC_MF, PRI_MF, PCF_MF, PFLXZTHVMF, PFLXZTHMF, PFLXZRMF, PFLXZUMF, PFLXZVMF, PTHL_UP, PRT_UP&
&, PRV_UP, PRC_UP, PRI_UP, PU_UP, PV_UP, PTHV_UP, PW_UP, PFRAC_UP, PEMF, PDETR, PENTR, KKLCL&
&, KKETL, KKCTL, PDX, PDY, PRSVS, PSVMIN, BUCONF, TBUDGETS, KBUDGETS, YDSTACK)
!$ACC ROUTINE (SHALLOW_MF_OPENACC) SEQ
USE MODE_SHUMAN_PHY,ONLY:MXM_PHY, MYM_PHY

USE MODD_BUDGET,ONLY:TBUDGETCONF_T, TBUDGETDATA, NBUDGET_U&
&, NBUDGET_V, NBUDGET_TH, NBUDGET_RV, NBUDGET_SV1
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODD_CST,ONLY:CST_T
USE MODD_NEB_N,ONLY:NEB_T
USE MODD_PARAM_MFSHALL_N,ONLY:PARAM_MFSHALL_T
USE MODD_TURB_N,ONLY:TURB_T
USE MODD_CTURB,ONLY:CSTURB_T
USE MODD_PARAMETERS,ONLY:JPSVMAX
USE MODE_BUDGET_PHY,ONLY:BUDGET_STORE_ADD_PHY
USE MODE_COMPUTE_MF_CLOUD_OPENACC,ONLY:COMPUTE_MF_CLOUD_OPENACC
USE MODE_COMPUTE_UPDRAFT_OPENACC,ONLY:COMPUTE_UPDRAFT_OPENACC
USE MODE_COMPUTE_UPDRAFT_RAHA_OPENACC,ONLY:COMPUTE_UPDRAFT_RAHA_OPENACC
USE MODE_COMPUTE_UPDRAFT_RHCJ10_OPENACC,ONLY:COMPUTE_UPDRAFT_RHCJ10_OPENACC
USE MODE_MF_TURB_OPENACC,ONLY:MF_TURB_OPENACC
USE MODE_MF_TURB_EXPL_OPENACC,ONLY:MF_TURB_EXPL_OPENACC
USE MODE_MSG_OPENACC,ONLY:PRINT_MSG_OPENACC, NVERB_FATAL
USE MODE_THL_RT_FROM_TH_R_MF_OPENACC,ONLY:THL_RT_FROM_TH_R_MF_OPENACC
#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (DIMPHYEX_T), INTENT (IN)::D
TYPE (CST_T), INTENT (IN)::CST
TYPE (NEB_T), INTENT (IN)::NEBN
TYPE (PARAM_MFSHALL_T), INTENT (IN)::PARAMMF
TYPE (TURB_T), INTENT (IN)::TURBN
TYPE (CSTURB_T), INTENT (IN)::CSTURB
INTEGER, INTENT (IN)::KRR
INTEGER, INTENT (IN)::KRRL
INTEGER, INTENT (IN)::KRRI
INTEGER, INTENT (IN)::KSV
LOGICAL, INTENT (IN)::ONOMIXLG
INTEGER, INTENT (IN)::KSV_LGBEG
INTEGER, INTENT (IN)::KSV_LGEND
REAL, INTENT (IN)::PTSTEP
REAL, INTENT (IN)::PZZ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PDZZ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRHODJ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRHODREF(D%NIJT, D%NKT)
REAL, INTENT (IN)::PPABSM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PEXNM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PSFRV(D%NIJT)
REAL, INTENT (IN)::PSFTH(D%NIJT)
REAL, INTENT (IN)::PTHM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRM(D%NIJT, D%NKT, KRR)
REAL, INTENT (IN)::PVM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PUM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTKEM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PSVM(D%NIJT, D%NKT, KSV)
REAL, INTENT (OUT)::PDUDT_MF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PDVDT_MF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PDTHLDT_MF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PDRTDT_MF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PDSVDT_MF(D%NIJT, D%NKT, KSV)
REAL, INTENT (OUT)::PCF_MF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PRI_MF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PRC_MF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PSIGMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZTHVMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZTHMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZRMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZUMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PFLXZVMF(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PTHL_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PRT_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PRV_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PU_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PV_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PRC_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PRI_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PTHV_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PW_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PFRAC_UP(D%NIJT, D%NKT)
REAL, INTENT (INOUT)::PEMF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PDETR(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PENTR(D%NIJT, D%NKT)
INTEGER, INTENT (OUT)::KKCTL(D%NIJT)
INTEGER, INTENT (OUT)::KKETL(D%NIJT)
INTEGER, INTENT (OUT)::KKLCL(D%NIJT)
REAL, INTENT (IN)::PDY
REAL, INTENT (IN)::PDX
REAL, INTENT (IN), OPTIONAL::PRSVS(D%NIJT, D%NKT, KSV)
REAL, INTENT (IN), OPTIONAL::PSVMIN(JPSVMAX)
TYPE (TBUDGETCONF_T), INTENT (IN), OPTIONAL::BUCONF
TYPE (TBUDGETDATA), INTENT (INOUT), OPTIONAL::TBUDGETS(KBUDGETS)
INTEGER, INTENT (IN)::KBUDGETS
TYPE(STACK), INTENT (IN) :: YDSTACK
TYPE(STACK) :: YLSTACK
REAL::ZBUO_INTEG(D%NIJT, D%NKT)
REAL::ZEMF_O_RHODREF(D%NIJT, D%NKT)
REAL::ZWORK2(D%NIJT, D%NKT)
REAL::ZWORK(D%NIJT, D%NKT)
REAL::ZTHVM(D%NIJT, D%NKT)
REAL::ZRTM(D%NIJT, D%NKT)
REAL::ZTHLM(D%NIJT, D%NKT)
REAL::ZFRAC_ICE(D%NIJT, D%NKT)
REAL::ZWK(D%NIJT, D%NKT)
REAL::ZFLXZSVMF(D%NIJT, D%NKT, KSV)
REAL::ZSV_UP(D%NIJT, D%NKT, KSV)
REAL::ZDEPTH(D%NIJT)
REAL::ZFRAC_ICE_UP(D%NIJT, D%NKT)
REAL::ZRSAT_UP(D%NIJT, D%NKT)
LOGICAL::GENTR_DETR
INTEGER::IERR(D%NIJT, D%NKT)
INTEGER::JSV
INTEGER::JK
INTEGER::JIJ
INTEGER::IIJE
INTEGER::IIJB
INTEGER::IKT

INTEGER (KIND=JPIM) :: JLON

YLSTACK = YDSTACK



JLON = KIDIA


IIJE=D%NIJE
IIJB=D%NIJB
IKT=D%NKT

IF (PARAMMF%CMF_UPDRAFT=='EDKF'.OR.PARAMMF%CMF_UPDRAFT=='RHCJ') THEN
  PENTR=1.E20
  PDETR=1.E20
  PEMF=1.E20
  ZBUO_INTEG=1.E20
ENDIF

ZFRAC_ICE (:,:)=0.

IF (KRR.GE.4) THEN

  DO JK=1, IKT

    DO JIJ=IIJB, IIJE

      IF (PRM (JIJ, JK, 2)+PRM (JIJ, JK, 4)>1.E-20) THEN
        ZFRAC_ICE (JIJ, JK)=PRM (JIJ, JK, 4)/(PRM (JIJ, JK, 2)+PRM (JIJ, JK, 4))
      ENDIF

    ENDDO

  ENDDO

ENDIF


DO JK=1, IKT

  DO JIJ=IIJB, IIJE
    ZWK (JIJ, JK)=PTHM (JIJ, JK)*PEXNM (JIJ, JK)
  ENDDO

ENDDO

CALL COMPUTE_FRAC_ICE_OPENACC (NEBN%CFRAC_ICE_SHALLOW_MF, CST, NEBN&
&, ZFRAC_ICE (:,:), ZWK (:,:), IERR (:,:), YDSTACK=YLSTACK)
CALL THL_RT_FROM_TH_R_MF_OPENACC (D, CST, KRR, KRRL, KRRI&
&, PTHM, PRM, PEXNM, ZTHLM, ZRTM, YDSTACK=YLSTACK)

DO JK=1, IKT

  DO JIJ=IIJB, IIJE
    ZTHVM (JIJ, JK)=PTHM (JIJ, JK)*((1.+CST%XRV/CST%XRD*PRM (JIJ, JK, 1))/(1.+ZRTM (JIJ, JK)))
  ENDDO

ENDDO


IF (PARAMMF%CMF_UPDRAFT=='EDKF') THEN
  GENTR_DETR=.TRUE.
  CALL COMPUTE_UPDRAFT_OPENACC (D, CST, NEBN, PARAMMF, TURBN, CSTURB, KSV, GENTR_DETR, ONOMIXLG&
  &, KSV_LGBEG, KSV_LGEND, PZZ, PDZZ, PSFTH, PSFRV, PPABSM, PRHODREF, PUM, PVM, PTKEM, PTHM&
  &, PRM (:,:, 1), ZTHLM, ZRTM, PSVM, PTHL_UP, PRT_UP, PRV_UP, PRC_UP, PRI_UP, PTHV_UP,&
  & PW_UP, PU_UP, PV_UP, ZSV_UP, PFRAC_UP, ZFRAC_ICE_UP, ZRSAT_UP, PEMF, PDETR, PENTR, ZBUO_INTEG&
  &, KKLCL, KKETL, KKCTL, ZDEPTH, PDX, PDY, YDSTACK=YLSTACK)
ELSEIF (PARAMMF%CMF_UPDRAFT=='RHCJ') THEN
  GENTR_DETR=.TRUE.
  CALL COMPUTE_UPDRAFT_RHCJ10_OPENACC (D, CST, NEBN, PARAMMF, TURBN, CSTURB, KSV, GENTR_DETR&
  &, ONOMIXLG, KSV_LGBEG, KSV_LGEND, PZZ, PDZZ, PSFTH, PSFRV, PPABSM, PRHODREF, PUM, PVM&
  &, PTKEM, PTHM, PRM (:,:, 1), ZTHLM, ZRTM, PSVM, PTHL_UP, PRT_UP, PRV_UP, PRC_UP, PRI_UP&
  &, PTHV_UP, PW_UP, PU_UP, PV_UP, ZSV_UP, PFRAC_UP, ZFRAC_ICE_UP, ZRSAT_UP, PEMF, PDETR&
  &, PENTR, ZBUO_INTEG, KKLCL, KKETL, KKCTL, ZDEPTH, YDSTACK=YLSTACK)
ELSEIF (PARAMMF%CMF_UPDRAFT=='RAHA') THEN
  CALL COMPUTE_UPDRAFT_RAHA_OPENACC (D, CST, NEBN, PARAMMF, KSV, GENTR_DETR, ONOMIXLG&
  &, KSV_LGBEG, KSV_LGEND, PZZ, PDZZ, PSFTH, PSFRV, PPABSM, PRHODREF, PUM, PVM, PTKEM&
  &, PEXNM, PTHM, PRM (:,:, 1), ZTHLM, ZRTM, PSVM, PTHL_UP, PRT_UP, PRV_UP, PRC_UP, PRI_UP&
  &, PTHV_UP, PW_UP, PU_UP, PV_UP, ZSV_UP, PFRAC_UP, ZFRAC_ICE_UP, ZRSAT_UP, PEMF, PDETR&
  &, PENTR, ZBUO_INTEG, KKLCL, KKETL, KKCTL, ZDEPTH, YDSTACK=YLSTACK)
ELSEIF (PARAMMF%CMF_UPDRAFT=='DUAL') THEN
ELSE
  CALL PRINT_MSG_OPENACC (NVERB_FATAL,'GEN','SHALLOW_MF','no updraft model for&
  & EDKF: CMF_UPDRAFT='//TRIM (PARAMMF%CMF_UPDRAFT), YDSTACK=YLSTACK)
ENDIF

CALL COMPUTE_MF_CLOUD_OPENACC (D, CST, TURBN, PARAMMF, NEBN%LSTATNW, KRR, KRRL,&
& KRRI, ZFRAC_ICE, PRC_UP, PRI_UP, PEMF, PTHL_UP, PRT_UP, PFRAC_UP, PTHV_UP, ZFRAC_ICE_UP&
&, ZRSAT_UP, PEXNM, ZTHLM, ZRTM, PTHM, ZTHVM, PRM, PDZZ, PZZ, KKLCL, PPABSM, PRHODREF&
&, PRC_MF, PRI_MF, PCF_MF, PSIGMF, ZDEPTH, YDSTACK=YLSTACK)

DO JK=1, IKT

  DO JIJ=IIJB, IIJE
    ZEMF_O_RHODREF (JIJ, JK)=PEMF (JIJ, JK)/PRHODREF (JIJ, JK)
  ENDDO

ENDDO


IF (PARAMMF%XIMPL_MF>1.E-10) THEN
  CALL MF_TURB_OPENACC (D, KSV, PARAMMF%LMIXUV, ONOMIXLG, KSV_LGBEG, KSV_LGEND, PARAMMF%XIMPL_MF&
  &, PTSTEP, PDZZ, PRHODJ, ZTHLM, ZTHVM, ZRTM, PUM, PVM, PSVM, PDTHLDT_MF, PDRTDT_MF, PDUDT_MF&
  &, PDVDT_MF, PDSVDT_MF, ZEMF_O_RHODREF, PTHL_UP, PTHV_UP, PRT_UP, PU_UP, PV_UP, ZSV_UP, PFLXZTHMF&
  &, PFLXZTHVMF, PFLXZRMF, PFLXZUMF, PFLXZVMF, ZFLXZSVMF, YDSTACK=YLSTACK)
ELSE
  CALL MF_TURB_EXPL_OPENACC (D, PARAMMF, PRHODJ, ZTHLM, ZTHVM, ZRTM, PUM, PVM, PDTHLDT_MF&
  &, PDRTDT_MF, PDUDT_MF, PDVDT_MF, ZEMF_O_RHODREF, PTHL_UP, PTHV_UP, PRT_UP, PU_UP, PV_UP&
  &, PFLXZTHMF, PFLXZTHVMF, PFLXZRMF, PFLXZUMF, PFLXZVMF, YDSTACK=YLSTACK)
ENDIF


IF (PARAMMF%CMF_UPDRAFT=='DUAL') THEN
  PFLXZTHVMF=0.
ENDIF


IF (PRESENT (BUCONF)) THEN
  
  
  
  
  
ENDIF




INCLUDE"compute_frac_ice.func.h"
ENDSUBROUTINE SHALLOW_MF_OPENACC
