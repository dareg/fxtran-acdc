
MODULE MODE_COMPUTE_MF_CLOUD_BIGAUS_OPENACC


IMPLICIT NONE


CONTAINS
SUBROUTINE COMPUTE_MF_CLOUD_BIGAUS_OPENACC (D, CST, PARAMMF, PEMF, PDEPTH, PRT_UP, PTHV_UP, PFRAC_ICE_UP&
&, PRSAT_UP, PRTM, PTHM, PTHVM, PDZZ, PZZ, PRHODREF, PRC_MF, PRI_MF, PCF_MF, YDSTACK)
!$ACC ROUTINE (COMPUTE_MF_CLOUD_BIGAUS_OPENACC) SEQ
USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODD_CST,ONLY:CST_T
USE MODD_PARAM_MFSHALL_N,ONLY:PARAM_MFSHALL_T
USE MODI_SHUMAN_MF_OPENACC,ONLY:MZF_MF_OPENACC, GZ_M_W_MF_OPENACC

#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (DIMPHYEX_T), INTENT (IN)::D
TYPE (CST_T), INTENT (IN)::CST
TYPE (PARAM_MFSHALL_T), INTENT (IN)::PARAMMF
REAL, INTENT (IN)::PEMF(D%NIJT, D%NKT)
REAL, INTENT (IN)::PDEPTH(D%NIJT)
REAL, INTENT (IN)::PRT_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRSAT_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHV_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PFRAC_ICE_UP(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHVM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRTM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTHM(D%NIJT, D%NKT)
REAL, INTENT (IN)::PZZ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PDZZ(D%NIJT, D%NKT)
REAL, INTENT (IN)::PRHODREF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PRI_MF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PRC_MF(D%NIJT, D%NKT)
REAL, INTENT (OUT)::PCF_MF(D%NIJT, D%NKT)
TYPE(STACK), INTENT (IN) :: YDSTACK
TYPE(STACK) :: YLSTACK
REAL::ZSIGMF(D%NIJT, D%NKT)
REAL::ZALPHA_UP_M(D%NIJT, D%NKT)
REAL::ZGRAD_Z_RT(D%NIJT, D%NKT)
REAL::ZOMEGA_UP_M(D%NIJT)
REAL::ZW1(D%NIJT, D%NKT)
INTEGER::JK
INTEGER::JIJ
REAL::ZFRAC_ICE_UP_M(D%NIJT, D%NKT)
REAL::ZRT_UP_M(D%NIJT, D%NKT)
REAL::ZRSAT_UP_M(D%NIJT, D%NKT)
REAL::ZTHV_UP_M(D%NIJT, D%NKT)
REAL::ZEMF_M(D%NIJT, D%NKT)
REAL::ZCOND(D%NIJT, D%NKT)
REAL::ZGAM(D%NIJT, D%NKT)
REAL::ZA(D%NIJT, D%NKT)
INTEGER::IIJE
INTEGER::IIJB
INTEGER::IKL
INTEGER::IKE
INTEGER::IKU
INTEGER::IKA
INTEGER::IKB
INTEGER::IKT

INTEGER (KIND=JPIM) :: JLON

YLSTACK = YDSTACK



JLON = KIDIA


IIJE=D%NIJE
IIJB=D%NIJB
IKT=D%NKT
IKB=D%NKB
IKA=D%NKA
IKU=D%NKU
IKE=D%NKE
IKL=D%NKL
CALL GZ_M_W_MF_OPENACC (D, PRTM (:,:), PDZZ (:,:), ZW1 (:,:), YDSTACK=YLSTACK)
CALL MZF_MF_OPENACC (D, ZW1 (:,:), ZGRAD_Z_RT (:,:), YDSTACK=YLSTACK)
CALL MZF_MF_OPENACC (D, PTHV_UP (:,:), ZTHV_UP_M (:,:), YDSTACK=YLSTACK)
CALL MZF_MF_OPENACC (D, PRSAT_UP (:,:), ZRSAT_UP_M (:,:), YDSTACK=YLSTACK)
CALL MZF_MF_OPENACC (D, PRT_UP (:,:), ZRT_UP_M (:,:), YDSTACK=YLSTACK)
CALL MZF_MF_OPENACC (D, PEMF (:,:), ZEMF_M (:,:), YDSTACK=YLSTACK)
CALL MZF_MF_OPENACC (D, PFRAC_ICE_UP (:,:), ZFRAC_ICE_UP_M (:,:), YDSTACK=YLSTACK)
ZOMEGA_UP_M (:)=0.

DO JK=IKB, IKE-IKL, IKL

  DO JIJ=IIJB, IIJE
    ZOMEGA_UP_M (JIJ)=ZOMEGA_UP_M (JIJ)+ZEMF_M (JIJ, JK)*(ZTHV_UP_M (JIJ, JK)-PTHVM (JIJ&
    &, JK))*(PZZ (JIJ, JK+IKL)-PZZ (JIJ, JK))/(PTHM (JIJ, JK)*PRHODREF (JIJ, JK))
  ENDDO

ENDDO


DO JIJ=IIJB, IIJE
  ZOMEGA_UP_M (JIJ)=MAX (ZOMEGA_UP_M (JIJ), 1.E-20)
  ZOMEGA_UP_M (JIJ)=(CST%XG*ZOMEGA_UP_M (JIJ))**(1./3.)
ENDDO


DO JK=IKA, IKU, IKL

  DO JIJ=IIJB, IIJE
    ZALPHA_UP_M (JIJ, JK)=ZEMF_M (JIJ, JK)/(PARAMMF%XALPHA_MF*PRHODREF (JIJ, JK)*ZOMEGA_UP_M (JIJ))
    ZALPHA_UP_M (JIJ, JK)=MAX (0., MIN (ZALPHA_UP_M (JIJ, JK), 1.))
  ENDDO

ENDDO


DO JK=IKA, IKU, IKL

  DO JIJ=IIJB, IIJE
    ZSIGMF (JIJ, JK)=ZEMF_M (JIJ, JK)*(ZRT_UP_M (JIJ, JK)-PRTM (JIJ, JK))*PDEPTH (JIJ)&
    &*ZGRAD_Z_RT (JIJ, JK)/(PARAMMF%XSIGMA_MF*ZOMEGA_UP_M (JIJ)*PRHODREF (JIJ, JK))
  ENDDO

ENDDO


DO JK=1, IKT

  DO JIJ=IIJB, IIJE
    ZSIGMF (JIJ, JK)=SQRT (MAX (ABS (ZSIGMF (JIJ, JK)), 1.E-40))
  ENDDO

ENDDO


DO JK=1, IKT

  DO JIJ=IIJB, IIJE
    ZA (JIJ, JK)=(ZRSAT_UP_M (JIJ, JK)-ZRT_UP_M (JIJ, JK))/(SQRT (2.)*ZSIGMF (JIJ, JK))
    ZGAM (JIJ, JK)=1-SIGN (1., ZA (JIJ, JK))*SQRT (1-EXP (-4*ZA (JIJ, JK)**2/CST%XPI))
    PCF_MF (JIJ, JK)=MAX (0., MIN (1., 0.5*ZGAM (JIJ, JK)*ZALPHA_UP_M (JIJ, JK)))
    ZCOND (JIJ, JK)=(EXP (-ZA (JIJ, JK)**2)-ZA (JIJ, JK)*SQRT (CST%XPI)*ZGAM&
    & (JIJ, JK))*ZSIGMF (JIJ, JK)/SQRT (2.*CST%XPI)*ZALPHA_UP_M (JIJ, JK)
    ZCOND (JIJ, JK)=MAX (ZCOND (JIJ, JK), 0.)
    PRC_MF (JIJ, JK)=(1.-ZFRAC_ICE_UP_M (JIJ, JK))*ZCOND (JIJ, JK)
    PRI_MF (JIJ, JK)=(ZFRAC_ICE_UP_M (JIJ, JK))*ZCOND (JIJ, JK)
  ENDDO

ENDDO



ENDSUBROUTINE COMPUTE_MF_CLOUD_BIGAUS_OPENACC

ENDMODULE MODE_COMPUTE_MF_CLOUD_BIGAUS_OPENACC
