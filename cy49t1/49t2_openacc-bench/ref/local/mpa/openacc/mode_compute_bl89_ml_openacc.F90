MODULE MODE_COMPUTE_BL89_ML_OPENACC


IMPLICIT NONE


CONTAINS
SUBROUTINE COMPUTE_BL89_ML_OPENACC (D, CST, CSTURB, PDZZ2D, PTKEM_DEP&
&, PG_O_THVREF, PVPT, KK, OUPORDN, OFLUX, PSHEAR, PLWORK, YDSTACK)
!$ACC ROUTINE (COMPUTE_BL89_ML_OPENACC) SEQ

USE MODD_DIMPHYEX,ONLY:DIMPHYEX_T
USE MODD_CST,ONLY:CST_T
USE MODD_CTURB,ONLY:CSTURB_T
USE MODE_MSG
USE MODI_SHUMAN_MF_OPENACC,ONLY:DZM_MF_OPENACC, MZM_MF_OPENACC
#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (DIMPHYEX_T), INTENT (IN)::D
TYPE (CST_T), INTENT (IN)::CST
TYPE (CSTURB_T), INTENT (IN)::CSTURB
REAL, INTENT (IN)::PDZZ2D(D%NIJT, D%NKT)
REAL, INTENT (IN)::PTKEM_DEP(D%NIJT)
REAL, INTENT (IN)::PG_O_THVREF(D%NIJT)
REAL, INTENT (IN)::PVPT(D%NIJT, D%NKT)
INTEGER, INTENT (IN)::KK
LOGICAL, INTENT (IN)::OUPORDN
LOGICAL, INTENT (IN)::OFLUX
REAL, INTENT (OUT)::PLWORK(D%NIJT)
TYPE(STACK), INTENT (IN) :: YDSTACK
TYPE(STACK) :: YLSTACK
REAL, INTENT (IN)::PSHEAR(D%NIJT, D%NKT)
REAL::ZLWORK2(D%NIJT)
REAL::ZLWORK1(D%NIJT)
REAL::ZPOTE(D%NIJT)
REAL::ZINTE(D%NIJT)
REAL::ZVPT_DEP(D%NIJT)
REAL::ZHLVPT(D%NIJT, D%NKT)
REAL::ZDELTVPT(D%NIJT, D%NKT)
INTEGER::J1D
INTEGER::JKK
INTEGER::JK
INTEGER::JIJ
INTEGER::IIJE
INTEGER::IIJB
INTEGER::IKL
INTEGER::IKE
INTEGER::IKA
INTEGER::IKB
INTEGER::IKT
REAL::ZTESTM
REAL::ZTEST0
REAL::ZTEST

INTEGER (KIND=JPIM) :: JLON

YLSTACK = YDSTACK



JLON = KIDIA


IIJE=D%NIJE
IIJB=D%NIJB
IKT=D%NKT
IKB=D%NKB
IKA=D%NKA
IKE=D%NKE
IKL=D%NKL
CALL DZM_MF_OPENACC (D, PVPT (:,:), ZDELTVPT (:,:), YDSTACK=YLSTACK)
ZDELTVPT (IIJB:IIJE, IKA)=0.

DO JK=1, IKT

  DO JIJ=IIJB, IIJE

    IF (ABS (ZDELTVPT (JIJ, JK))<CSTURB%XLINF) THEN
      ZDELTVPT (JIJ, JK)=CSTURB%XLINF
    ENDIF

  ENDDO

ENDDO

CALL MZM_MF_OPENACC (D, PVPT (:,:), ZHLVPT (:,:), YDSTACK=YLSTACK)

DO JIJ=IIJB, IIJE
  ZDELTVPT (JIJ, IKB)=PDZZ2D (JIJ, IKB)*ZDELTVPT (JIJ, IKB+IKL)/PDZZ2D (JIJ, IKB+IKL)
  ZHLVPT (JIJ, IKB)=PVPT (JIJ, IKB)-ZDELTVPT (JIJ, IKB)*0.5
ENDDO


IF (OUPORDN.EQV..TRUE.) THEN

  DO JIJ=IIJB, IIJE
    ZINTE (JIJ)=PTKEM_DEP (JIJ)
  ENDDO

  PLWORK=0.
  ZTESTM=1.

  IF (OFLUX) THEN

    DO JIJ=IIJB, IIJE
      ZVPT_DEP (JIJ)=ZHLVPT (JIJ, KK)
    ENDDO


    DO J1D=IIJB, IIJE
      ZTEST0=0.5+SIGN (0.5, ZINTE (J1D))
      ZPOTE (J1D)=ZTEST0*(PG_O_THVREF (J1D)*(0.5*(ZHLVPT (J1D, KK)+PVPT (J1D, KK))-ZVPT_DEP (J1D&
      &))+CSTURB%XRM17*PSHEAR (J1D, KK)*SQRT (ABS (PTKEM_DEP (J1D))))*PDZZ2D (J1D, KK)*0.5
      ZTEST=0.5+SIGN (0.5, ZINTE (J1D)-ZPOTE (J1D))
      ZLWORK1 (J1D)=PDZZ2D (J1D, KK)*0.5
      ZLWORK2 (J1D)=(-PG_O_THVREF (J1D)*(ZHLVPT (J1D, KK)-ZVPT_DEP (J1D))-CSTURB%XRM17*PSHEAR (J1D, KK)&
      &*SQRT (ABS (PTKEM_DEP (J1D)))+SQRT (ABS ((CSTURB%XRM17*PSHEAR (J1D, KK)*SQRT (ABS (PTKEM_DEP (J1D&
      &)))+PG_O_THVREF (J1D)*(ZHLVPT (J1D, KK)-ZVPT_DEP (J1D)))**2+2.*ZINTE (J1D)*PG_O_THVREF (J1D)*ZDELTVPT&
      & (J1D, KK)/PDZZ2D (J1D, KK))))/(PG_O_THVREF (J1D)*ZDELTVPT (J1D, KK)/PDZZ2D (J1D, KK))
      PLWORK (J1D)=PLWORK (J1D)+ZTEST0*(ZTEST*ZLWORK1 (J1D)+(1-ZTEST)*ZLWORK2 (J1D))
      ZINTE (J1D)=ZINTE (J1D)-ZPOTE (J1D)
    ENDDO

  ELSE

    DO JIJ=IIJB, IIJE
      ZVPT_DEP (JIJ)=PVPT (JIJ, KK)
    ENDDO

  ENDIF


  DO JKK=KK+IKL, IKE, IKL

    IF (ZTESTM>0.) THEN
      ZTESTM=0

      DO J1D=IIJB, IIJE
        ZTEST0=0.5+SIGN (0.5, ZINTE (J1D))
        ZPOTE (J1D)=ZTEST0*(PG_O_THVREF (J1D)*(ZHLVPT (J1D, JKK)-ZVPT_DEP (J1D))+CSTURB&
        &%XRM17*PSHEAR (J1D, JKK)*SQRT (ABS (PTKEM_DEP (J1D))))*PDZZ2D (J1D, JKK)
        ZTEST=0.5+SIGN (0.5, ZINTE (J1D)-ZPOTE (J1D))
        ZTESTM=ZTESTM+ZTEST0
        ZLWORK1 (J1D)=PDZZ2D (J1D, JKK)
        ZLWORK2 (J1D)=(-PG_O_THVREF (J1D)*(PVPT (J1D, JKK-IKL)-ZVPT_DEP (J1D))-CSTURB%XRM17*PSHEAR (J1D, JKK&
        &)*SQRT (ABS (PTKEM_DEP (J1D)))+SQRT (ABS ((CSTURB%XRM17*PSHEAR (J1D, JKK)*SQRT (ABS (PTKEM_DEP (J1D&
        &)))+PG_O_THVREF (J1D)*(PVPT (J1D, JKK-IKL)-ZVPT_DEP (J1D)))**2+2.*ZINTE (J1D)*PG_O_THVREF (J1D)*ZDELTVPT&
        & (J1D, JKK)/PDZZ2D (J1D, JKK))))/(PG_O_THVREF (J1D)*ZDELTVPT (J1D, JKK)/PDZZ2D (J1D, JKK))
        PLWORK (J1D)=PLWORK (J1D)+ZTEST0*(ZTEST*ZLWORK1 (J1D)+(1-ZTEST)*ZLWORK2 (J1D))
        ZINTE (J1D)=ZINTE (J1D)-ZPOTE (J1D)
      ENDDO

    ENDIF

  ENDDO

ENDIF


IF (OUPORDN.EQV..FALSE.) THEN

  IF (OFLUX)  THEN
      CALL PRINT_MSG_OPENACC (NVERB_FATAL,'GEN','COMPUTE_BL89_ML','OFLUX&
    & option not coded for downward mixing length', YDSTACK=YLSTACK)
  ENDIF


  DO JIJ=IIJB, IIJE
    ZINTE (JIJ)=PTKEM_DEP (JIJ)
  ENDDO

  PLWORK=0.
  ZTESTM=1.

  DO JKK=KK, IKB,-IKL

    IF (ZTESTM>0.) THEN
      ZTESTM=0

      DO J1D=IIJB, IIJE
        ZTEST0=0.5+SIGN (0.5, ZINTE (J1D))
        ZPOTE (J1D)=ZTEST0*(-PG_O_THVREF (J1D)*(ZHLVPT (J1D, JKK)-PVPT (J1D, KK))+CSTURB&
        &%XRM17*PSHEAR (J1D, JKK)*SQRT (ABS (PTKEM_DEP (J1D))))*PDZZ2D (J1D, JKK)
        ZTEST=0.5+SIGN (0.5, ZINTE (J1D)-ZPOTE (J1D))
        ZTESTM=ZTESTM+ZTEST0
        ZLWORK1 (J1D)=PDZZ2D (J1D, JKK)
        ZLWORK2 (J1D)=(+PG_O_THVREF (J1D)*(PVPT (J1D, JKK)-PVPT (J1D, KK))-CSTURB%XRM17*PSHEAR (J1D, JKK)*SQRT&
        & (ABS (PTKEM_DEP (J1D)))+SQRT (ABS ((CSTURB%XRM17*PSHEAR (J1D, JKK)*SQRT (ABS (PTKEM_DEP (J1D)))-PG_O_THVREF&
        & (J1D)*(PVPT (J1D, JKK)-PVPT (J1D, KK)))**2+2.*ZINTE (J1D)*PG_O_THVREF (J1D)*ZDELTVPT (J1D, JKK)/PDZZ2D&
        & (J1D, JKK))))/(PG_O_THVREF (J1D)*ZDELTVPT (J1D, JKK)/PDZZ2D (J1D, JKK))
        PLWORK (J1D)=PLWORK (J1D)+ZTEST0*(ZTEST*ZLWORK1 (J1D)+(1-ZTEST)*ZLWORK2 (J1D))
        ZINTE (J1D)=ZINTE (J1D)-ZPOTE (J1D)
      ENDDO

    ENDIF

  ENDDO

ENDIF



ENDSUBROUTINE COMPUTE_BL89_ML_OPENACC

ENDMODULE MODE_COMPUTE_BL89_ML_OPENACC
