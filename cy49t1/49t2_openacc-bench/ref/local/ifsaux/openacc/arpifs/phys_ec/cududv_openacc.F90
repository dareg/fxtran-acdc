SUBROUTINE CUDUDV_OPENACC (YDCST, YDECUMF, YDSPP_CONFIG, YDPERTPAR, KIDIA, KFDIA,&
& KLON, KLEV, KTOPM2, KTYPE, KCBOT, KCTOP, LDCUM, PTSPHY, PAPH, PAP, PUEN, PVEN, PMFU&
&, PMFD, PMFUO, PMFDO, PUU, PUD, PVU, PVD, PGP2DSPP, PTENU, PTENV, YDSTACK)
!$ACC ROUTINE (CUDUDV_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOECUMF,ONLY:TECUMF
USE SPP_MOD,ONLY:TSPP_CONFIG
USE YOMPERTPAR,ONLY:TPERTPAR
USE SPP_GEN_MOD,ONLY:SPP_PERT
#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (TCST), INTENT (IN)::YDCST
TYPE (TECUMF), INTENT (IN)::YDECUMF
TYPE (TSPP_CONFIG), INTENT (IN)::YDSPP_CONFIG
TYPE (TPERTPAR), INTENT (IN)::YDPERTPAR
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KTOPM2
INTEGER (KIND=JPIM), INTENT (IN)::KTYPE (KLON)
INTEGER (KIND=JPIM), INTENT (IN)::KCBOT (KLON)
INTEGER (KIND=JPIM), INTENT (IN)::KCTOP (KLON)
LOGICAL, INTENT (IN)::LDCUM (KLON)
REAL (KIND=JPRB), INTENT (IN)::PTSPHY
REAL (KIND=JPRB), INTENT (IN)::PAPH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PAP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PMFU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PMFD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PMFUO (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PMFDO (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGP2DSPP (KLON, YDSPP_CONFIG%SM%NRFTOTAL)
REAL (KIND=JPRB), INTENT (INOUT)::PTENU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENV (KLON, KLEV)
TYPE(STACK), INTENT (IN) :: YDSTACK
TYPE(STACK) :: YLSTACK
REAL (KIND=JPRB)::ZADVW 
temp (REAL (KIND=JPRB), ZMFDV, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZMFUV, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZMFDU, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZMFUU, (KLON, KLEV))
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::IKB
INTEGER (KIND=JPIM)::IM
INTEGER (KIND=JPIM)::IK
INTEGER (KIND=JPIM)::IPCUDVS
INTEGER (KIND=JPIM)::IPCUDUS
INTEGER (KIND=JPIM)::IPCUDV
INTEGER (KIND=JPIM)::IPCUDU
INTEGER (KIND=JPIM)::IPN2
INTEGER (KIND=JPIM)::IPN1
TYPE (SPP_PERT)::PN2
TYPE (SPP_PERT)::PN1
REAL (KIND=JPRB)::ZV
REAL (KIND=JPRB)::ZU
REAL (KIND=JPRB)::ZTSPHY
REAL (KIND=JPRB)::ZIMP
REAL (KIND=JPRB)::ZZP
REAL (KIND=JPRB)::ZLIMN2
REAL (KIND=JPRB)::ZMDV
REAL (KIND=JPRB)::ZMDU
REAL (KIND=JPRB)::ZFAC
REAL (KIND=JPRB)::ZN2
REAL (KIND=JPRB)::ZXV_MAG
REAL (KIND=JPRB)::ZXU_MAG
REAL (KIND=JPRB)::ZXV
REAL (KIND=JPRB)::ZXU
REAL (KIND=JPRB)::ZRDV
REAL (KIND=JPRB)::ZRDU
temp (REAL (KIND=JPRB), ZDP, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZDVDT, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZDUDT, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZR2, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZR1, (KLON, KLEV))
temp (REAL (KIND=JPRB), ZB, (KLON, KLEV))
temp (LOGICAL, LLCUMBAS, (KLON, KLEV))
LOGICAL::LLPPAR_CUDUV
LOGICAL::LLPERT_CUDUDVS
LOGICAL::LLPERT_CUDUDV

#include "cubidiag_openacc.intfb.h"
INTEGER (KIND=JPIM) :: JLON

YLSTACK = YDSTACK



IF (KIND (ZMFDV) == 8) THEN
    alloc8 (ZMFDV)
ELSEIF (KIND (ZMFDV) == 4) THEN
    alloc4 (ZMFDV)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMFUV) == 8) THEN
    alloc8 (ZMFUV)
ELSEIF (KIND (ZMFUV) == 4) THEN
    alloc4 (ZMFUV)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMFDU) == 8) THEN
    alloc8 (ZMFDU)
ELSEIF (KIND (ZMFDU) == 4) THEN
    alloc4 (ZMFDU)
ELSE
    STOP 1
ENDIF


IF (KIND (ZMFUU) == 8) THEN
    alloc8 (ZMFUU)
ELSEIF (KIND (ZMFUU) == 4) THEN
    alloc4 (ZMFUU)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDP) == 8) THEN
    alloc8 (ZDP)
ELSEIF (KIND (ZDP) == 4) THEN
    alloc4 (ZDP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDVDT) == 8) THEN
    alloc8 (ZDVDT)
ELSEIF (KIND (ZDVDT) == 4) THEN
    alloc4 (ZDVDT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZDUDT) == 8) THEN
    alloc8 (ZDUDT)
ELSEIF (KIND (ZDUDT) == 4) THEN
    alloc4 (ZDUDT)
ELSE
    STOP 1
ENDIF


IF (KIND (ZR2) == 8) THEN
    alloc8 (ZR2)
ELSEIF (KIND (ZR2) == 4) THEN
    alloc4 (ZR2)
ELSE
    STOP 1
ENDIF


IF (KIND (ZR1) == 8) THEN
    alloc8 (ZR1)
ELSEIF (KIND (ZR1) == 4) THEN
    alloc4 (ZR1)
ELSE
    STOP 1
ENDIF


IF (KIND (ZB) == 8) THEN
    alloc8 (ZB)
ELSEIF (KIND (ZB) == 4) THEN
    alloc4 (ZB)
ELSE
    STOP 1
ENDIF


IF (KIND (LLCUMBAS) == 8) THEN
    alloc8 (LLCUMBAS)
ELSEIF (KIND (LLCUMBAS) == 4) THEN
    alloc4 (LLCUMBAS)
ELSE
    STOP 1
ENDIF


JLON = KIDIA



ZIMP=1.0_JPRB-YDECUMF%RMFSOLUV
ZTSPHY=1.0_JPRB/PTSPHY
LLPPAR_CUDUV=.FALSE.
LLPERT_CUDUDV=.FALSE.
LLPERT_CUDUDVS=.FALSE.

DO JL=KIDIA, KFDIA
  ZADVW =0.0_JPRB

  IF (KTYPE (JLON)==1)  THEN
      ZADVW =YDECUMF%RMFADVW
  ENDIF

ENDDO


DO JK=1, KLEV

  DO JL=KIDIA, KFDIA

    IF (LDCUM (JLON)) THEN
      ZDP (JLON, JK)=YDCST%RG/(PAPH (JLON, JK+1)-PAPH (JLON, JK))
    ENDIF

  ENDDO

ENDDO


DO JK=KTOPM2, KLEV
  IK=JK-1

  DO JL=KIDIA, KFDIA

    IF (LDCUM (JLON)) THEN
      ZMFUU (JLON, JK)=PMFU (JLON, JK)*(PUU (JLON, JK)-ZIMP*PUEN (JLON, IK))
      ZMFUV (JLON, JK)=PMFU (JLON, JK)*(PVU (JLON, JK)-ZIMP*PVEN (JLON, IK))
      ZMFDU (JLON, JK)=PMFD (JLON, JK)*(PUD (JLON, JK)-ZIMP*PUEN (JLON, IK))
      ZMFDV (JLON, JK)=PMFD (JLON, JK)*(PVD (JLON, JK)-ZIMP*PVEN (JLON, IK))
    ENDIF

  ENDDO

ENDDO


IF (YDECUMF%RMFSOLUV==0.0_JPRB) THEN

  DO JK=KTOPM2, KLEV

    DO JL=KIDIA, KFDIA

      IF (LDCUM (JLON).AND.JK>KCBOT (JLON)) THEN
        IKB=KCBOT (JLON)
        ZZP=((PAPH (JLON, KLEV+1)-PAPH (JLON, JK))/(PAPH (JLON, KLEV+1)-PAPH (JLON, IKB)))

        IF (KTYPE (JLON)==3) THEN
          ZZP=ZZP*ZZP
        ENDIF

        ZMFUU (JLON, JK)=ZMFUU (JLON, IKB)*ZZP
        ZMFUV (JLON, JK)=ZMFUV (JLON, IKB)*ZZP
        ZMFDU (JLON, JK)=ZMFDU (JLON, IKB)*ZZP
        ZMFDV (JLON, JK)=ZMFDV (JLON, IKB)*ZZP
      ENDIF

    ENDDO

  ENDDO

ENDIF


DO JK=KTOPM2, KLEV

  IF (JK<KLEV) THEN
    IK=JK+1

    DO JL=KIDIA, KFDIA

      IF (LDCUM (JLON)) THEN
        ZDUDT (JLON, JK)=ZDP (JLON, JK)*(ZMFUU (JLON, IK)-ZMFUU&
        & (JLON, JK)+ZMFDU (JLON, IK)-ZMFDU (JLON, JK))
        ZDVDT (JLON, JK)=ZDP (JLON, JK)*(ZMFUV (JLON, IK)-ZMFUV&
        & (JLON, JK)+ZMFDV (JLON, IK)-ZMFDV (JLON, JK))
      ENDIF

    ENDDO

  ELSE

    DO JL=KIDIA, KFDIA

      IF (LDCUM (JLON)) THEN
        ZDUDT (JLON, JK)=-ZDP (JLON, JK)*(ZMFUU (JLON, JK)+ZMFDU (JLON, JK))
        ZDVDT (JLON, JK)=-ZDP (JLON, JK)*(ZMFUV (JLON, JK)+ZMFDV (JLON, JK))
      ENDIF

    ENDDO

  ENDIF

ENDDO


IF (YDECUMF%RMFSOLUV==0.0_JPRB) THEN

  DO JK=KTOPM2, KLEV

    DO JL=KIDIA, KFDIA

      IF (LDCUM (JLON)) THEN
        PTENU (JLON, JK)=PTENU (JLON, JK)+ZDUDT (JLON, JK)
        PTENV (JLON, JK)=PTENV (JLON, JK)+ZDVDT (JLON, JK)
      ENDIF

    ENDDO

  ENDDO

ELSE
  LLCUMBAS (JLON,:)=.FALSE.
  ZB (JLON,:)=1.0_JPRB
  ZMFUU (JLON,:)=0.0_JPRB

  DO JK=KTOPM2, KLEV
    IK=JK+1
    IM=JK-1

    DO JL=KIDIA, KFDIA
      LLCUMBAS (JLON, JK)=LDCUM (JLON).AND.JK>=KCTOP (JLON)-1

      IF (LLCUMBAS (JLON, JK)) THEN
        ZZP=YDECUMF%RMFSOLUV*ZDP (JLON, JK)*PTSPHY
        ZMFUU (JLON, JK)=-ZZP*(PMFU (JLON, JK)+PMFD (JLON, JK))

        IF (JK<KLEV) THEN
          ZB (JLON, JK)=1.0_JPRB+ZZP*(PMFU (JLON, IK)+PMFD (JLON, IK))
        ELSE
          ZB (JLON, JK)=1.0_JPRB
        ENDIF

        ZZP=YDCST%RG*(PMFUO (JLON, JK)+YDECUMF%RMFADVWDD*PMFDO (JLON&
        &, JK))/(PAP (JLON, JK)-PAP (JLON, IM))*PTSPHY*ZADVW 
        ZU=ZZP*(PUEN (JLON, IM)-PUEN (JLON, JK))
        ZV=ZZP*(PVEN (JLON, IM)-PVEN (JLON, JK))
        ZDUDT (JLON, JK)=(ZDUDT (JLON, JK)+PTENU (JLON, JK)*YDECUMF%RMFSOLRHS)*PTSPHY+PUEN (JLON, JK)-ZU
        ZDVDT (JLON, JK)=(ZDVDT (JLON, JK)+PTENV (JLON, JK)*YDECUMF%RMFSOLRHS)*PTSPHY+PVEN (JLON, JK)-ZV
      ENDIF

    ENDDO

  ENDDO

  CALL CUBIDIAG_OPENACC (KIDIA, KFDIA, KLON, KLEV, KCTOP&
  &, LLCUMBAS, ZMFUU, ZB, ZDUDT, ZR1, YDSTACK=YLSTACK)
  CALL CUBIDIAG_OPENACC (KIDIA, KFDIA, KLON, KLEV, KCTOP&
  &, LLCUMBAS, ZMFUU, ZB, ZDVDT, ZR2, YDSTACK=YLSTACK)
  LLPPAR_CUDUV=YDPERTPAR%LPERTPAR.AND.YDPERTPAR%LPERT_CUDUV
  
  LLPERT_CUDUDV=.FALSE.
  LLPERT_CUDUDVS=.FALSE.

  

  IF (LLPERT_CUDUDV.OR.LLPERT_CUDUDVS.OR.LLPPAR_CUDUV) THEN
    ZMDU=1.0_JPRB
    ZMDV=1.0_JPRB
    ZLIMN2=9.0_JPRB*PN1%SDEV**2

    DO JL=KIDIA, KFDIA

      IF ((KTYPE (JLON)==1.AND.(LLPERT_CUDUDV.OR.LLPPAR_CUDUV)).OR.(KTYPE&
        & (JLON)==2.AND.(LLPERT_CUDUDVS.OR.LLPPAR_CUDUV))) THEN

        IF (KTYPE (JLON)==1) THEN

          IF (.NOT.LLPPAR_CUDUV) THEN
            ZXU=PGP2DSPP (JLON, IPCUDU)
            ZXV=PGP2DSPP (JLON, IPCUDV)
            ZXU_MAG=PN1%XMAG (1)
            ZXV_MAG=PN1%XMAG (2)
          ELSE
            ZXU=YDPERTPAR%CUDU_MOD
            ZXV=YDPERTPAR%CUDV_MOD
          ENDIF

        ENDIF


        IF (KTYPE (JLON)==2) THEN

          IF (.NOT.LLPPAR_CUDUV) THEN
            ZXU=PGP2DSPP (JLON, IPCUDUS)
            ZXV=PGP2DSPP (JLON, IPCUDVS)
            ZXU_MAG=PN2%XMAG (1)
            ZXV_MAG=PN2%XMAG (2)
          ELSE
            ZXU=YDPERTPAR%CUDU_MOD
            ZXV=YDPERTPAR%CUDV_MOD
          ENDIF

        ENDIF

        ZN2=ZXU**2+ZXV**2

        IF (ZN2>ZLIMN2) THEN
          ZFAC=SQRT (ZLIMN2/ZN2)
          ZXU=ZFAC*ZXU
          ZXV=ZFAC*ZXV
        ENDIF


        IF (.NOT.LLPPAR_CUDUV) THEN
          ZRDU =ZMDU+ZXU_MAG*ZXU
          ZRDV =ZMDV+ZXV_MAG*ZXV
        ELSE
          ZRDU =ZMDU+ZXU
          ZRDV =ZMDV+ZXV
        ENDIF

      ELSE
        ZRDU =ZMDU
        ZRDV =ZMDV
      ENDIF

    ENDDO

  ENDIF


  DO JK=KTOPM2, KLEV

    DO JL=KIDIA, KFDIA

      IF (LLCUMBAS (JLON, JK)) THEN

        IF ((LLPERT_CUDUDV).OR.(LLPPAR_CUDUV)) THEN
          PTENU (JLON, JK)=PTENU (JLON, JK)*(1.0_JPRB-YDECUMF%RMFSOLRHS&
          &)+ZRDU *(ZR1 (JLON, JK)-PUEN (JLON, JK))*ZTSPHY
          PTENV (JLON, JK)=PTENV (JLON, JK)*(1.0_JPRB-YDECUMF%RMFSOLRHS&
          &)+ZRDV *(ZR2 (JLON, JK)-PVEN (JLON, JK))*ZTSPHY
        ELSE
          PTENU (JLON, JK)=PTENU (JLON, JK)*(1.0_JPRB-YDECUMF%RMFSOLRHS&
          &)+(ZR1 (JLON, JK)-PUEN (JLON, JK))*ZTSPHY
          PTENV (JLON, JK)=PTENV (JLON, JK)*(1.0_JPRB-YDECUMF%RMFSOLRHS&
          &)+(ZR2 (JLON, JK)-PVEN (JLON, JK))*ZTSPHY
        ENDIF

      ENDIF

    ENDDO

  ENDDO

ENDIF




ENDSUBROUTINE CUDUDV_OPENACC
