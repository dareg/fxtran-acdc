SUBROUTINE CUININ_OPENACC (YDCST, YDTHF, YDEPHLI, YDECUMF, KIDIA, KFDIA, KLON&
&, KLEV, PTEN, PQEN, PQSEN, PUEN, PVEN, PGEO, PAPH, KLAB, PTENH, PQENH, PQSENH&
&, PGEOH, PTU, PQU, PTD, PQD, PUU, PVU, PUD, PVD, PLU, YDSTACK)
!$ACC ROUTINE (CUININ_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE YOECUMF,ONLY:TECUMF
USE YOEPHLI,ONLY:TEPHLI
#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (TCST), INTENT (IN)::YDCST
TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TECUMF), INTENT (IN)::YDECUMF
TYPE (TEPHLI), INTENT (IN)::YDEPHLI
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
REAL (KIND=JPRB), INTENT (IN)::PTEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQSEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PUEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PVEN (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEO (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPH (KLON, KLEV+1)
INTEGER (KIND=JPIM), INTENT (OUT)::KLAB (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTENH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PQENH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PQSENH (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PGEOH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PTU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PQU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PTD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PQD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PUU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PVU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PUD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PVD (KLON, KLEV)
REAL (KIND=JPRB), INTENT (OUT)::PLU (KLON, KLEV)
TYPE(STACK), INTENT (IN) :: YDSTACK
REAL (KIND=JPRB)::ZPH 
LOGICAL::LLFLAG 
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::IK
REAL (KIND=JPRB)::ZORCPD

INTEGER (KIND=JPIM)::JL_CUADJTQ
REAL (KIND=JPRB)::ZQP
REAL (KIND=JPRB)::ZTARG
REAL (KIND=JPRB)::ZQSAT
REAL (KIND=JPRB)::ZQMAX
REAL (KIND=JPRB)::ZOEALFA
REAL (KIND=JPRB)::ZFOEEWL
REAL (KIND=JPRB)::ZFOEEWI
REAL (KIND=JPRB)::ZCOR
REAL (KIND=JPRB)::ZCOND1
REAL (KIND=JPRB)::ZCOND
REAL (KIND=JPRB)::Z2S
REAL (KIND=JPRB)::Z1S
REAL (KIND=JPRB)::ZF
REAL (KIND=JPRB)::ZI
REAL (KIND=JPRB)::ZL
LOGICAL::LLFLAG_CUADJTQ 

#include "fcttre.func.h"
#include "cuadjtq.func.h"
REAL (KIND=JPRB)::ZALDCP 
REAL (KIND=JPRB)::Z5ALCP 
REAL (KIND=JPRB)::Z4ES 
REAL (KIND=JPRB)::Z3ES 
INTEGER (KIND=JPIM)::JL_CUADJTQS
REAL (KIND=JPRB)::Z2S_CUADJTQS
REAL (KIND=JPRB)::ZFOEEW
REAL (KIND=JPRB)::ZQSAT_CUADJTQS
REAL (KIND=JPRB)::ZCOR_CUADJTQS
REAL (KIND=JPRB)::ZTARG_CUADJTQS
REAL (KIND=JPRB)::ZCOND1_CUADJTQS
REAL (KIND=JPRB)::ZCOND_CUADJTQS
REAL (KIND=JPRB)::ZQP_CUADJTQS
REAL (KIND=JPRB)::ZQMAX_CUADJTQS
INTEGER (KIND=JPIM) :: JLON

JLON = KIDIA



ZORCPD=1._JPRB/YDCST%RCPD

DO JK=2, KLEV

  DO JL=KIDIA, KFDIA
    PTENH (JLON, JK)=(MAX (YDCST%RCPD*PTEN (JLON, JK-1)+PGEO (JLON, JK-1), YDCST&
    &%RCPD*PTEN (JLON, JK)+PGEO (JLON, JK))-PGEOH (JLON, JK))*ZORCPD
    PQENH (JLON, JK)=PQEN (JLON, JK-1)
    PQSENH (JLON, JK)=PQSEN (JLON, JK-1)
    ZPH =PAPH (JLON, JK)
    LLFLAG =.TRUE.
  ENDDO


  IF (JK>=KLEV-1.OR.JK<YDECUMF%NJKT2)  THEN
      CYCLE
  ENDIF

  IK=JK

  IF (YDEPHLI%LPHYLIN) THEN
    
    
    ZQMAX_CUADJTQS=0.5_JPRB

    DO JL_CUADJTQS=KIDIA, KFDIA

      IF (PTENH (JLON, IK)>YDCST%RTT) THEN
        Z3ES =YDTHF%R3LES
        Z4ES =YDTHF%R4LES
        Z5ALCP =YDTHF%R5ALVCP
        ZALDCP =YDTHF%RALVDCP
      ELSE
        Z3ES =YDTHF%R3IES
        Z4ES =YDTHF%R4IES
        Z5ALCP =YDTHF%R5ALSCP
        ZALDCP =YDTHF%RALSDCP
      ENDIF

    ENDDO


    

    

    

    DO JL_CUADJTQS=KIDIA, KFDIA
      ZQP_CUADJTQS=1.0_JPRB/ZPH 
      ZTARG_CUADJTQS=PTENH (JLON, IK)
      ZFOEEW=YDTHF%R2ES*EXP (Z3ES *(ZTARG_CUADJTQS-YDCST%RTT)/(ZTARG_CUADJTQS-Z4ES ))
      ZQSAT_CUADJTQS=ZQP_CUADJTQS*ZFOEEW

      IF (ZQSAT_CUADJTQS>ZQMAX_CUADJTQS) THEN
        ZQSAT_CUADJTQS=ZQMAX_CUADJTQS
      ENDIF

      ZCOR_CUADJTQS=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT_CUADJTQS)
      ZQSAT_CUADJTQS=ZQSAT_CUADJTQS*ZCOR_CUADJTQS
      Z2S_CUADJTQS=Z5ALCP /(ZTARG_CUADJTQS-Z4ES )**2
      ZCOND1_CUADJTQS=(PQSENH (JLON, IK)-ZQSAT_CUADJTQS)/(1&
      &.0_JPRB+ZQSAT_CUADJTQS*ZCOR_CUADJTQS*Z2S_CUADJTQS)
      PTENH (JLON, IK)=PTENH (JLON, IK)+ZALDCP *ZCOND1_CUADJTQS
      PQSENH (JLON, IK)=PQSENH (JLON, IK)-ZCOND1_CUADJTQS
      ZTARG_CUADJTQS=PTENH (JLON, IK)
      ZFOEEW=YDTHF%R2ES*EXP (Z3ES *(ZTARG_CUADJTQS-YDCST%RTT)/(ZTARG_CUADJTQS-Z4ES ))
      ZQSAT_CUADJTQS=ZQP_CUADJTQS*ZFOEEW

      IF (ZQSAT_CUADJTQS>ZQMAX_CUADJTQS) THEN
        ZQSAT_CUADJTQS=ZQMAX_CUADJTQS
      ENDIF

      ZCOR_CUADJTQS=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT_CUADJTQS)
      ZQSAT_CUADJTQS=ZQSAT_CUADJTQS*ZCOR_CUADJTQS
      Z2S_CUADJTQS=Z5ALCP /(ZTARG_CUADJTQS-Z4ES )**2
      ZCOND1_CUADJTQS=(PQSENH (JLON, IK)-ZQSAT_CUADJTQS)/(1&
      &.0_JPRB+ZQSAT_CUADJTQS*ZCOR_CUADJTQS*Z2S_CUADJTQS)
      PTENH (JLON, IK)=PTENH (JLON, IK)+ZALDCP *ZCOND1_CUADJTQS
      PQSENH (JLON, IK)=PQSENH (JLON, IK)-ZCOND1_CUADJTQS
    ENDDO

  
  
  
  
  
  ELSE
    
    
    ZQMAX=0.5_JPRB

    IF (.NOT.YDEPHLI%LPHYLIN) THEN

      

      

      

      

      

      

      DO JL_CUADJTQ=KIDIA, KFDIA
        ZQP=1.0_JPRB/ZPH 
        ZQSAT=FOEEWMCU (PTENH (JLON, IK))*ZQP
        ZQSAT=MIN (0.5_JPRB, ZQSAT)
        ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
        ZQSAT=ZQSAT*ZCOR
        ZCOND1=(PQSENH (JLON, IK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*FOEDEMCU (PTENH (JLON, IK)))
        PTENH (JLON, IK)=PTENH (JLON, IK)+FOELDCPMCU (PTENH (JLON, IK))*ZCOND1
        PQSENH (JLON, IK)=PQSENH (JLON, IK)-ZCOND1
        ZQSAT=FOEEWMCU (PTENH (JLON, IK))*ZQP
        ZQSAT=MIN (0.5_JPRB, ZQSAT)
        ZCOR=1.0_JPRB/(1.0_JPRB-YDCST%RETV*ZQSAT)
        ZQSAT=ZQSAT*ZCOR
        ZCOND1=(PQSENH (JLON, IK)-ZQSAT)/(1.0_JPRB+ZQSAT*ZCOR*FOEDEMCU (PTENH (JLON, IK)))
        PTENH (JLON, IK)=PTENH (JLON, IK)+FOELDCPMCU (PTENH (JLON, IK))*ZCOND1
        PQSENH (JLON, IK)=PQSENH (JLON, IK)-ZCOND1
      ENDDO

    
    ELSE
    
    
    
    
    ENDIF

  
  
  
  ENDIF


  DO JL=KIDIA, KFDIA
    PQENH (JLON, JK)=MIN (PQEN (JLON, JK-1), PQSEN (JLON, JK-1))+(PQSENH (JLON, JK)-PQSEN (JLON, JK-1))
    PQENH (JLON, JK)=MAX (PQENH (JLON, JK), 0.0_JPRB)
  ENDDO

ENDDO


DO JL=KIDIA, KFDIA
  PTENH (JLON, KLEV)=(YDCST%RCPD*PTEN (JLON, KLEV)+PGEO (JLON, KLEV)-PGEOH (JLON, KLEV))*ZORCPD
  PQENH (JLON, KLEV)=PQEN (JLON, KLEV)
  PTENH (JLON, 1)=PTEN (JLON, 1)
  PQENH (JLON, 1)=PQEN (JLON, 1)
ENDDO


DO JK=1, KLEV
  IK=JK-1

  IF (JK==1)  THEN
      IK=1
  ENDIF


  DO JL=KIDIA, KFDIA
    PTU (JLON, JK)=PTENH (JLON, JK)
    PTD (JLON, JK)=PTENH (JLON, JK)
    PQU (JLON, JK)=PQENH (JLON, JK)
    PQD (JLON, JK)=PQENH (JLON, JK)
    PLU (JLON, JK)=0.0_JPRB
    PUU (JLON, JK)=PUEN (JLON, IK)
    PUD (JLON, JK)=PUEN (JLON, IK)
    PVU (JLON, JK)=PVEN (JLON, IK)
    PVD (JLON, JK)=PVEN (JLON, IK)
    KLAB (JLON, JK)=0
  ENDDO

ENDDO




ENDSUBROUTINE CUININ_OPENACC
