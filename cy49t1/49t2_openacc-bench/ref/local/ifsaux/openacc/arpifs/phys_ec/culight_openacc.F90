SUBROUTINE CULIGHT_OPENACC (PPLDARE, PPLRG, YDTHF, YDCST, YDEPHY, YGFL, YDECUMF&
&, KIDIA, KFDIA, KLON, KLEV, PGAW, PGELAT, PAP, PAPH, PAPHI, PAPHIF, LDLAND, PT&
&, PLU, PMFU, PCAPE, PFPLCL, PFPLCN, PQPFROZ, LDCUM, KCBOT, KCTOP, LDLINOX, PLIGH_TOT&
&, PLIGH_CTG, PCTOPH, PPRECMX, PICE, PCDEPTH, PWMFU, PCHARGE, YDSTACK)
!$ACC ROUTINE (CULIGHT_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE YOEPHY,ONLY:TEPHY
USE YOM_YGFL,ONLY:TYPE_GFLD
USE YOECUMF,ONLY:TECUMF
#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

REAL (KIND=JPRB), INTENT (IN)::PPLDARE
REAL (KIND=JPRB), INTENT (IN)::PPLRG
TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TCST), INTENT (IN)::YDCST
TYPE (TEPHY), INTENT (IN)::YDEPHY
TYPE (TYPE_GFLD), INTENT (IN)::YGFL
TYPE (TECUMF), INTENT (IN)::YDECUMF
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
REAL (KIND=JPRB), INTENT (IN)::PGAW (KLON)
REAL (KIND=JPRB), INTENT (IN)::PGELAT (KLON)
REAL (KIND=JPRB), INTENT (IN)::PT (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAP (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPH (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPHIF (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PAPHI (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PLU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PMFU (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PCAPE (KLON)
REAL (KIND=JPRB), INTENT (IN)::PFPLCL (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PFPLCN (KLON, 0:KLEV)
REAL (KIND=JPRB), INTENT (IN)::PQPFROZ (KLON, KLEV)
LOGICAL, INTENT (IN)::LDCUM (KLON)
LOGICAL, INTENT (IN)::LDLAND (KLON)
INTEGER (KIND=JPIM), INTENT (IN)::KCBOT (KLON)
INTEGER (KIND=JPIM), INTENT (IN)::KCTOP (KLON)
LOGICAL, INTENT (OUT)::LDLINOX (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PLIGH_TOT (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PLIGH_CTG (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PCTOPH (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PPRECMX (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PICE (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PCDEPTH (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PWMFU (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PCHARGE (KLON)
TYPE(STACK), INTENT (IN) :: YDSTACK

INTEGER (KIND=JPIM)::IFREEZ15
INTEGER (KIND=JPIM)::IFREEZ25
INTEGER (KIND=JPIM)::IFREEZ
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::ILEVBOTG
INTEGER (KIND=JPIM)::ILEVTOPG
REAL (KIND=JPRB)::ZBASHG
REAL (KIND=JPRB)::ZGEO2KM
REAL (KIND=JPRB)::ZAREA_REF
REAL (KIND=JPRB)::ZRHO
REAL (KIND=JPRB)::ZDEPTH
REAL (KIND=JPRB)::Z1G
REAL (KIND=JPRB)::ZPCTG
REAL (KIND=JPRB)::ZAREA 
REAL (KIND=JPRB)::ZCBASEH 
REAL (KIND=JPRB)::ZPREC_CV 
REAL (KIND=JPRB)::ZCDEPTH 
REAL (KIND=JPRB)::ZHBMAX
REAL (KIND=JPRB)::ZCOLDDPT
REAL (KIND=JPRB)::ZPFROZEN
REAL (KIND=JPRB)::ZBETA
REAL (KIND=JPRB)::ZQSNOW
REAL (KIND=JPRB)::ZQGRAUP

#include "fcttre.func.h"
INTEGER (KIND=JPIM) :: JLON

JLON = KIDIA



ZHBMAX=1.8_JPRB
Z1G=1.0_JPRB/YDCST%RG
ZGEO2KM=0.001_JPRB*Z1G
PLIGH_TOT (JLON)=0.0_JPRB
PLIGH_CTG (JLON)=0.0_JPRB
PCTOPH (JLON)=-99.0_JPRB
PPRECMX (JLON)=0.0_JPRB
PICE (JLON)=0.0_JPRB
PCDEPTH (JLON)=0.0_JPRB
PWMFU (JLON)=-99.0_JPRB
ZCDEPTH =0.0_JPRB
PCHARGE (JLON)=0.0_JPRB
ZPREC_CV =0.0_JPRB
ZCBASEH =-99.0_JPRB
LDLINOX (JLON)=.FALSE.
ZAREA =1.0E-6_JPRB*4.0_JPRB*YDCST%RPI*YDCST%RA*YDCST%RA*PGAW (JLON)
ZAREA_REF=(20015.1_JPRB/90.0_JPRB)*(17333.6_JPRB/72.0_JPRB)

IF (YGFL%NCHEM/=0.AND.YDEPHY%NLIMODE/=4) THEN
  CALL ABOR1_ACC ('CULIGHT: NCHEM /= 0 .and. NLIMODE /= 4 NOT SUPPORTED')
ENDIF


DO JL=KIDIA, KFDIA

  IF (LDCUM (JLON).AND.KCTOP (JLON)>=1.AND.KCTOP (JLON)<=KLEV) THEN
    ZBASHG=(PAPHIF (JLON, KCBOT (JLON))-PAPHIF (JLON, KLEV))*ZGEO2KM
    PPRECMX (JLON)=MAXVAL (PFPLCL (JLON, KCTOP (JLON):KCBOT&
    & (JLON))+PFPLCN (JLON, KCTOP (JLON):KCBOT (JLON)))

    IF (ZBASHG<(4.0_JPRB/PPLRG).AND.PPRECMX (JLON)>1.E-10_JPRB) THEN
      LDLINOX (JLON)=.TRUE.
      IFREEZ=-1
      IFREEZ25=-1
      IFREEZ15=-1

      DO JK=KLEV, 1,-1

        IF (PT (JLON, JK)<=YDCST%RTT.AND.IFREEZ==-1)  THEN
            IFREEZ=JK
        ENDIF


        IF (PT (JLON, JK)<=YDCST%RTT-25.0_JPRB.AND.IFREEZ25==-1)  THEN
            IFREEZ25=JK
        ENDIF


        IF (PT (JLON, JK)<=YDCST%RTT-15.0_JPRB.AND.IFREEZ15==-1)  THEN
            IFREEZ15=JK
        ENDIF

      ENDDO

      PCTOPH (JLON)=MAX ((PAPHI (JLON, KCTOP (JLON))-PAPHI (JLON, KCBOT (JLON)))*ZGEO2KM, 0.0_JPRB)
      PCDEPTH (JLON)=MAX ((PAPHI (JLON, KCTOP (JLON))-PAPHI (JLON, IFREEZ))*ZGEO2KM, 0.0_JPRB)
      PCDEPTH (JLON)=MIN (PCDEPTH (JLON), PCTOPH (JLON))

      IF (YDEPHY%NLIMODE<=3.OR.YDEPHY%NLIMODE==7) THEN
        PWMFU (JLON)=0.0_JPRB
        ZDEPTH=0.0_JPRB

        DO JK=KCTOP (JLON), KCBOT (JLON)

          IF (PMFU (JLON, JK)>0.0_JPRB) THEN
            ZRHO=PAP (JLON, JK)/(YDCST%RD*PT (JLON, JK))
            ZDEPTH=ZDEPTH+(PAPHI (JLON, JK-1)-PAPHI (JLON, JK))
            PWMFU (JLON)=PWMFU (JLON)+PMFU (JLON, JK)*(PAPHI (JLON, JK-1)-PAPHI (JLON, JK))/ZRHO
          ENDIF

        ENDDO


        IF (ZDEPTH>0.0_JPRB) THEN
          PWMFU (JLON)=PWMFU (JLON)/ZDEPTH
        ELSE
          PWMFU (JLON)=-99.0_JPRB
        ENDIF

      ENDIF


      IF (YDEPHY%NLIMODE<=3) THEN

        DO JK=1, KLEV
          PICE (JLON)=PICE (JLON)+MAX (0.0_JPRB, PLU (JLON, JK)*(1.0_JPRB-FOEALFCU&
          & (PT (JLON, JK))))*(PAPH (JLON, JK)-PAPH (JLON, JK-1))*Z1G
        ENDDO

      ENDIF


      IF (YDEPHY%NLIMODE==6) THEN
        ILEVTOPG=MAX (IFREEZ25, KCTOP (JLON))
        ILEVBOTG=MIN (IFREEZ, KCBOT (JLON))
        ZCBASEH =MAX (0.0_JPRB,(PAPHI (JLON, KCBOT (JLON))-PAPHI (JLON, KLEV))*ZGEO2KM)
        ZCDEPTH =MAX (0.0_JPRB,(PAPHI (JLON, KCTOP (JLON))-PAPHI (JLON, KCBOT (JLON)))*ZGEO2KM)

        IF (LDLAND (JLON)) THEN
          ZBETA=0.70_JPRB
        ELSE
          ZBETA=0.45_JPRB
        ENDIF


        DO JK=ILEVTOPG, ILEVBOTG

          IF (YDECUMF%LMFPEN) THEN
            ZRHO=PAP (JLON, JK)/(YDCST%RD*PT (JLON, JK))
            ZPFROZEN=MAX (0.0_JPRB, PFPLCN (JLON, JK))
            ZQGRAUP=ZBETA*ZPFROZEN/(ZRHO*3.0_JPRB)
            ZQSNOW=(1.0_JPRB-ZBETA)*ZPFROZEN/(ZRHO*0.5_JPRB)
          ELSE
            ZQGRAUP=ZBETA*PQPFROZ (JLON, JK)
            ZQSNOW=(1.0_JPRB-ZBETA)*PQPFROZ (JLON, JK)
          ENDIF

          PCHARGE (JLON)=PCHARGE (JLON)+ZQGRAUP*(MAX (0.0_JPRB, PLU (JLON&
          &, JK))+ZQSNOW)*(PAPH (JLON, JK)-PAPH (JLON, JK-1))*Z1G
        ENDDO

      ENDIF


      IF (YDEPHY%NLIMODE==8) THEN
        ZPREC_CV =MIN ((PFPLCL (JLON, KLEV)+PFPLCN (JLON, KLEV))*86400.0_JPRB, 90.0_JPRB)
      ENDIF


      IF (YDEPHY%NLIMODE==1) THEN

        IF (PCDEPTH (JLON)>1.0_JPRB.AND.(PCTOPH (JLON)-PCDEPTH&
          & (JLON))>0.5_JPRB.AND.PWMFU (JLON)>0.0_JPRB) THEN

          IF (LDLAND (JLON)) THEN
            PLIGH_TOT (JLON)=3.1E-01_JPRB*PICE (JLON)*PWMFU (JLON)*PCDEPTH (JLON)
          ELSE
            PLIGH_TOT (JLON)=1.3E-02_JPRB*PICE (JLON)*PWMFU (JLON)*PCDEPTH (JLON)
          ENDIF

        ENDIF

      ELSEIF (YDEPHY%NLIMODE==2) THEN

        IF (PCDEPTH (JLON)>1.0_JPRB.AND.(PCTOPH (JLON)-PCDEPTH (JLON))>0.7_JPRB&
          &.AND.PCTOPH (JLON)>5.0_JPRB.AND.PWMFU (JLON)>0.05_JPRB) THEN

          IF (LDLAND (JLON)) THEN
            PLIGH_TOT (JLON)=6.5E-01_JPRB*PICE (JLON)*PWMFU (JLON)*PCDEPTH (JLON)
          ELSE
            PLIGH_TOT (JLON)=8.0E-02_JPRB*PICE (JLON)*PWMFU (JLON)*PCDEPTH (JLON)
          ENDIF

        ENDIF

      ELSEIF (YDEPHY%NLIMODE==3) THEN

        IF (PCDEPTH (JLON)>1.0_JPRB.AND.(PCTOPH (JLON)-PCDEPTH (JLON))>0.7_JPRB&
          &.AND.PCTOPH (JLON)>5.0_JPRB.AND.PWMFU (JLON)>0.05_JPRB) THEN

          IF (LDLAND (JLON)) THEN
            PLIGH_TOT (JLON)=4.5E-03_JPRB*(PICE (JLON)*PCDEPTH (JLON))**2.0_JPRB*PWMFU (JLON)**0.5_JPRB
          ELSE
            PLIGH_TOT (JLON)=6.6E-04_JPRB*(PICE (JLON)*PCDEPTH (JLON))**2.0_JPRB*PWMFU (JLON)**0.5_JPRB
          ENDIF

        ENDIF

      ELSEIF (YDEPHY%NLIMODE==4) THEN

        IF (PCTOPH (JLON)>5.0_JPRB.AND.IFREEZ25>0) THEN

          IF (LDLAND (JLON)) THEN
            PLIGH_TOT (JLON)=5.0_JPRB*4.0E6_JPRB*PFPLCL (JLON, KLEV)*1.0E-9_JPRB*YDCST%RDAYI
          ELSE
            PLIGH_TOT (JLON)=0.1_JPRB*(5.0_JPRB*4.0E6_JPRB*PFPLCL (JLON, KLEV)*1.0E-9_JPRB*YDCST%RDAYI)
          ENDIF

        ENDIF

      ELSEIF (YDEPHY%NLIMODE==5) THEN

        IF (IFREEZ>0) THEN

          IF (LDLAND (JLON)) THEN
            PLIGH_TOT (JLON)=3.44E-5_JPRB*PCTOPH (JLON)**4.9_JPRB*(24.0_JPRB*60.0_JPRB/ZAREA )
          ELSE
            PLIGH_TOT (JLON)=6.4E-4_JPRB*PCTOPH (JLON)**1.73_JPRB*(24.0_JPRB*60.0_JPRB/ZAREA )
          ENDIF

        ENDIF

      ELSEIF (YDEPHY%NLIMODE==6) THEN

        IF (ZCDEPTH >4.0_JPRB.AND.PCAPE (JLON)>175._JPRB.AND.ZCBASEH >0.1_JPRB&
          &.AND.KCTOP (JLON)<IFREEZ15.AND.PCDEPTH (JLON)>1.0_JPRB) THEN
          PLIGH_TOT (JLON)=36.0_JPRB*MIN (1.0_JPRB,(SQRT (ZAREA )/30.0_JPRB)**0.15_JPRB&
          &)*PCHARGE (JLON)*SQRT (PCAPE (JLON))*MIN (ZCBASEH , ZHBMAX)**2
        ENDIF

      ELSEIF (YDEPHY%NLIMODE==7) THEN

        IF (PWMFU (JLON)>0.0_JPRB) THEN
          PLIGH_TOT (JLON)=1.54E-5_JPRB*(PWMFU (JLON)*SQRT (PCTOPH&
          & (JLON)*1000.0_JPRB))**4.9_JPRB*(1440.0_JPRB/ZAREA )
        ENDIF

      ELSEIF (YDEPHY%NLIMODE==8) THEN

        IF (ZPREC_CV >7.0_JPRB) THEN

          IF (LDLAND (JLON)) THEN
            PLIGH_CTG (JLON)=3.75E-2_JPRB-4.76E-2_JPRB*ZPREC_CV +5.41E-3_JPRB*ZPREC_CV&
            & **2+3.21E-4_JPRB*ZPREC_CV **3-2.93E-6_JPRB*ZPREC_CV **4
          ELSE
            PLIGH_CTG (JLON)=5.23E-2_JPRB-4.80E-2_JPRB*ZPREC_CV +5.45E-3_JPRB*ZPREC_CV&
            & **2+3.68E-5_JPRB*ZPREC_CV **3-2.42E-7_JPRB*ZPREC_CV **4
          ENDIF

          PLIGH_CTG (JLON)=MAX (PLIGH_CTG (JLON), 0.0_JPRB)
          PLIGH_CTG (JLON)=PLIGH_CTG (JLON)*(1440.0_JPRB/ZAREA_REF)
          ZCOLDDPT=MAX (PCDEPTH (JLON), 5.5_JPRB)

          IF (ZCOLDDPT<14.0_JPRB) THEN
            ZPCTG=1.0_JPRB/(0.021_JPRB*(ZCOLDDPT**4)-0.648_JPRB*(ZCOLDDPT*&
            &*3)+7.49_JPRB*(ZCOLDDPT**2)-36.54_JPRB*ZCOLDDPT+64.09_JPRB)
            ZPCTG=MAX (ZPCTG, 0.0_JPRB)
          ELSE
            ZPCTG=0.02_JPRB
          ENDIF

          PLIGH_TOT (JLON)=PLIGH_CTG (JLON)/ZPCTG
        ENDIF

      ENDIF


      IF (YDEPHY%NLIMODE/=8) THEN

        IF (PCDEPTH (JLON)>5.5_JPRB.AND.PCDEPTH (JLON)<14.0_JPRB) THEN
          ZPCTG=1.0_JPRB/(0.021_JPRB*(PCDEPTH (JLON)**4.0_JPRB)-0.648_JPRB*(PCDEPTH (JLON)**3.0_JPRB&
          &)+7.49_JPRB*(PCDEPTH (JLON)**2.0_JPRB)-36.54_JPRB*PCDEPTH (JLON)+64.09_JPRB)
          PLIGH_CTG (JLON)=ZPCTG*PLIGH_TOT (JLON)
        ELSE
          PLIGH_CTG (JLON)=PLIGH_TOT (JLON)
        ENDIF

      ENDIF

    ENDIF

  ENDIF

ENDDO




ENDSUBROUTINE CULIGHT_OPENACC
