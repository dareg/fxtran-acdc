
SUBROUTINE LAITRIQM3D_OPENACC (YDVETA, LDQM3DCONS, KSLB1, KPROMA, KST, KEND, KFLEV, KFLDN&
&, KFLDX, KQM, PDLAT, PCLA, PDLO, PCLO, KL0, PVINTW, PDVER, PXSL, PXF, YDSTACK)
!$ACC ROUTINE (LAITRIQM3D_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMVERT,ONLY:TVETA
#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (TVETA), INTENT (IN)::YDVETA
LOGICAL, INTENT (IN)::LDQM3DCONS
INTEGER (KIND=JPIM), INTENT (IN)::KSLB1
INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
INTEGER (KIND=JPIM), INTENT (IN)::KFLEV
INTEGER (KIND=JPIM), INTENT (IN)::KFLDN
INTEGER (KIND=JPIM), INTENT (IN)::KFLDX
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KEND
INTEGER (KIND=JPIM), INTENT (IN)::KQM
REAL (KIND=JPRB), INTENT (IN)::PDLAT (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PCLA (KPROMA, KFLEV, 3)
REAL (KIND=JPRB), INTENT (IN)::PDLO (KPROMA, KFLEV, 0:3)
REAL (KIND=JPRB), INTENT (IN)::PCLO (KPROMA, KFLEV, 3, 2)
INTEGER (KIND=JPIM), INTENT (IN)::KL0 (KPROMA, KFLEV, 0:3)
REAL (KIND=JPRB), INTENT (IN)::PVINTW (KPROMA, KFLEV, 3)
REAL (KIND=JPRB), INTENT (IN)::PDVER (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PXSL (KSLB1*(KFLDX-KFLDN+1))
REAL (KIND=JPRB), INTENT (OUT)::PXF (KPROMA, KFLEV)
TYPE(STACK), INTENT (IN) :: YDSTACK
INTEGER (KIND=JPIM)::IL3
INTEGER (KIND=JPIM)::IL2
INTEGER (KIND=JPIM)::IL1
INTEGER (KIND=JPIM)::INX
INTEGER (KIND=JPIM)::IQM
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JLEV
REAL (KIND=JPRB)::Z31
REAL (KIND=JPRB)::Z22
REAL (KIND=JPRB)::Z21
REAL (KIND=JPRB)::Z20
REAL (KIND=JPRB)::Z12
REAL (KIND=JPRB)::Z11
REAL (KIND=JPRB)::Z10
REAL (KIND=JPRB)::Z01
REAL (KIND=JPRB)::ZSURPL (KPROMA)
REAL (KIND=JPRB)::ZXF
REAL (KIND=JPRB)::ZDMIN
REAL (KIND=JPRB)::ZDMAX
REAL (KIND=JPRB)::ZMAX
REAL (KIND=JPRB)::ZMIN
REAL (KIND=JPRB)::ZSUPLO2
REAL (KIND=JPRB)::ZSUPLO1
REAL (KIND=JPRB)::ZSUP
REAL (KIND=JPRB)::ZINFLO2
REAL (KIND=JPRB)::ZINFLO1
REAL (KIND=JPRB)::ZINF
REAL (KIND=JPRB)::Z3 (KPROMA)
REAL (KIND=JPRB)::Z2 (KPROMA)
REAL (KIND=JPRB)::Z1 (KPROMA)
REAL (KIND=JPRB)::Z0 (KPROMA)
REAL (KIND=JPRB)::ZX2 (KPROMA)
REAL (KIND=JPRB)::ZN2 (KPROMA)
REAL (KIND=JPRB)::ZX1 (KPROMA)
REAL (KIND=JPRB)::ZN1 (KPROMA)

#include "interp.func.h"
INTEGER (KIND=JPIM) :: JLON

JLON = KIDIA


IL1=KSLB1
IL2=IL1+KSLB1
IL3=IL2+KSLB1

IF (LDQM3DCONS.AND.(KQM==2)) THEN
  IQM=3
  ZSURPL (:)=0.0_JPRB
ELSE
  IQM=KQM
ENDIF

INX=KSLB1*(KFLDX-KFLDN+1)

DO JLEV=1, KFLEV

  DO JROF=KST, KEND
    Z11=PXSL (KL0 (JROF, JLEV, 1)+1)
    Z11=FDWEIGHT (PDLO (JROF, JLEV, 1), Z11, PXSL (KL0 (JROF, JLEV, 1)+2))
    Z12=PXSL (KL0 (JROF, JLEV, 2)+1)
    Z12=FDWEIGHT (PDLO (JROF, JLEV, 2), Z12, PXSL (KL0 (JROF, JLEV, 2)+2))
    Z0 (JROF)=FDWEIGHT (PDLAT (JROF, JLEV), Z11, Z12)
    Z21=PXSL (IL3+KL0 (JROF, JLEV, 1)+1)
    Z21=FDWEIGHT (PDLO (JROF, JLEV, 1), Z21, PXSL (IL3+KL0 (JROF, JLEV, 1)+2))
    Z22=PXSL (IL3+KL0 (JROF, JLEV, 2)+1)
    Z22=FDWEIGHT (PDLO (JROF, JLEV, 2), Z22, PXSL (IL3+KL0 (JROF, JLEV, 2)+2))
    Z3 (JROF)=FDWEIGHT (PDLAT (JROF, JLEV), Z21, Z22)
  ENDDO


  DO JROF=KST, KEND
    Z01=PXSL (IL1+KL0 (JROF, JLEV, 0)+1)
    Z01=FDWEIGHT (PDLO (JROF, JLEV, 0), Z01, PXSL (IL1+KL0 (JROF, JLEV, 0)+2))
    Z10=PXSL (IL1+KL0 (JROF, JLEV, 1))
    Z11=PXSL (IL1+KL0 (JROF, JLEV, 1)+1)
    Z12=PXSL (IL1+KL0 (JROF, JLEV, 1)+2)
    Z10=FCWEIGHT (PCLO (JROF, JLEV, 1, 1), PCLO (JROF, JLEV, 2, 1), PCLO (JROF&
    &, JLEV, 3, 1), Z10, Z11, Z12, PXSL (IL1+KL0 (JROF, JLEV, 1)+3))
    Z20=PXSL (IL1+KL0 (JROF, JLEV, 2))
    Z21=PXSL (IL1+KL0 (JROF, JLEV, 2)+1)
    Z22=PXSL (IL1+KL0 (JROF, JLEV, 2)+2)
    Z20=FCWEIGHT (PCLO (JROF, JLEV, 1, 2), PCLO (JROF, JLEV, 2, 2), PCLO (JROF&
    &, JLEV, 3, 2), Z20, Z21, Z22, PXSL (IL1+KL0 (JROF, JLEV, 2)+3))
    Z31=PXSL (IL1+KL0 (JROF, JLEV, 3)+1)
    Z31=FDWEIGHT (PDLO (JROF, JLEV, 3), Z31, PXSL (IL1+KL0 (JROF, JLEV, 3)+2))
    Z1 (JROF)=FCWEIGHT (PCLA (JROF, JLEV, 1), PCLA (JROF, JLEV&
    &, 2), PCLA (JROF, JLEV, 3), Z01, Z10, Z20, Z31)
    ZN1 (JROF)=MIN (Z11, Z12, Z21, Z22)
    ZX1 (JROF)=MAX (Z11, Z12, Z21, Z22)
    Z01=PXSL (IL2+KL0 (JROF, JLEV, 0)+1)
    Z01=FDWEIGHT (PDLO (JROF, JLEV, 0), Z01, PXSL (IL2+KL0 (JROF, JLEV, 0)+2))
    Z10=PXSL (IL2+KL0 (JROF, JLEV, 1))
    Z11=PXSL (IL2+KL0 (JROF, JLEV, 1)+1)
    Z12=PXSL (IL2+KL0 (JROF, JLEV, 1)+2)
    Z10=FCWEIGHT (PCLO (JROF, JLEV, 1, 1), PCLO (JROF, JLEV, 2, 1), PCLO (JROF&
    &, JLEV, 3, 1), Z10, Z11, Z12, PXSL (IL2+KL0 (JROF, JLEV, 1)+3))
    Z20=PXSL (IL2+KL0 (JROF, JLEV, 2))
    Z21=PXSL (IL2+KL0 (JROF, JLEV, 2)+1)
    Z22=PXSL (IL2+KL0 (JROF, JLEV, 2)+2)
    Z20=FCWEIGHT (PCLO (JROF, JLEV, 1, 2), PCLO (JROF, JLEV, 2, 2), PCLO (JROF&
    &, JLEV, 3, 2), Z20, Z21, Z22, PXSL (IL2+KL0 (JROF, JLEV, 2)+3))
    Z31=PXSL (IL2+KL0 (JROF, JLEV, 3)+1)
    Z31=FDWEIGHT (PDLO (JROF, JLEV, 3), Z31, PXSL (IL2+KL0 (JROF, JLEV, 3)+2))
    Z2 (JROF)=FCWEIGHT (PCLA (JROF, JLEV, 1), PCLA (JROF, JLEV&
    &, 2), PCLA (JROF, JLEV, 3), Z01, Z10, Z20, Z31)
    ZN2 (JROF)=MIN (Z11, Z12, Z21, Z22)
    ZX2 (JROF)=MAX (Z11, Z12, Z21, Z22)
  ENDDO


  DO JROF=KST, KEND
    PXF (JROF, JLEV)=FCWEIGHT (PVINTW (JROF, JLEV, 1), PVINTW (JROF, JLEV, 2)&
    &, PVINTW (JROF, JLEV, 3), Z0 (JROF), Z1 (JROF), Z2 (JROF), Z3 (JROF))
  ENDDO


  IF (IQM==1) THEN

    DO JROF=KST, KEND
      ZMIN=MIN (ZN1 (JROF), ZN2 (JROF))
      ZMAX=MAX (ZX1 (JROF), ZX2 (JROF))

      IF (PXF (JROF, JLEV)>ZMAX.OR.PXF (JROF, JLEV)<ZMIN) THEN
        Z11=PXSL (IL1+KL0 (JROF, JLEV, 1)+1)
        Z21=PXSL (IL1+KL0 (JROF, JLEV, 2)+1)
        Z12=PXSL (IL2+KL0 (JROF, JLEV, 1)+1)
        Z22=PXSL (IL2+KL0 (JROF, JLEV, 2)+1)
        ZSUPLO1=FDWEIGHT (PDLO (JROF, JLEV, 1), Z11, PXSL (IL1+KL0 (JROF, JLEV, 1)+2))
        ZSUPLO2=FDWEIGHT (PDLO (JROF, JLEV, 2), Z21, PXSL (IL1+KL0 (JROF, JLEV, 2)+2))
        ZINFLO1=FDWEIGHT (PDLO (JROF, JLEV, 1), Z12, PXSL (IL2+KL0 (JROF, JLEV, 1)+2))
        ZINFLO2=FDWEIGHT (PDLO (JROF, JLEV, 2), Z22, PXSL (IL2+KL0 (JROF, JLEV, 2)+2))
        ZSUP=FDWEIGHT (PDLAT (JROF, JLEV), ZSUPLO1, ZSUPLO2)
        ZINF=FDWEIGHT (PDLAT (JROF, JLEV), ZINFLO1, ZINFLO2)
        PXF (JROF, JLEV)=FDWEIGHT (PDVER (JROF, JLEV), ZSUP, ZINF)
      ENDIF

    ENDDO

  ELSEIF (IQM==2) THEN

    DO JROF=KST, KEND
      ZMIN=MIN (ZN1 (JROF), ZN2 (JROF))
      ZMAX=MAX (ZX1 (JROF), ZX2 (JROF))
      PXF (JROF, JLEV)=MAX (ZMIN, MIN (ZMAX, PXF (JROF, JLEV)))
    ENDDO

  ELSEIF (IQM==3) THEN

    DO JROF=KST, KEND
      ZMIN=MIN (ZN1 (JROF), ZN2 (JROF))
      ZMAX=MAX (ZX1 (JROF), ZX2 (JROF))
      ZXF=PXF (JROF, JLEV)+ZSURPL (JROF)
      PXF (JROF, JLEV)=MAX (ZMIN, MIN (ZMAX, ZXF))
      ZDMAX=MAX (ZXF, ZMAX)-ZMAX
      ZDMIN=MIN (ZXF, ZMIN)-ZMIN

      IF (ABS (ZDMAX)>=ABS (ZDMIN)) THEN
        ZSURPL (JROF)=ZDMAX*YDVETA%VETA_LAITRIQM3D (JLEV)
      ELSE
        ZSURPL (JROF)=ZDMIN*YDVETA%VETA_LAITRIQM3D (JLEV)
      ENDIF

    ENDDO

  ENDIF

ENDDO



ENDSUBROUTINE LAITRIQM3D_OPENACC
