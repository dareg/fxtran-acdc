
SUBROUTINE RADHEAT_OPENACC (YDCST, YDTHF, YDERAD, YDERDI, YDML_PHY_MF, KIDIA, KFDIA, KLON&
&, KLEV, PAPHM1, PEMIS, PEMTED, PMU0, PSOLO, PQM1, PTE, PTRSOL, PTRSOD, PTSM1M, PTSPHY, PTRSODIR&
&, PTRSODIF, PALBD, PALBP, PFRSO, PFRTH, PFRSODS, PFRTHDS, PCEMTR, PCTRSO, PFRSOC, PFRTHC&
&, PSUDU, PSDUR, PDSRP, PSFSWDIR, PSFSWDIF, PFRSOPS, PFRSOFS, PFRSOPT, YDSTACK)
!$ACC ROUTINE (RADHEAT_OPENACC) SEQ
USE MODEL_PHYSICS_MF_MOD,ONLY:MODEL_PHYSICS_MF_TYPE
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOETHF,ONLY:TTHF
USE YOERDI,ONLY:TERDI
USE YOERAD,ONLY:TERAD
#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (TCST), INTENT (IN)::YDCST
TYPE (TTHF), INTENT (IN)::YDTHF
TYPE (TERAD), INTENT (IN)::YDERAD
TYPE (TERDI), INTENT (IN)::YDERDI
TYPE (MODEL_PHYSICS_MF_TYPE), INTENT (IN)::YDML_PHY_MF
INTEGER (KIND=JPIM), INTENT (IN)::KIDIA
INTEGER (KIND=JPIM), INTENT (IN)::KFDIA
INTEGER (KIND=JPIM), INTENT (IN)::KLON
INTEGER (KIND=JPIM), INTENT (IN)::KLEV
REAL (KIND=JPRB), INTENT (IN)::PAPHM1 (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PEMIS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PEMTED (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PMU0 (KLON)
REAL (KIND=JPRB), INTENT (IN)::PSOLO (KLON)
REAL (KIND=JPRB), INTENT (IN)::PQM1 (KLON, KLEV)
REAL (KIND=JPRB), INTENT (INOUT)::PTE (KLON, KLEV)
REAL (KIND=JPRB), INTENT (IN)::PTRSOL (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (IN)::PTRSOD (KLON)
REAL (KIND=JPRB), INTENT (IN)::PTSM1M (KLON)
REAL (KIND=JPRB), INTENT (IN)::PTSPHY
REAL (KIND=JPRB), INTENT (IN)::PTRSODIR (KLON, YDERAD%NSW)
REAL (KIND=JPRB), INTENT (IN)::PTRSODIF (KLON, YDERAD%NSW)
REAL (KIND=JPRB), INTENT (IN)::PALBD (KLON, YDERAD%NSW)
REAL (KIND=JPRB), INTENT (IN)::PALBP (KLON, YDERAD%NSW)
REAL (KIND=JPRB), INTENT (OUT)::PFRSO (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PFRTH (KLON, KLEV+1)
REAL (KIND=JPRB), INTENT (OUT)::PFRSODS (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PFRTHDS (KLON)
REAL (KIND=JPRB), INTENT (IN)::PCEMTR (KLON, 2)
REAL (KIND=JPRB), INTENT (IN)::PCTRSO (KLON, 2)
REAL (KIND=JPRB), INTENT (OUT)::PFRSOC (KLON, 2)
REAL (KIND=JPRB), INTENT (OUT)::PFRTHC (KLON, 2)
REAL (KIND=JPRB), INTENT (IN)::PSUDU (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PSDUR (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PDSRP (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PSFSWDIR (KLON, YDERAD%NSW)
REAL (KIND=JPRB), INTENT (OUT)::PSFSWDIF (KLON, YDERAD%NSW)
REAL (KIND=JPRB), INTENT (OUT)::PFRSOPS (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PFRSOFS (KLON)
REAL (KIND=JPRB), INTENT (OUT)::PFRSOPT (KLON)
TYPE(STACK), INTENT (IN) :: YDSTACK
REAL (KIND=JPRB)::ZTH4 
REAL (KIND=JPRB)::ZI0 
REAL (KIND=JPRB)::ZFTE 
REAL (KIND=JPRB)::ZFSO 
REAL (KIND=JPRB)::ZFLT 
REAL (KIND=JPRB)::ZFLB 
REAL (KIND=JPRB)::ZDTDIV 
REAL (KIND=JPRB)::ZDTDT 
INTEGER (KIND=JPIM)::JSW
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::JK
INTEGER (KIND=JPIM)::ILONS
REAL (KIND=JPRB)::ZTMST
REAL (KIND=JPRB)::ZRII0
REAL (KIND=JPRB)::ZCONS3
REAL (KIND=JPRB)::ZCONS1
REAL (KIND=JPRB)::ZBUD

INTEGER (KIND=JPIM) :: JLON

JLON = KIDIA



ZTMST=PTSPHY
ZCONS1=YDERDI%RRAE*(YDERDI%RRAE+2.0_JPRB)
ZCONS3=YDCST%RG/YDCST%RCPD
ILONS=KFDIA-KIDIA+1
ZBUD=1.0_JPRB
ZRII0=YDML_PHY_MF%YRPHY3%RII0

DO JL=KIDIA, KFDIA
  PFRSODS (JLON)=0.0_JPRB
  PFRSOFS (JLON)=0.0_JPRB
  PFRSOPS (JLON)=0.0_JPRB
ENDDO


DO JL=KIDIA, KFDIA

  IF (PMU0 (JLON)>=1.E-10_JPRB) THEN
    ZI0 =PMU0 (JLON)*ZRII0*(1._JPRB-PSOLO (JLON))
  ELSE
    ZI0 =0.0_JPRB
  ENDIF

ENDDO


DO JL=KIDIA, KFDIA
  ZFSO =ZI0 *PTRSOL (JLON, 1)
  ZFTE =PEMTED (JLON, 1)
  PFRTH (JLON, 1)=ZFTE 
  PFRSO (JLON, 1)=ZFSO 
  PFRTHC (JLON, 1)=PCEMTR (JLON, 1)
  PFRSOC (JLON, 1)=ZI0 *PCTRSO (JLON, 1)
ENDDO


DO JK=1, KLEV

  DO JL=KIDIA, KFDIA
    ZFLT =ZFSO +ZFTE 
    ZFSO =ZI0 *PTRSOL (JLON, JK+1)

    IF (JK==KLEV.AND.ZFSO <1.E-15_JPRB) THEN
      ZFSO =1.E-15_JPRB
    ENDIF

    ZFTE =PEMTED (JLON, JK+1)
    ZFLB =ZFSO +ZFTE 
    ZDTDIV =1.0_JPRB/((PAPHM1 (JLON, JK+1)-PAPHM1 (JLON, JK))*(1.0_JPRB+YDTHF%RVTMP2*PQM1 (JLON, JK)))
    ZDTDT =-ZCONS3*(ZFLB -ZFLT )*ZDTDIV 
    PTE (JLON, JK)=PTE (JLON, JK)+ZDTDT 
  ENDDO


  DO JL=KIDIA, KFDIA
    PFRTH (JLON, JK+1)=ZFTE 
    PFRSO (JLON, JK+1)=ZFSO 
  ENDDO

ENDDO


DO JL=KIDIA, KFDIA
  PFRTHC (JLON, 2)=PCEMTR (JLON, 2)
  PFRSOC (JLON, 2)=ZI0 *PCTRSO (JLON, 2)
ENDDO


DO JL=KIDIA, KFDIA
  PDSRP (JLON)=ZI0 *PSUDU (JLON)

  IF (PDSRP (JLON)>=YDERDI%RSUNDUR) THEN
    PSDUR (JLON)=1.0_JPRB
  ELSE
    PSDUR (JLON)=0.0_JPRB
  ENDIF

  ZTH4 =YDCST%RSIGMA*PTSM1M (JLON)**4
  PFRTHDS (JLON)=(PEMTED (JLON, KLEV+1)+PEMIS (JLON)*ZTH4 )/PEMIS (JLON)
  PFRSOPT (JLON)=ZI0 
ENDDO


IF (YDML_PHY_MF%YRARPHY%LMSE.OR.YDML_PHY_MF%YRPHY%LHLRADUPD) THEN

  DO JSW=1, YDERAD%NSW

    DO JL=KIDIA, KFDIA
      ZFSO =MAX (ZI0 *PTRSODIR (JLON, JSW), 1.E-15_JPRB)
      PSFSWDIR (JLON, JSW)=ZFSO /(1.0_JPRB-PALBP (JLON, JSW))
      ZFSO =MAX (ZI0 *PTRSODIF (JLON, JSW), 1.E-15_JPRB)
      PSFSWDIF (JLON, JSW)=ZFSO /(1.0_JPRB-PALBD (JLON, JSW))
      PFRSOPS (JLON)=PFRSOPS (JLON)+PSFSWDIR (JLON, JSW)
      PFRSOFS (JLON)=PFRSOFS (JLON)+PSFSWDIF (JLON, JSW)
      PFRSODS (JLON)=PFRSODS (JLON)+PSFSWDIF (JLON, JSW)+PSFSWDIR (JLON, JSW)
    ENDDO

  ENDDO

ELSE

  DO JL=KIDIA, KFDIA
    PFRSODS (JLON)=ZI0 *PTRSOD (JLON)
  ENDDO

ENDIF




ENDSUBROUTINE RADHEAT_OPENACC
