SUBROUTINE LATTEX_DNT_OPENACC (KSTEP, YDGEOMETRY, YDLDDH, YDRIP, YDDYN, YDDYNA, KST, KEND&
&, LDSETTLS, KXLAG, PESGP, PESGM, PXT0, PXT9, PMOY1X, PMIXNL, PXSI, PXNLT9, PXT1, PXL0&
&, PXL9, PXLF9, PCXNLT9, PSIDDHXT1, PSIDDHXT9, PSIDDHXL0, PXLF0, LDNESC, YDSTACK)
!$ACC ROUTINE (LATTEX_DNT_OPENACC) SEQ
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMDYNA,ONLY:TDYNA
USE YOMDYN,ONLY:TDYN
USE YOMRIP,ONLY:TRIP
USE YOMLDDH,ONLY:TLDDH
#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

INTEGER (KIND=JPIM), INTENT (IN)::KSTEP
TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
TYPE (TLDDH), INTENT (IN)::YDLDDH
TYPE (TRIP), INTENT (IN)::YDRIP
TYPE (TDYN), INTENT (IN)::YDDYN
TYPE (TDYNA), INTENT (IN)::YDDYNA
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KEND
LOGICAL, INTENT (IN)::LDSETTLS
INTEGER (KIND=JPIM), INTENT (IN)::KXLAG
REAL (KIND=JPRB), INTENT (IN)::PESGP
REAL (KIND=JPRB), INTENT (IN)::PESGM
REAL (KIND=JPRB), INTENT (IN)::PXT0 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PXT9 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PMOY1X (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PMIXNL (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PXSI (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PXNLT9 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PXT1 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PXL0 (YDGEOMETRY%YRDIM%NPROMA&
&, YDGEOMETRY%YRDIMV%NFLSA:YDGEOMETRY%YRDIMV%NFLEN)
REAL (KIND=JPRB), INTENT (INOUT)::PXL9 (YDGEOMETRY%YRDIM%NPROMA&
&, YDGEOMETRY%YRDIMV%NFLSA:YDGEOMETRY%YRDIMV%NFLEN)
REAL (KIND=JPRB), INTENT (INOUT)::PXLF9 (YDGEOMETRY%YRDIM%NPROMA&
&, YDGEOMETRY%YRDIMV%NFLSA:YDGEOMETRY%YRDIMV%NFLEN)
REAL (KIND=JPRB), INTENT (INOUT)::PCXNLT9 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PSIDDHXT1 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PSIDDHXT9 (YDGEOMETRY%YRDIM%NPROMA, YDGEOMETRY%YRDIMV%NFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PSIDDHXL0 (YDGEOMETRY%YRDIM&
&%NPROMA, YDGEOMETRY%YRDIMV%NFLSA:YDGEOMETRY%YRDIMV%NFLEN)
REAL (KIND=JPRB), INTENT (OUT)::PXLF0 (YDGEOMETRY%YRDIM%NPROMA&
&, YDGEOMETRY%YRDIMV%NFLSA:YDGEOMETRY%YRDIMV%NFLEN)
LOGICAL, INTENT (IN), OPTIONAL::LDNESC
TYPE(STACK), INTENT (IN) :: YDSTACK
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JLEV
REAL (KIND=JPRB)::ZXNLT1 
REAL (KIND=JPRB)::ZXNLT0 
REAL (KIND=JPRB)::ZXIGP
REAL (KIND=JPRB)::ZXIDT9
REAL (KIND=JPRB)::ZXIDT0
REAL (KIND=JPRB)::ZMIXNL
REAL (KIND=JPRB)::ZSETTLS
REAL (KIND=JPRB)::ZNESC
LOGICAL::LLNESC
LOGICAL::LLCT

INTEGER (KIND=JPIM) :: JLON

JLON = KIDIA







IF (PRESENT (LDNESC)) THEN
  LLNESC=LDNESC
ELSE
  LLNESC=YDDYNA%LNESC
ENDIF

LLCT=(YDDYNA%LPC_FULL.AND.YDDYN%NCURRENT_ITER>0)
ZXIDT0=1.0_JPRB+YDDYN%XIDT
ZXIDT9=1.0_JPRB+YDDYN%XIDT
ZXIGP=1.0_JPRB+YDDYN%XIDT

IF (.NOT.LLCT) THEN

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

    DO JROF=KST, KEND
      ZXNLT0 =PMOY1X (JLON, JLEV)+ZXIDT0*PXSI (JLON, JLEV)
    ENDDO


    IF ((KXLAG==2).AND.(YDDYN%NSPLTHOI/=0)) THEN

      IF (KSTEP<=YDRIP%NFOST.OR.LLNESC) THEN

        DO JROF=KST, KEND
          PXL9 (JLON, JLEV)=PXL9 (JLON, JLEV)+PXT0 (JLON, JLEV)
          PXLF9 (JLON, JLEV)=PXLF9 (JLON, JLEV)+PESGM*PMOY1X (JLON, JLEV)
          PXT1 (JLON, JLEV)=PXT1 (JLON, JLEV)+PESGP*ZXNLT0 
        ENDDO

      ELSEIF (LDSETTLS) THEN

        DO JROF=KST, KEND
          PXL9 (JLON, JLEV)=PXL9 (JLON, JLEV)+PXT0 (JLON, JLEV)
          ZNESC=PESGM*PMOY1X (JLON, JLEV)
          ZSETTLS=PESGM*PMOY1X (JLON, JLEV)+(ZXNLT0 -PXNLT9 (JLON, JLEV))
          ZMIXNL=PMIXNL (JLON, JLEV)
          PXLF9 (JLON, JLEV)=PXLF9 (JLON, JLEV)+ZMIXNL*ZSETTLS+(1.0_JPRB-ZMIXNL)*ZNESC
          PXT1 (JLON, JLEV)=PXT1 (JLON, JLEV)+PESGP*ZXNLT0 
        ENDDO

      ELSE

        DO JROF=KST, KEND
          PXL9 (JLON, JLEV)=PXL9 (JLON, JLEV)+PXT0 (JLON, JLEV)
          PXLF9 (JLON, JLEV)=PXLF9 (JLON, JLEV)+PESGM*PMOY1X (JLON&
          &, JLEV)+0.5_JPRB*PESGM*(ZXNLT0 -PXNLT9 (JLON, JLEV))
          PXT1 (JLON, JLEV)=PXT1 (JLON, JLEV)+PESGP*(1.5_JPRB*ZXNLT0 -0.5_JPRB*PXNLT9 (JLON, JLEV))
        ENDDO

      ENDIF

    ELSEIF ((KXLAG==2).AND.(YDDYN%NSPLTHOI==0)) THEN

      IF (KSTEP<=YDRIP%NFOST.OR.LLNESC) THEN

        DO JROF=KST, KEND
          PXL9 (JLON, JLEV)=PXL9 (JLON, JLEV)+PXT0 (JLON, JLEV)+PESGM*PMOY1X (JLON, JLEV)
          PXT1 (JLON, JLEV)=PXT1 (JLON, JLEV)+PESGP*ZXNLT0 
        ENDDO

      ELSEIF (LDSETTLS) THEN

        DO JROF=KST, KEND
          ZNESC=PXT0 (JLON, JLEV)+PESGM*PMOY1X (JLON, JLEV)
          ZSETTLS=PXT0 (JLON, JLEV)+PESGM*PMOY1X (JLON, JLEV)+(ZXNLT0 -PXNLT9 (JLON, JLEV))
          ZMIXNL=PMIXNL (JLON, JLEV)
          PXL9 (JLON, JLEV)=PXL9 (JLON, JLEV)+ZMIXNL*ZSETTLS+(1.0_JPRB-ZMIXNL)*ZNESC
          PXT1 (JLON, JLEV)=PXT1 (JLON, JLEV)+PESGP*ZXNLT0 
        ENDDO

      ELSE

        DO JROF=KST, KEND
          PXL9 (JLON, JLEV)=PXL9 (JLON, JLEV)+PXT0 (JLON, JLEV)+PESGM*PMOY1X&
          & (JLON, JLEV)+0.5_JPRB*PESGM*(ZXNLT0 -PXNLT9 (JLON, JLEV))
          PXT1 (JLON, JLEV)=PXT1 (JLON, JLEV)+PESGP*(1.5_JPRB*ZXNLT0 -0.5_JPRB*PXNLT9 (JLON, JLEV))
        ENDDO

      ENDIF

    ELSEIF (KXLAG>=3) THEN

      IF (KSTEP<=YDRIP%NFOST.OR.LLNESC) THEN

        DO JROF=KST, KEND
          PXL0 (JLON, JLEV)=PXL0 (JLON, JLEV)+PESGM*PMOY1X (JLON, JLEV)
          PXT1 (JLON, JLEV)=PXT1 (JLON, JLEV)+PESGP*ZXNLT0 
        ENDDO

      ELSEIF (LDSETTLS) THEN

        IF (YDDYNA%LPC_CHEAP) THEN

          DO JROF=KST, KEND
            ZNESC=PESGM*PMOY1X (JLON, JLEV)
            ZSETTLS=ZXNLT0 -PXNLT9 (JLON, JLEV)
            ZMIXNL=PMIXNL (JLON, JLEV)
            PXL0 (JLON, JLEV)=PXL0 (JLON, JLEV)+ZNESC
            PXLF0 (JLON, JLEV)=ZMIXNL*ZSETTLS
            PXT1 (JLON, JLEV)=PXT1 (JLON, JLEV)+PESGP*ZXNLT0 
          ENDDO

        ELSE

          DO JROF=KST, KEND
            ZNESC=PESGM*PMOY1X (JLON, JLEV)
            ZSETTLS=ZXNLT0 -PXNLT9 (JLON, JLEV)
            ZMIXNL=PMIXNL (JLON, JLEV)
            PXL0 (JLON, JLEV)=PXL0 (JLON, JLEV)+ZNESC+ZMIXNL*ZSETTLS
            PXT1 (JLON, JLEV)=PXT1 (JLON, JLEV)+PESGP*ZXNLT0 
          ENDDO

        ENDIF

      ELSE

        DO JROF=KST, KEND
          PXL0 (JLON, JLEV)=PXL0 (JLON, JLEV)+PESGM*PMOY1X (JLON,&
          & JLEV)+0.5_JPRB*PESGM*(ZXNLT0 -PXNLT9 (JLON, JLEV))
          PXT1 (JLON, JLEV)=PXT1 (JLON, JLEV)+PESGP*(1.5_JPRB*ZXNLT0 -0.5_JPRB*PXNLT9 (JLON, JLEV))
        ENDDO

      ENDIF


      DO JROF=KST, KEND
        PXL9 (JLON, JLEV)=PXL9 (JLON, JLEV)+PXT0 (JLON, JLEV)
      ENDDO

    ENDIF


    IF (YDDYNA%LPC_FULL) THEN
      PCXNLT9 (JLON, JLEV)=PMOY1X (JLON, JLEV)
    ENDIF


    IF (.NOT.LLNESC) THEN

      DO JROF=KST, KEND
        PXNLT9 (JLON, JLEV)=PMOY1X (JLON, JLEV)+ZXIDT9*PXSI (JLON, JLEV)
      ENDDO

    ENDIF

  ENDDO

ELSE

  DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

    DO JROF=KST, KEND
      ZXNLT1 =PMOY1X (JLON, JLEV)+ZXIDT9*PXSI (JLON, JLEV)
    ENDDO


    IF (KXLAG==2) THEN

      IF (.NOT.YDDYNA%LPC_CHEAP) THEN

        IF (YDDYN%NSPLTHOI/=0) THEN

          DO JROF=KST, KEND
            PXL9 (JLON, JLEV)=PXL9 (JLON, JLEV)+PXT9 (JLON, JLEV)
            PXLF9 (JLON, JLEV)=PXLF9 (JLON, JLEV)+PESGM*PCXNLT9 (JLON, JLEV)
          ENDDO

        ELSE

          DO JROF=KST, KEND
            PXL9 (JLON, JLEV)=PXL9 (JLON, JLEV)+PXT9 (JLON, JLEV)+PESGM*PCXNLT9 (JLON, JLEV)
          ENDDO

        ENDIF

      ENDIF


      DO JROF=KST, KEND
        PXT1 (JLON, JLEV)=PXT1 (JLON, JLEV)+PESGP*ZXNLT1 
      ENDDO

    ELSEIF (KXLAG>=3) THEN

      IF (.NOT.YDDYNA%LPC_CHEAP) THEN

        DO JROF=KST, KEND
          PXL0 (JLON, JLEV)=PXL0 (JLON, JLEV)+PESGM*PCXNLT9 (JLON, JLEV)
          PXL9 (JLON, JLEV)=PXL9 (JLON, JLEV)+PXT9 (JLON, JLEV)
        ENDDO

      ENDIF


      DO JROF=KST, KEND
        PXT1 (JLON, JLEV)=PXT1 (JLON, JLEV)+PESGP*ZXNLT1 
      ENDDO

    ENDIF

  ENDDO

ENDIF


DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

  IF (YDDYN%XIDT>0.0_JPRB) THEN

    DO JROF=KST, KEND
      PXT1 (JLON, JLEV)=PXT1 (JLON, JLEV)-ZXIGP*PXSI (JLON, JLEV)
      PXSI (JLON, JLEV)=ZXIGP*PXSI (JLON, JLEV)
    ENDDO

  ELSE

    DO JROF=KST, KEND
      PXT1 (JLON, JLEV)=PXT1 (JLON, JLEV)-PESGP*PXSI (JLON, JLEV)
      PXSI (JLON, JLEV)=PESGP*PXSI (JLON, JLEV)
    ENDDO

  ENDIF

ENDDO


IF (YDLDDH%LRSIDDH) THEN

  IF (.NOT.LLCT) THEN

    IF (KXLAG>=3) THEN

      IF (KSTEP<=YDRIP%NFOST.OR.LLNESC) THEN

        DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

          DO JROF=KST, KEND
            PSIDDHXT1 (JLON, JLEV)=PSIDDHXT1 (JLON, JLEV)+PESGP*ZXIDT0*PXSI (JLON, JLEV)
          ENDDO

        ENDDO

      ELSEIF (LDSETTLS) THEN

        DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

          DO JROF=KST, KEND
            PSIDDHXL0 (JLON, JLEV)=PSIDDHXL0 (JLON, JLEV)+(ZXIDT0*PXSI (JLON, JLEV)-PSIDDHXT9 (JLON, JLEV))
            PSIDDHXT1 (JLON, JLEV)=PSIDDHXT1 (JLON, JLEV)+PESGP*ZXIDT0*PXSI (JLON, JLEV)
          ENDDO

        ENDDO

      ELSE

        DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

          DO JROF=KST, KEND
            PSIDDHXL0 (JLON, JLEV)=PSIDDHXL0 (JLON, JLEV)+0.5_JPRB*PESGM&
            &*(ZXIDT0*PXSI (JLON, JLEV)-PSIDDHXT9 (JLON, JLEV))
            PSIDDHXT1 (JLON, JLEV)=PSIDDHXT1 (JLON, JLEV)+PESGP*(1.5_JPRB&
            &*ZXIDT0*PXSI (JLON, JLEV)-0.5_JPRB*PSIDDHXT9 (JLON, JLEV))
          ENDDO

        ENDDO

      ENDIF

    ENDIF


    IF (.NOT.LLNESC) THEN

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

        DO JROF=KST, KEND
          PSIDDHXT9 (JLON, JLEV)=ZXIDT9*PXSI (JLON, JLEV)
        ENDDO

      ENDDO

    ENDIF

  ELSE

    IF (KXLAG>=3) THEN

      DO JLEV=1, YDGEOMETRY%YRDIMV%NFLEVG

        DO JROF=KST, KEND
          PSIDDHXT1 (JLON, JLEV)=PSIDDHXT1 (JLON, JLEV)+PESGP*ZXIDT9*PXSI (JLON, JLEV)
        ENDDO

      ENDDO

    ENDIF

  ENDIF

ENDIF





ENDSUBROUTINE LATTEX_DNT_OPENACC
