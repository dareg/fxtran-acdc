SUBROUTINE GPGW_OPENACC (YDGEOMETRY, LDNHDYN, KFLEV, KPROMA, KST, KEND, LDGWF, LDGDWI, POROGL, POROGM&
&, PLNPR, PALPH, PUS, PVS, PRT, PDVER, PGWH, PGWF, LDVFE, PRNHPPI, PTAUD_NL, PGDW, YDSTACK)
!$ACC ROUTINE (GPGW_OPENACC) SEQ
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE PARKIND1,ONLY:JPIM, JPRB

#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
LOGICAL, INTENT (IN)::LDNHDYN
INTEGER (KIND=JPIM), INTENT (IN)::KEND
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
INTEGER (KIND=JPIM), INTENT (IN)::KFLEV
LOGICAL, INTENT (IN)::LDGDWI
LOGICAL, INTENT (IN)::LDGWF
REAL (KIND=JPRB), INTENT (IN)::POROGL (KPROMA)
REAL (KIND=JPRB), INTENT (IN)::POROGM (KPROMA)
REAL (KIND=JPRB), INTENT (IN)::PLNPR (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PALPH (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PUS (KPROMA)
REAL (KIND=JPRB), INTENT (IN)::PVS (KPROMA)
REAL (KIND=JPRB), INTENT (IN)::PRT (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PDVER (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), TARGET::PGWH (KPROMA, 0:KFLEV)
REAL (KIND=JPRB), INTENT (OUT)::PGWF (KPROMA, KFLEV)
LOGICAL, INTENT (IN), OPTIONAL::LDVFE
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PRNHPPI (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PTAUD_NL
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PGDW (KPROMA, KFLEV)
TYPE(STACK), INTENT (IN) :: YDSTACK
TYPE(STACK) :: YLSTACK
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JLEV
REAL (KIND=JPRB), TARGET::ZGDW0 (KPROMA, KFLEV)
REAL (KIND=JPRB)::ZIN (KPROMA, 0:KFLEV+1)
REAL (KIND=JPRB), CONTIGUOUS, POINTER::ZGDW (KPROMA, KFLEV)
REAL (KIND=JPRB)::ZRNHPPI (KPROMA, KFLEV)
REAL (KIND=JPRB)::ZNHPPI
LOGICAL::LLVFE


#include "verdisint_openacc.intfb.h"
INTEGER (KIND=JPIM) :: JLON

YLSTACK = YDSTACK



JLON = KIDIA



IF (PRESENT (LDVFE)) THEN
  LLVFE=LDVFE
ELSE
  LLVFE=YDGEOMETRY%YRVERT_GEOM%YRCVER%LVERTFE.AND.(YDGEOMETRY%YRVERT_GEOM%YRCVER%LVFE_GW&
  &.OR..NOT.LDNHDYN).AND.(.NOT.YDGEOMETRY%YRVERT_GEOM%YRCVER%LVFE_COMPATIBLE)
ENDIF


IF (LLVFE.AND.PRESENT (PGDW)) THEN
  assoc (ZGDW, PGDW)
ELSE
  assoc (ZGDW, ZGDW0)
ENDIF

PGWH (KST:KEND, KFLEV)=PUS (KST:KEND)*POROGL (KST:KEND)+PVS (KST:KEND)*POROGM (KST:KEND)

IF (LDGDWI) THEN

  DO JLEV=1, KFLEV

    DO JROF=KST, KEND
      ZGDW (JROF, JLEV)=PDVER (JROF, JLEV)
    ENDDO

  ENDDO

ELSEIF (PRESENT (PRNHPPI)) THEN

  IF (PRESENT (PTAUD_NL)) THEN

    DO JLEV=1, KFLEV

      DO JROF=KST, KEND
        ZNHPPI=1.0_JPRB+PTAUD_NL*(1.0_JPRB/PRNHPPI (JROF, JLEV)-1.0_JPRB)
        ZRNHPPI (JROF, JLEV)=1.0_JPRB/ZNHPPI
      ENDDO

    ENDDO

  ELSE
    ZRNHPPI (KST:KEND, 1:KFLEV)=PRNHPPI (KST:KEND, 1:KFLEV)
  ENDIF


  DO JLEV=1, KFLEV

    DO JROF=KST, KEND
      ZGDW (JROF, JLEV)=PDVER (JROF, JLEV)*PRT (JROF, JLEV)*PLNPR (JROF, JLEV)*PRNHPPI (JROF, JLEV)
    ENDDO

  ENDDO

ELSE

  DO JLEV=1, KFLEV

    DO JROF=KST, KEND
      ZGDW (JROF, JLEV)=PDVER (JROF, JLEV)*PRT (JROF, JLEV)*PLNPR (JROF, JLEV)
    ENDDO

  ENDDO

ENDIF


IF (LLVFE) THEN

  DO JLEV=1, KFLEV
    ZIN (KST:KEND, JLEV)=-ZGDW (KST:KEND, JLEV)*YDGEOMETRY%YRVERT_GEOM%YRVETA%VFE_RDETAH (JLEV)
  ENDDO


  IF (LDGDWI) THEN
    ZIN (KST:KEND, 0)=ZGDW (KST:KEND, 1)
    ZIN (KST:KEND, KFLEV+1)=ZGDW (KST:KEND, KFLEV)
    CALL VERDISINT_OPENACC (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM%YRCVER,'ITOP','00&
    &', KPROMA, KST, KEND, KFLEV, ZIN, PGWF, PINS=PGWH (:, KFLEV), KLOUT=KFLEV, YDSTACK=YLSTACK)
  ELSEIF (LDNHDYN) THEN
    ZIN (KST:KEND, 0)=ZGDW (KST:KEND, 1)
    ZIN (KST:KEND, KFLEV+1)=ZGDW (KST:KEND, KFLEV)
    CALL VERDISINT_OPENACC (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM%YRCVER,'INGW','00&
    &', KPROMA, KST, KEND, KFLEV, ZIN, PGWF, PINS=PGWH (:, KFLEV), KLOUT=KFLEV, YDSTACK=YLSTACK)
  ELSE
    ZIN (KST:KEND, 0)=0.0_JPRB
    ZIN (KST:KEND, KFLEV+1)=0.0_JPRB
    CALL VERDISINT_OPENACC (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM%YRCVER,'IBOT&
    &','11', KPROMA, KST, KEND, KFLEV, ZIN, PGWF, PINS=PGWH (:, KFLEV), YDSTACK=YLSTACK)
  ENDIF

ELSE

  IF (YDGEOMETRY%YRVERT_GEOM%YRCVER%LVFE_COMPATIBLE) THEN

    DO JLEV=KFLEV, 1,-1

      DO JROF=KST, KEND
        PGWH (JROF, JLEV-1)=PGWH (JROF, JLEV)+(ZGDW (JROF, JLEV&
        &)/YDGEOMETRY%YRVERT_GEOM%YRVETA%VDETA_RATIO (JLEV))
      ENDDO

    ENDDO


    IF (LDGWF) THEN

      IF (LDGDWI)  THEN
          CALL ABOR1_ACC (' GPGW: compute "Gw" at full levels: case not coded')
      ENDIF


      DO JLEV=1, KFLEV

        DO JROF=KST, KEND
          ZIN (JROF, JLEV)=-ZGDW (JROF, JLEV)*(YDGEOMETRY%YRVERT_GEOM%YRVETA%VDETA_RATIO&
          & (JLEV)/YDGEOMETRY%YRVERT_GEOM%YRVETA%VFE_RDETAH (JLEV))
        ENDDO

      ENDDO

      ZIN (KST:KEND, 0)=0.0_JPRB
      ZIN (KST:KEND, KFLEV+1)=0.0_JPRB
      CALL VERDISINT_OPENACC (YDGEOMETRY%YRVERT_GEOM%YRVFE, YDGEOMETRY%YRVERT_GEOM%YRCVER,'IBOT&
      &','11', KPROMA, KST, KEND, KFLEV, ZIN, PGWF, PINS=PGWH (:, KFLEV), YDSTACK=YLSTACK)
    ENDIF

  ELSE

    DO JLEV=KFLEV, 1,-1

      DO JROF=KST, KEND
        PGWH (JROF, JLEV-1)=PGWH (JROF, JLEV)+ZGDW (JROF, JLEV)
      ENDDO

    ENDDO


    IF (LDGWF) THEN

      IF (LDGDWI)  THEN
          CALL ABOR1_ACC (' GPGW: compute "Gw" at full levels: case not coded')
      ENDIF


      IF (PRESENT (PRNHPPI)) THEN

        DO JLEV=1, KFLEV

          DO JROF=KST, KEND
            PGWF (JROF, JLEV)=PGWH (JROF, JLEV)+PDVER (JROF, JLEV)*PRT&
            & (JROF, JLEV)*PALPH (JROF, JLEV)*ZRNHPPI (JROF, JLEV)
          ENDDO

        ENDDO

      ELSE

        DO JLEV=1, KFLEV

          DO JROF=KST, KEND
            PGWF (JROF, JLEV)=PGWH (JROF, JLEV)+PDVER (JROF, JLEV)*PRT (JROF, JLEV)*PALPH (JROF, JLEV)
          ENDDO

        ENDDO

      ENDIF

    ENDIF

  ENDIF

ENDIF



ENDSUBROUTINE GPGW_OPENACC
