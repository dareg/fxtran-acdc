
SUBROUTINE GNHPRE_OPENACC (YDGEOMETRY, KPDVAR, KPROMA, KFLEV, KST, KEND,&
& PSPD, PREF, PKAP, PNHPREF, PNHPPI, PRNHPPI, PDEP, PEQCHAF, YDSTACK)
!$ACC ROUTINE (GNHPRE_OPENACC) SEQ
USE GEOMETRY_MOD,ONLY:GEOMETRY
USE PARKIND1,ONLY:JPIM, JPRB

#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (GEOMETRY), INTENT (IN)::YDGEOMETRY
INTEGER (KIND=JPIM), INTENT (IN)::KPDVAR
INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
INTEGER (KIND=JPIM), INTENT (IN)::KFLEV
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KEND
REAL (KIND=JPRB), INTENT (IN)::PSPD (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN)::PREF (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (IN), OPTIONAL::PKAP
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL::PNHPREF (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PNHPPI (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL::PRNHPPI (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL::PDEP (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL::PEQCHAF (KPROMA, KFLEV)
TYPE(STACK), INTENT (IN) :: YDSTACK
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JLEV
REAL (KIND=JPRB), TARGET::ZNHPPI0 (KPROMA, KFLEV)
REAL (KIND=JPRB), CONTIGUOUS, POINTER::ZNHPPI (KPROMA, KFLEV)
REAL (KIND=JPRB)::Z1SKAP

INTEGER (KIND=JPIM) :: JLON

JLON = KIDIA



IF ((KPDVAR==3.OR.PRESENT (PEQCHAF)).AND.(.NOT.PRESENT (PKAP))) THEN
  CALL ABOR1_ACC (' GNHPRE: missing optional input arguments!')
ENDIF


IF (PRESENT (PNHPPI)) THEN
  assoc (ZNHPPI, PNHPPI)
ELSE
  assoc (ZNHPPI, ZNHPPI0)
ENDIF


IF (KPDVAR==2) THEN

  DO JLEV=1, KFLEV

    DO JROF=KST, KEND
      ZNHPPI (JROF, JLEV)=EXP (PSPD (JROF, JLEV))
    ENDDO

  ENDDO


  IF (PRESENT (PKAP).AND.PRESENT (PEQCHAF)) THEN

    DO JLEV=1, KFLEV

      DO JROF=KST, KEND
        PEQCHAF (JROF, JLEV)=EXP (PKAP*PSPD (JROF, JLEV))
      ENDDO

    ENDDO

  ENDIF

ELSEIF (KPDVAR==3) THEN

  DO JLEV=1, KFLEV

    DO JROF=KST, KEND
      Z1SKAP=1.0_JPRB/PKAP
      ZNHPPI (JROF, JLEV)=EXP (LOG (1.0_JPRB+PKAP*PSPD (JROF, JLEV))*Z1SKAP)
    ENDDO

  ENDDO


  IF (PRESENT (PEQCHAF)) THEN

    DO JLEV=1, KFLEV

      DO JROF=KST, KEND
        PEQCHAF (JROF, JLEV)=1.0_JPRB+PKAP*PSPD (JROF, JLEV)
      ENDDO

    ENDDO

  ENDIF

ENDIF


IF (PRESENT (PNHPREF)) THEN

  DO JLEV=1, KFLEV

    DO JROF=KST, KEND
      PNHPREF (JROF, JLEV)=ZNHPPI (JROF, JLEV)*PREF (JROF, JLEV)
    ENDDO

  ENDDO

ENDIF


IF (PRESENT (PRNHPPI)) THEN

  DO JLEV=1, KFLEV

    DO JROF=KST, KEND
      PRNHPPI (JROF, JLEV)=1.0_JPRB/ZNHPPI (JROF, JLEV)
    ENDDO

  ENDDO

ENDIF


IF (PRESENT (PDEP)) THEN

  DO JLEV=1, KFLEV

    DO JROF=KST, KEND
      PDEP (JROF, JLEV)=(ZNHPPI (JROF, JLEV)-1.0_JPRB)*PREF (JROF, JLEV)
    ENDDO

  ENDDO

ENDIF



ENDSUBROUTINE GNHPRE_OPENACC
