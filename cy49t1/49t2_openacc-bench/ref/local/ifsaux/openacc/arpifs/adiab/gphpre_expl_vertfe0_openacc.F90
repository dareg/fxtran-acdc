SUBROUTINE GPHPRE_EXPL_VERTFE0_OPENACC (YDCVER, TOPPRES, YDCST, KPROMA&
&, KFLEV, KST, KEND, YDVAB, PRESH, PRESF, LHSET, LDELP, LALPHA, LRTGR&
&, LRPP, PDELP, PLNPR, PRDELP, PALPH, PRTGR, PRPRE, PRPP, YDSTACK)
!$ACC ROUTINE (GPHPRE_EXPL_VERTFE0_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOMVERT,ONLY:TVAB
USE YOMCVER,ONLY:TCVER
#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (TCVER), INTENT (IN)::YDCVER
REAL (KIND=JPRB), INTENT (IN)::TOPPRES
TYPE (TCST), INTENT (IN)::YDCST
INTEGER (KIND=JPIM), INTENT (IN)::KEND
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KFLEV
INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
TYPE (TVAB), INTENT (IN)::YDVAB
REAL (KIND=JPRB), INTENT (INOUT)::PRESH (KPROMA, 0:KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PRESF (KPROMA, KFLEV)
LOGICAL, INTENT (IN), OPTIONAL::LRPP
LOGICAL, INTENT (IN), OPTIONAL::LRTGR
LOGICAL, INTENT (IN), OPTIONAL::LALPHA
LOGICAL, INTENT (IN), OPTIONAL::LDELP
LOGICAL, INTENT (IN), OPTIONAL::LHSET
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PALPH (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PRDELP (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PLNPR (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PDELP (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PRPP (KPROMA, KFLEV)
TYPE(STACK), INTENT (IN) :: YDSTACK
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PRPRE (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PRTGR (KPROMA, KFLEV)
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::IFIRST
LOGICAL::LLXYB
LOGICAL::LTEST
LOGICAL::LLRPP
LOGICAL::LLRTGR
LOGICAL::LLALPHA
LOGICAL::LLDELP
REAL (KIND=JPRB)::ZPRE (KPROMA)
REAL (KIND=JPRB)::ZCOUNT (KPROMA)
REAL (KIND=JPRB)::ZSUM
REAL (KIND=JPRB), TARGET::ZZALPH (KPROMA, KFLEV)
REAL (KIND=JPRB), TARGET::ZZRDELP (KPROMA, KFLEV)
REAL (KIND=JPRB), TARGET::ZZLNPR (KPROMA, KFLEV)
REAL (KIND=JPRB), TARGET::ZZDELP (KPROMA, KFLEV)
REAL (KIND=JPRB), TARGET::ZZRPP (KPROMA, KFLEV)
REAL (KIND=JPRB), TARGET::ZZRPRE (KPROMA, KFLEV)
REAL (KIND=JPRB), TARGET::ZZRTGR (KPROMA, KFLEV)
REAL (KIND=JPRB), POINTER::ZRPP (KPROMA, KFLEV)
REAL (KIND=JPRB), POINTER::ZRPRE (KPROMA, KFLEV)
REAL (KIND=JPRB), POINTER::ZRTGR (KPROMA, KFLEV)
REAL (KIND=JPRB), POINTER::ZALPH (KPROMA, KFLEV)
REAL (KIND=JPRB), POINTER::ZRDELP (KPROMA, KFLEV)
REAL (KIND=JPRB), POINTER::ZLNPR (KPROMA, KFLEV)
REAL (KIND=JPRB), POINTER::ZDELP (KPROMA, KFLEV)

INTEGER (KIND=JPIM) :: JLON

JLON = KIDIA


LLXYB=(PRESENT (PDELP).AND.PRESENT (PLNPR).AND.PRESENT (PRDELP).AND.PRESENT&
& (PALPH).AND.PRESENT (PRTGR).AND.PRESENT (PRPRE).AND.PRESENT (PRPP))

IF (LLXYB) THEN
  LLDELP=.TRUE.

  IF (PRESENT (LDELP))  THEN
      LLDELP=LDELP
  ENDIF

  LLALPHA=.TRUE.

  IF (PRESENT (LALPHA))  THEN
      LLALPHA=LALPHA
  ENDIF

  LLRTGR=.TRUE.

  IF (PRESENT (LRTGR))  THEN
      LLRTGR=LRTGR
  ENDIF

  LLRPP=.TRUE.

  IF (PRESENT (LRPP))  THEN
      LLRPP=LRPP
  ENDIF


  IF (PRESENT (PRESF))  THEN
      LLALPHA=LLALPHA.OR.YDCVER%NDLNPR==1.OR.YDCVER%NDLNPR==2.OR..NOT.YDCVER%LAPRXPK
  ENDIF

  assoc (ZDELP, PDELP)
  assoc (ZLNPR, PLNPR)
  assoc (ZRDELP, PRDELP)
  assoc (ZALPH, PALPH)
  assoc (ZRTGR, PRTGR)
  assoc (ZRPRE, PRPRE)
  assoc (ZRPP, PRPP)
ELSE
  LLDELP=.FALSE.
  LLRTGR=.FALSE.
  LLRPP=.FALSE.
  LLALPHA=PRESENT (PRESF).AND.(YDCVER%NDLNPR==1.OR.YDCVER%NDLNPR==2.OR..NOT.YDCVER%LAPRXPK)

  IF (LLALPHA) THEN
    assoc (ZDELP, ZZDELP)
    assoc (ZLNPR, ZZLNPR)
    assoc (ZRDELP, ZZRDELP)
    assoc (ZALPH, ZZALPH)
    assoc (ZRTGR, ZZRTGR)
    assoc (ZRPRE, ZZRPRE)
    assoc (ZRPP, ZZRPP)
  ENDIF

ENDIF


IF (LLXYB.OR.LLALPHA) THEN
  ZPRE (KST:KEND)=YDVAB%VAH (0)+YDVAB%VBH (0)*PRESH (KST:KEND, KFLEV)
  ZCOUNT (KST:KEND)=0._JPRB

  DO JROF=KST, KEND

    IF (ZPRE (JROF)<=TOPPRES) THEN
      ZCOUNT (JROF)=ZCOUNT (JROF)+1
    ENDIF

  ENDDO

  ZSUM=SUM (ZCOUNT (KST:KEND))

  IF (ZSUM>0._JPRB) THEN
    IFIRST=2
  ELSE
    IFIRST=1
  ENDIF


  IF (YDCVER%NDLNPR==0) THEN

    IF (IFIRST==2) THEN
      ZLNPR (KST:KEND, 1)=LOG (PRESH (KST:KEND, 1)/TOPPRES)

      IF (LLDELP.OR.LLRTGR) THEN

        DO JROF=KST, KEND
          ZDELP (JROF, 1)=PRESH (JROF, 1)-PRESH (JROF, 0)
          ZRDELP (JROF, 1)=1._JPRB/ZDELP (JROF, 1)
        ENDDO

      ENDIF


      IF (LLALPHA)  THEN
          ZALPH (KST:KEND, 1)=YDCVER%RHYDR0
      ENDIF


      IF (LLRTGR) THEN

        DO JROF=KST, KEND
          ZRTGR (JROF, 1)=ZRDELP (JROF, 1)*YDVAB%VDELB (1)
        ENDDO

      ENDIF


      IF (LLRPP) THEN

        DO JROF=KST, KEND
          ZRPRE (JROF, 1)=1._JPRB/PRESH (JROF, 1)
          ZRPP (JROF, 1)=1._JPRB/(PRESH (JROF, 1)*TOPPRES)
        ENDDO

      ENDIF

    ENDIF

    ZPRE (KST:KEND)=1._JPRB/PRESH (KST:KEND, IFIRST-1)

    DO JL=IFIRST, KFLEV
      ZLNPR (KST:KEND, JL)=LOG (PRESH (KST:KEND, JL)*ZPRE (KST:KEND))

      IF (LLDELP.OR.LLALPHA.OR.LLRTGR) THEN

        DO JROF=KST, KEND
          ZDELP (JROF, JL)=PRESH (JROF, JL)-PRESH (JROF, JL-1)
          ZRDELP (JROF, JL)=1._JPRB/ZDELP (JROF, JL)
        ENDDO

      ENDIF


      IF (LLALPHA) THEN

        DO JROF=KST, KEND
          ZALPH (JROF, JL)=1._JPRB-PRESH (JROF, JL-1)*ZRDELP (JROF, JL)*ZLNPR (JROF, JL)
        ENDDO

      ENDIF


      IF (LLRTGR) THEN

        DO JROF=KST, KEND
          ZRTGR (JROF, JL)=ZRDELP (JROF, JL)*(YDVAB%VDELB (JL)+YDVAB&
          &%VC (JL)*ZLNPR (JROF, JL)*ZRDELP (JROF, JL))
        ENDDO

      ENDIF


      IF (LLRPP) THEN

        DO JROF=KST, KEND
          ZRPRE (JROF, JL)=1._JPRB/PRESH (JROF, JL)
          ZRPP (JROF, JL)=ZRPRE (JROF, JL)*ZPRE (JROF)
          ZPRE (JROF)=ZRPRE (JROF, JL)
        ENDDO

      ELSE
        ZPRE (KST:KEND)=1._JPRB/PRESH (KST:KEND, JL)
      ENDIF

    ENDDO

  ELSEIF (YDCVER%NDLNPR==1.OR.YDCVER%NDLNPR==2) THEN
    LTEST=LLDELP.OR.LLALPHA.OR.LLRTGR

    DO JL=IFIRST, KFLEV

      IF (LTEST) THEN

        DO JROF=KST, KEND
          ZDELP (JROF, JL)=PRESH (JROF, JL)-PRESH (JROF, JL-1)
          ZRDELP (JROF, JL)=1._JPRB/ZDELP (JROF, JL)
          ZRPP (JROF, JL)=1._JPRB/(PRESH (JROF, JL)*PRESH (JROF, JL-1))
          ZLNPR (JROF, JL)=ZDELP (JROF, JL)*SQRT (ZRPP (JROF, JL))
        ENDDO

      ELSE

        DO JROF=KST, KEND
          ZLNPR (JROF, JL)=(PRESH (JROF, JL)-PRESH (JROF, JL-1))/SQRT (PRESH (JROF, JL)*PRESH (JROF, JL-1))
        ENDDO

      ENDIF


      IF (LLALPHA) THEN

        DO JROF=KST, KEND
          ZALPH (JROF, JL)=1._JPRB-PRESH (JROF, JL-1)*ZRDELP (JROF, JL)*ZLNPR (JROF, JL)
        ENDDO

      ENDIF


      IF (LLRTGR) THEN

        DO JROF=KST, KEND
          ZRTGR (JROF, JL)=ZRDELP (JROF, JL)*(YDVAB%VDELB (JL)+YDVAB&
          &%VC (JL)*ZLNPR (JROF, JL)*ZRDELP (JROF, JL))
        ENDDO

      ENDIF


      IF (LLRPP)  THEN
          ZRPRE (KST:KEND, JL)=1._JPRB/PRESH (KST:KEND, JL)
      ENDIF

    ENDDO


    IF (IFIRST==2) THEN

      DO JROF=KST, KEND
        ZDELP (JROF, 1)=PRESH (JROF, 1)
        ZRDELP (JROF, 1)=1._JPRB/ZDELP (JROF, 1)
      ENDDO


      IF (YDCVER%NDLNPR==1) THEN
        ZLNPR (KST:KEND, 1)=2._JPRB+YDCST%RCVD/YDCST%RD
      ELSE

        DO JROF=KST, KEND
          ZLNPR (JROF, 1)=1._JPRB+ZLNPR (JROF, 2)*(ZDELP (JROF, 1)/ZDELP&
          & (JROF, 2))*SQRT (PRESH (JROF, 2)/PRESH (JROF, 1))
        ENDDO

      ENDIF


      IF (LLALPHA)  THEN
          ZALPH (KST:KEND, 1)=1._JPRB
      ENDIF


      IF (LLRTGR) THEN

        DO JROF=KST, KEND
          ZRTGR (JROF, 1)=ZRDELP (JROF, 1)*YDVAB%VDELB (1)
        ENDDO

      ENDIF


      IF (LLRPP) THEN

        DO JROF=KST, KEND
          ZRPRE (JROF, 1)=1._JPRB/PRESH (JROF, 1)
          ZRPP (JROF, 1)=(ZLNPR (JROF, 1)*ZRDELP (JROF, 1))**2
        ENDDO

      ENDIF

    ENDIF

  ENDIF

ENDIF


IF (PRESENT (PRESF)) THEN

  IF (YDCVER%NDLNPR==0) THEN

    IF (YDCVER%LAPRXPK) THEN

      DO JL=1, KFLEV
        PRESF (KST:KEND, JL)=(PRESH (KST:KEND, JL-1)+PRESH (KST:KEND, JL))*0.5_JPRB
      ENDDO

    ELSE

      DO JL=1, KFLEV

        DO JROF=KST, KEND
          PRESF (JROF, JL)=EXP (-ZALPH (JROF, JL))*PRESH (JROF, JL)
        ENDDO

      ENDDO

    ENDIF

  ELSEIF (YDCVER%NDLNPR==1.OR.YDCVER%NDLNPR==2) THEN

    DO JL=IFIRST, KFLEV

      DO JROF=KST, KEND
        PRESF (JROF, JL)=(1._JPRB-ZALPH (JROF, JL))*PRESH (JROF, JL)
      ENDDO

    ENDDO


    IF (IFIRST==2) THEN

      DO JROF=KST, KEND
        PRESF (JROF, 1)=PRESH (JROF, 1)/ZLNPR (JROF, 1)
      ENDDO

    ENDIF

  ENDIF

ENDIF



ENDSUBROUTINE
