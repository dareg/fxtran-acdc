SUBROUTINE GPHPRE_EXPL_VERTFE1_OPENACC (YDCVER, TOPPRES, YDCST, KPROMA&
&, KFLEV, KST, KEND, YDVAB, PRESH, PRESF, LHSET, LDELP, LALPHA, LRTGR&
&, LRPP, PDELP, PLNPR, PRDELP, PALPH, PRTGR, PRPRE, PRPP, YDSTACK)
!$ACC ROUTINE (GPHPRE_EXPL_VERTFE1_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOMVERT,ONLY:TVAB
USE YOMCVER,ONLY:TCVER
#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (TCVER), INTENT (IN)::YDCVER
REAL (KIND=JPRB), INTENT (IN)::TOPPRES
TYPE (TCST), INTENT (IN)::YDCST
INTEGER (KIND=JPIM), INTENT (IN)::KEND
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KFLEV
INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
TYPE (TVAB), INTENT (IN)::YDVAB
REAL (KIND=JPRB), INTENT (INOUT)::PRESH (KPROMA, 0:KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PRESF (KPROMA, KFLEV)
LOGICAL, INTENT (IN), OPTIONAL::LRPP
LOGICAL, INTENT (IN), OPTIONAL::LRTGR
LOGICAL, INTENT (IN), OPTIONAL::LALPHA
LOGICAL, INTENT (IN), OPTIONAL::LDELP
LOGICAL, INTENT (IN), OPTIONAL::LHSET
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PALPH (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PRDELP (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PLNPR (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PDELP (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PRPP (KPROMA, KFLEV)
TYPE(STACK), INTENT (IN) :: YDSTACK
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PRPRE (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PRTGR (KPROMA, KFLEV)
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::IFIRST
LOGICAL::LLXYB
LOGICAL::LTEST
LOGICAL::LLRPP
LOGICAL::LLRTGR
LOGICAL::LLALPHA
LOGICAL::LLDELP
REAL (KIND=JPRB)::ZPRE (KPROMA)
REAL (KIND=JPRB), TARGET::ZZPRESF (KPROMA, KFLEV)
REAL (KIND=JPRB), TARGET::ZZALPH (KPROMA, KFLEV)
REAL (KIND=JPRB), TARGET::ZZRDELP (KPROMA, KFLEV)
REAL (KIND=JPRB), TARGET::ZZLNPR (KPROMA, KFLEV)
REAL (KIND=JPRB), TARGET::ZZDELP (KPROMA, KFLEV)
REAL (KIND=JPRB), TARGET::ZZRPP (KPROMA, KFLEV)
REAL (KIND=JPRB), TARGET::ZZRPRE (KPROMA, KFLEV)
REAL (KIND=JPRB), TARGET::ZZRTGR (KPROMA, KFLEV)
REAL (KIND=JPRB), POINTER::ZPRESF (KPROMA, KFLEV)
REAL (KIND=JPRB), POINTER::ZRPP (KPROMA, KFLEV)
REAL (KIND=JPRB), POINTER::ZRPRE (KPROMA, KFLEV)
REAL (KIND=JPRB), POINTER::ZRTGR (KPROMA, KFLEV)
REAL (KIND=JPRB), POINTER::ZALPH (KPROMA, KFLEV)
REAL (KIND=JPRB), POINTER::ZRDELP (KPROMA, KFLEV)
REAL (KIND=JPRB), POINTER::ZLNPR (KPROMA, KFLEV)
REAL (KIND=JPRB), POINTER::ZDELP (KPROMA, KFLEV)

INTEGER (KIND=JPIM) :: JLON

JLON = KIDIA


LLXYB=(PRESENT (PDELP).AND.PRESENT (PLNPR).AND.PRESENT (PRDELP).AND.PRESENT&
& (PALPH).AND.PRESENT (PRTGR).AND.PRESENT (PRPRE).AND.PRESENT (PRPP))

IF (LLXYB) THEN
  LLDELP=.TRUE.

  IF (PRESENT (LDELP))  THEN
      LLDELP=LDELP
  ENDIF

  LLALPHA=.TRUE.

  IF (PRESENT (LALPHA))  THEN
      LLALPHA=LALPHA
  ENDIF

  LLRTGR=.TRUE.

  IF (PRESENT (LRTGR))  THEN
      LLRTGR=LRTGR
  ENDIF

  assoc (ZDELP, PDELP)
  assoc (ZLNPR, PLNPR)
  assoc (ZRDELP, PRDELP)
  assoc (ZALPH, PALPH)
  assoc (ZRTGR, PRTGR)
  assoc (ZRPRE, PRPRE)
  assoc (ZRPP, PRPP)

  IF (PRESENT (PRESF)) THEN
    assoc (ZPRESF, PRESF)
  ELSE
    assoc (ZPRESF, ZZPRESF)
  ENDIF

ELSE
  nullptr (ZPRESF)
ENDIF


IF (LLXYB) THEN

  DO JL=1, KFLEV

    DO JROF=KST, KEND
      ZDELP (JROF, JL)=YDVAB%VDELA (JL)+YDVAB%VDELB (JL)*PRESH (JROF, KFLEV)
      ZPRESF (JROF, JL)=YDVAB%VAF (JL)+YDVAB%VBF (JL)*PRESH (JROF, KFLEV)
      ZPRE (JROF)=1._JPRB/ZPRESF (JROF, JL)
      ZLNPR (JROF, JL)=ZDELP (JROF, JL)*ZPRE (JROF)
    ENDDO


    IF (LLDELP) THEN

      DO JROF=KST, KEND
        ZRDELP (JROF, JL)=1._JPRB/ZDELP (JROF, JL)
      ENDDO

    ENDIF


    IF (LLALPHA) THEN

      DO JROF=KST, KEND
        ZALPH (JROF, JL)=(PRESH (JROF, JL)-ZPRESF (JROF, JL))*ZPRE (JROF)
      ENDDO

    ENDIF


    IF (LLRTGR) THEN

      DO JROF=KST, KEND
        ZRTGR (JROF, JL)=YDVAB%VBF (JL)*ZPRE (JROF)
      ENDDO

    ENDIF

  ENDDO

ELSEIF (PRESENT (PRESF)) THEN

  DO JL=1, KFLEV

    DO JROF=KST, KEND
      PRESF (JROF, JL)=YDVAB%VAF (JL)+YDVAB%VBF (JL)*PRESH (JROF, KFLEV)
    ENDDO

  ENDDO

ENDIF



ENDSUBROUTINE
