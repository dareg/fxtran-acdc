SUBROUTINE GPHPRE_EXPL_VERTFE1_OPENACC (YDCVER, TOPPRES, YDCST, KPROMA&
&, KFLEV, KST, KEND, YDVAB, PRESH, PRESF, LHSET, LDELP, LALPHA, LRTGR&
&, LRPP, PDELP, PLNPR, PRDELP, PALPH, PRTGR, PRPRE, PRPP, YDSTACK)
!$ACC ROUTINE (GPHPRE_EXPL_VERTFE1_OPENACC) SEQ
USE PARKIND1,ONLY:JPIM, JPRB

USE YOMCST,ONLY:TCST
USE YOMVERT,ONLY:TVAB
USE YOMCVER,ONLY:TCVER
#include "stack.h"
USE STACK_MOD
USE ABOR1_ACC_MOD

IMPLICIT NONE

TYPE (TCVER), INTENT (IN)::YDCVER
REAL (KIND=JPRB), INTENT (IN)::TOPPRES
TYPE (TCST), INTENT (IN)::YDCST
INTEGER (KIND=JPIM), INTENT (IN)::KEND
INTEGER (KIND=JPIM), INTENT (IN)::KST
INTEGER (KIND=JPIM), INTENT (IN)::KFLEV
INTEGER (KIND=JPIM), INTENT (IN)::KPROMA
TYPE (TVAB), INTENT (IN)::YDVAB
REAL (KIND=JPRB), INTENT (INOUT)::PRESH (KPROMA, 0:KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PRESF (KPROMA, KFLEV)
LOGICAL, INTENT (IN), OPTIONAL::LRPP
LOGICAL, INTENT (IN), OPTIONAL::LRTGR
LOGICAL, INTENT (IN), OPTIONAL::LALPHA
LOGICAL, INTENT (IN), OPTIONAL::LDELP
LOGICAL, INTENT (IN), OPTIONAL::LHSET
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PALPH (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PRDELP (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PLNPR (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PDELP (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PRPP (KPROMA, KFLEV)
TYPE(STACK), INTENT (IN) :: YDSTACK
TYPE(STACK) :: YLSTACK
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PRPRE (KPROMA, KFLEV)
REAL (KIND=JPRB), INTENT (OUT), OPTIONAL, TARGET::PRTGR (KPROMA, KFLEV)
INTEGER (KIND=JPIM)::JROF
INTEGER (KIND=JPIM)::JL
INTEGER (KIND=JPIM)::IFIRST
LOGICAL::LLXYB
LOGICAL::LTEST
LOGICAL::LLRPP
LOGICAL::LLRTGR
LOGICAL::LLALPHA
LOGICAL::LLDELP
REAL (KIND=JPRB)::ZPRE 
temp (REAL (KIND=JPRB), ZZPRESF, (KPROMA, KFLEV))
temp (REAL (KIND=JPRB), ZZALPH, (KPROMA, KFLEV))
temp (REAL (KIND=JPRB), ZZRDELP, (KPROMA, KFLEV))
temp (REAL (KIND=JPRB), ZZLNPR, (KPROMA, KFLEV))
temp (REAL (KIND=JPRB), ZZDELP, (KPROMA, KFLEV))
temp (REAL (KIND=JPRB), ZZRPP, (KPROMA, KFLEV))
temp (REAL (KIND=JPRB), ZZRPRE, (KPROMA, KFLEV))
temp (REAL (KIND=JPRB), ZZRTGR, (KPROMA, KFLEV))
temp (REAL (KIND=JPRB), ZPRESF, (KPROMA, KFLEV))
temp (REAL (KIND=JPRB), ZRPP, (KPROMA, KFLEV))
temp (REAL (KIND=JPRB), ZRPRE, (KPROMA, KFLEV))
temp (REAL (KIND=JPRB), ZRTGR, (KPROMA, KFLEV))
temp (REAL (KIND=JPRB), ZALPH, (KPROMA, KFLEV))
temp (REAL (KIND=JPRB), ZRDELP, (KPROMA, KFLEV))
temp (REAL (KIND=JPRB), ZLNPR, (KPROMA, KFLEV))
temp (REAL (KIND=JPRB), ZDELP, (KPROMA, KFLEV))


YLSTACK = YDSTACK



IF (KIND (ZZPRESF) == 8) THEN
    alloc8 (ZZPRESF)
ELSEIF (KIND (ZZPRESF) == 4) THEN
    alloc4 (ZZPRESF)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZALPH) == 8) THEN
    alloc8 (ZZALPH)
ELSEIF (KIND (ZZALPH) == 4) THEN
    alloc4 (ZZALPH)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZRDELP) == 8) THEN
    alloc8 (ZZRDELP)
ELSEIF (KIND (ZZRDELP) == 4) THEN
    alloc4 (ZZRDELP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZLNPR) == 8) THEN
    alloc8 (ZZLNPR)
ELSEIF (KIND (ZZLNPR) == 4) THEN
    alloc4 (ZZLNPR)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZDELP) == 8) THEN
    alloc8 (ZZDELP)
ELSEIF (KIND (ZZDELP) == 4) THEN
    alloc4 (ZZDELP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZRPP) == 8) THEN
    alloc8 (ZZRPP)
ELSEIF (KIND (ZZRPP) == 4) THEN
    alloc4 (ZZRPP)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZRPRE) == 8) THEN
    alloc8 (ZZRPRE)
ELSEIF (KIND (ZZRPRE) == 4) THEN
    alloc4 (ZZRPRE)
ELSE
    STOP 1
ENDIF


IF (KIND (ZZRTGR) == 8) THEN
    alloc8 (ZZRTGR)
ELSEIF (KIND (ZZRTGR) == 4) THEN
    alloc4 (ZZRTGR)
ELSE
    STOP 1
ENDIF


JROF = KST


LLXYB=(PRESENT (PDELP).AND.PRESENT (PLNPR).AND.PRESENT (PRDELP).AND.PRESENT&
& (PALPH).AND.PRESENT (PRTGR).AND.PRESENT (PRPRE).AND.PRESENT (PRPP))

IF (LLXYB) THEN
  LLDELP=.TRUE.

  IF (PRESENT (LDELP))  THEN
    LLDELP=LDELP
  ENDIF

  LLALPHA=.TRUE.

  IF (PRESENT (LALPHA))  THEN
    LLALPHA=LALPHA
  ENDIF

  LLRTGR=.TRUE.

  IF (PRESENT (LRTGR))  THEN
    LLRTGR=LRTGR
  ENDIF

  assoc (ZDELP, PDELP)
  assoc (ZLNPR, PLNPR)
  assoc (ZRDELP, PRDELP)
  assoc (ZALPH, PALPH)
  assoc (ZRTGR, PRTGR)
  assoc (ZRPRE, PRPRE)
  assoc (ZRPP, PRPP)

  IF (PRESENT (PRESF)) THEN
    assoc (ZPRESF, PRESF)
  ELSE
    assoc (ZPRESF, ZZPRESF)
  ENDIF

ELSE
  nullptr (ZPRESF)
ENDIF


IF (LLXYB) THEN

  DO JL=1, KFLEV
    
    ZDELP (JROF, JL)=YDVAB%VDELA (JL)+YDVAB%VDELB (JL)*PRESH (JROF, KFLEV)
    ZPRESF (JROF, JL)=YDVAB%VAF (JL)+YDVAB%VBF (JL)*PRESH (JROF, KFLEV)
    ZPRE =1._JPRB/ZPRESF (JROF, JL)
    ZLNPR (JROF, JL)=ZDELP (JROF, JL)*ZPRE 

    

    IF (LLDELP) THEN
      
      ZRDELP (JROF, JL)=1._JPRB/ZDELP (JROF, JL)
    
    ENDIF


    IF (LLALPHA) THEN
      
      ZALPH (JROF, JL)=(PRESH (JROF, JL)-ZPRESF (JROF, JL))*ZPRE 
    
    ENDIF


    IF (LLRTGR) THEN
      
      ZRTGR (JROF, JL)=YDVAB%VBF (JL)*ZPRE 
    
    ENDIF

  ENDDO

ELSEIF (PRESENT (PRESF)) THEN

  DO JL=1, KFLEV
    
    PRESF (JROF, JL)=YDVAB%VAF (JL)+YDVAB%VBF (JL)*PRESH (JROF, KFLEV)
  
  ENDDO

ENDIF


ENDSUBROUTINE
