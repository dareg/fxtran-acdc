SUBROUTINE ARP_SHALLOW_MF_FINISH (YDCPG_OPTS, PVMD, PTSPHY, YDCST, YDCPG_BNDS, PDPSG, PCP, PFLXZTHVMF&
&, PHRODREF, PSTRTV, PDTHLDT_MF, PRC_UP, KNLAB, PRI_UP, PDVDT_MF, PDIFTS, PRODTH_CVPP, PTHETA,&
& PT, PQLI, PEXNER, PDUDT_MF, PRT_UP, PQDM, PDRTDT_MF, PMF_UP, PEMF, PDIFTQ, PSTRTU)
USE YOMCST,ONLY:TCST
USE PARKIND1,ONLY:JPIM, JPRB
USE CPG_OPTS_TYPE_MOD,ONLY:CPG_BNDS_TYPE, CPG_OPTS_TYPE
USE YOMHOOK,ONLY:LHOOK, JPHOOK, DR_HOOK

IMPLICIT NONE

TYPE (CPG_OPTS_TYPE), INTENT (IN)::YDCPG_OPTS
REAL (KIND=JPRB), INTENT (INOUT)::PVMD
REAL (KIND=JPRB), INTENT (IN)::PTSPHY
TYPE (TCST), INTENT (IN)::YDCST
TYPE (CPG_BNDS_TYPE), INTENT (IN)::YDCPG_BNDS
REAL (KIND=JPRB), INTENT (INOUT)::PDPSG (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PCP (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PFLXZTHVMF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PHRODREF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PSTRTV (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PDTHLDT_MF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PRC_UP (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
INTEGER (KIND=JPIM), INTENT (OUT)::KNLAB (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PRI_UP (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PDVDT_MF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PDIFTS (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PRODTH_CVPP (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PTHETA (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (IN)::PT (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PQLI (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PEXNER (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PDUDT_MF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PRT_UP (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PQDM (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PDRTDT_MF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (OUT)::PMF_UP (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PEMF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PDIFTQ (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB), INTENT (INOUT)::PSTRTU (YDCPG_OPTS%KLON, 0:YDCPG_OPTS%KFLEVG)
INTEGER (KIND=JPIM)::JLON
REAL (KIND=JPRB)::ZTDCP
INTEGER (KIND=JPIM)::JLEV
REAL (KIND=JPRB)::ZFQ_MF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZFU_MF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZFV_MF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPRB)::ZFH_MF (YDCPG_OPTS%KLON, YDCPG_OPTS%KFLEVG)
REAL (KIND=JPHOOK)::ZHOOK_HANDLE
IF (LHOOK) CALL DR_HOOK ('ARP_SHALLOW_MF_FINISH', 0, ZHOOK_HANDLE)
ZFQ_MF (:,:)=0.
ZFH_MF (:,:)=0.
ZFU_MF (:,:)=0.
ZFV_MF (:,:)=0.

DO JLEV=2, YDCPG_OPTS%KFLEVG

  DO JLON=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
    ZFQ_MF (JLON, JLEV)=ZFQ_MF (JLON, JLEV-1)-PDPSG (JLON&
    &, JLEV)*PDRTDT_MF (JLON, JLEV)*PQDM (JLON, JLEV)
    ZTDCP=PVMD*PDRTDT_MF (JLON, JLEV)
    ZFH_MF (JLON, JLEV)=ZFH_MF (JLON, JLEV-1)-PDPSG (JLON, JLEV)*(PDTHLDT_MF (JLON, JLEV&
    &)*PEXNER (JLON, JLEV)*(PCP (JLON, JLEV)+PTSPHY*ZTDCP)+PT (JLON, JLEV)*ZTDCP)
    ZFU_MF (JLON, JLEV)=ZFU_MF (JLON, JLEV-1)-PDPSG (JLON, JLEV)*PDUDT_MF (JLON, JLEV)
    ZFV_MF (JLON, JLEV)=ZFV_MF (JLON, JLEV-1)-PDPSG (JLON, JLEV)*PDVDT_MF (JLON, JLEV)
  ENDDO

ENDDO

PRODTH_CVPP (:,:)=0.

DO JLEV=1, YDCPG_OPTS%KFLEVG

  DO JLON=YDCPG_BNDS%KIDIA, YDCPG_BNDS%KFDIA
    PDIFTQ (JLON, JLEV)=PDIFTQ (JLON, JLEV)+ZFQ_MF (JLON, JLEV)
    PDIFTS (JLON, JLEV)=PDIFTS (JLON, JLEV)+ZFH_MF (JLON, JLEV)
    PSTRTU (JLON, JLEV)=PSTRTU (JLON, JLEV)+ZFU_MF (JLON, JLEV)
    PSTRTV (JLON, JLEV)=PSTRTV (JLON, JLEV)+ZFV_MF (JLON, JLEV)
    PRODTH_CVPP (JLON, JLEV)=YDCST%RG/PTHETA (JLON, JLEV)*PFLXZTHVMF (JLON, JLEV)
    PQLI (JLON, JLEV)=(PRC_UP (JLON, JLEV)+PRI_UP (JLON, JLEV))/(1.+PRT_UP (JLON, JLEV))
    KNLAB (JLON, JLEV)=INT (MAX (0., SIGN (1., PQLI (JLON, JLEV)-1.E-8)))
    PMF_UP (JLON, JLEV)=-PEMF (JLON, JLEV)/PHRODREF (JLON, JLEV)
  ENDDO

ENDDO

IF (LHOOK) CALL DR_HOOK ('ARP_SHALLOW_MF_FINISH', 1, ZHOOK_HANDLE)
ENDSUBROUTINE
