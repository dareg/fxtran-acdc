#!/usr/bin/env perl

use warnings;

use Data::Dumper;
use FileHandle;

use strict;

my $bin = shift;

my @s;

for my $line (split (m/\n/o, `objdump -h $bin`))
  {
    if ($line =~ m/^\s*\d+\s*(\S+)/o)
      {
        push @s, $1;
      }
  }

for my $s (@s)
  {
    if ($s =~ m/^\.fxtran\.acdc\.parallelmethod\.(\w+)$/o)
      {
        my $method = $1;

        my $f = "fxtran.acdc.parallelmethod.$method.txt";

        my @cmd = ('objcopy', '--dump-section',  "$s=$f", $bin);
        system (@cmd)
          and die ("Command `@cmd' failed\n");

        my $data = do { my $fh = 'FileHandle'->new ("<$f"); local $/ = undef; <$fh> };
        $data =~ s/\0//goms;

        'FileHandle'->new (">$f")->print ($data);
      }
  }



