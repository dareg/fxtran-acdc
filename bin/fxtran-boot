#!/usr/bin/perl -w

#
# Copyright 2025 Meteo-France
# All rights reserved
# philippe.marguinaud@meteo.fr
#

use Getopt::Long;
use FileHandle;
use Data::Dumper;
use File::Temp;
use File::Basename;
use File::Spec;
use File::Copy;
use File::Path;
use Cwd;

use FindBin qw ($Bin);
use lib "$Bin/../lib";

use strict;

use Fxtran::Common;
use Fxtran::Bt;
use Fxtran::F90Compiler;
use Fxtran::Util;
use Fxtran::PATH;

my %opts = qw (prefix .);
my @opts_s = qw (prefix F90 CC CXX);
my @opts_f = qw (help);

&GetOptions
(
  (map { ($_, \$opts{$_}) } @opts_f),
  (map { ("$_=s", \$opts{$_}) } @opts_s),
);

if ($opts{help})
  {
    print
     "Usage: " . &basename ($0) . "\n" .
      join ('', map { "  --$_\n" } @opts_f) .
      join ('', map { "  --$_=...\n" } @opts_f) .
     "\n";
    exit (0);
  }

for my $comp (qw (F90 CC CXX))
  {
    next unless ($opts{$comp});
    $opts{$comp} = [split (m/\s+/o, $opts{$comp})];
  }

$opts{prefix} = 'File::Spec'->rel2abs ($opts{prefix});

my ($f90compiler, @f90flags) = $opts{F90} ? @{ $opts{F90} } : @ARGV;
my ($ccompiler,   @cflags)   = @{ $opts{CC} || [] };
my ($cxxcompiler, @cxxflags) = @{ $opts{CXX} || [] };

@f90flags = grep { $_ ne '-c' } @f90flags;
@cflags   = grep { $_ ne '-c' } @cflags;
@cxxflags = grep { $_ ne '-c' } @cxxflags;

my @F90 = <$Bin/../src/*.F90>;
my @C   = <$Bin/../src/*.c>;
my @CXX = <$Bin/../src/*.cc>;

my $dir = 'File::Temp'->newdir ();

chdir ($dir);

&Fxtran::F90Compiler::run 
(
  f90compiler => $f90compiler, 
  f90flags    => \@f90flags, 
  F90         => \@F90,

  ccompiler   => $ccompiler,
  cflags      => \@cflags,
  C           => \@C,

  cxxcompiler => $cxxcompiler,
  cxxflags    => \@cxxflags,
  CXX         => \@CXX,

  lib         => "libACDC.a",
);

for (qw (include lib))
  {
    &mkpath ("$opts{prefix}/$_") 
      unless (-d "$opts{prefix}/$_");
  }

&move ('libACDC.a', "$opts{prefix}/lib/libACDC.a")
  or die ("Cannot install libACDC.a");

for (<*.mod>, <*.smod>, <$Bin/../src/*.h>)
  {
    &copy ($_, "$opts{prefix}/include/" . &basename ($_))
      or die ("Cannot install $_");
  }


