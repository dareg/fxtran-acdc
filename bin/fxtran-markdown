#!/usr/bin/env perl

use warnings;

use Pod::Markdown;
use FileHandle;
use File::Path;
use Data::Dumper;
use File::Basename;
use File::Find;
use File::Basename;
use File::Spec;
use FindBin qw ($Bin);

use strict;

sub slurp
{
  my $f = shift;
  return do { local $/ = undef; my $fh = 'FileHandle'->new ("<$f"); <$fh> };
}

sub desc
{
  my $file = shift;

  my $pod = '';

  my $fhin = 'FileHandle'->new ("<$file");
  
  my $on = 0;
  
  while (my $line = <$fhin>)
    {
      if ($line =~ m/^=head1 DESCRIPTION/o)
        {
          $on = 1;
          $line = "=pod\n";
        }
      elsif ($on && ($line =~ m/^=head1/o))
       {
          $on = 0;
       }
  
      $pod .= $line if ($on);
    }
  
  $pod .= "\n=cut\n";

  return $pod;
}

my $fh = 'FileHandle'->new ('>README.md');

$fh->print (<< "EOF");
# Adaptation des Codes Ã  Divers Calculateurs

![](./images/ACDC.png)

EOF

my @perl;

for my $bin (<$Bin/fxtran-*>)
  {
    push @perl, &basename ($bin) 
      if (&slurp ($bin) =~ m/\n=head1/goms);
  }

&find ({wanted => sub
{
  my $f = $File::Find::name;

  return unless ($f =~ m/\.pm$/o);

  return unless (&slurp ($f) =~ m/\n=head1/goms);

  my $pm = 'File::Spec'->abs2rel ($f, "$Bin/../lib");
 
  for ($pm)
    {
      s/\.pm$//o;
      s,/,::,go;
    }
 
  push @perl, $pm;

}, no_chdir => 1}, "$Bin/../lib");


for my $perl (@perl)
  {
    my $f;

    if (-f "bin/$perl")
      {
        $f = "bin/$perl";
      }
    else
      {
        ($f = $perl) =~ s,::,/,go;
        $f = "lib/$f.pm";
        die unless (-f $f);
      }

    my ($pp, $markdown);

    if ($f =~ m/^bin/o)
      {
        my $md = $perl;
        $md = "doc/$md.md";

        $fh->print (<< "EOF");

# [$perl ...](./$md)

EOF

       my $pod = $f =~ m/^bin/o ? &desc ($f) : '';
       $pp = 'Pod::Markdown'->new ();
       $pp->output_string (\$markdown);
       $pp->parse_string_document ($pod);
       $fh->print ($markdown);
     }

#   print &Dumper ([$pod, $markdown]);

    $markdown = '';

    $pp = 'Pod::Markdown'->new 
    ( 
      perldoc_url_prefix => '',
    );
    $pp->output_string (\$markdown);
    $pp->parse_file ($f);

    $markdown =~ s{\]\((\S+)\)}
    { 
      my $link = $1;
      if (($link =~ s/^url://o) || ($link =~ m/^https:/o))
        {
        }
      else
        {
          $link .= ".md";
        }
      "]($link)" 
    }xegoms;

#   print &Dumper (\$markdown);

    'FileHandle'->new (">doc/$perl.md")->print ($markdown);

  }

$fh->close ();

